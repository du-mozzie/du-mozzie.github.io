import{_ as n}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as s,c as a,h as p}from"./app-C1J6dmXo.js";const e={},o=p(`<p>MySQL事务是为确保数据一致性而将多条SQL操作封装成的逻辑工作单元，遵循ACID原则。</p><h2 id="什么是事务" tabindex="-1"><a class="header-anchor" href="#什么是事务"><span>什么是事务？</span></a></h2><p>在人员管理系统中，你删除一个人员，你即需要删除人员的基本资料，也要删除和该人员相关的信息，如信箱，文章等等，这样，这些数据库操作语句就构成一个事务！</p><h2 id="事务是必须满足4个条件-acid" tabindex="-1"><a class="header-anchor" href="#事务是必须满足4个条件-acid"><span>事务是必须满足4个条件（ACID）</span></a></h2><ul><li>**事务的原子性（ Atomicity）：**一组事务，要么成功；要么撤回。</li><li>**一致性 （Consistency）：**事务执行后，数据库状态与其他业务规则保持一致。如转账业务，无论事务执行成功否，参与转账的两个账号余额之和应该是不变的。</li><li>**隔离性（Isolation）：**事务独立运行。一个事务处理后的结果，影响了其他事务，那么其他事务会撤回。事务的100%隔离，需要牺牲速度。</li><li>**持久性（Durability）：**软、硬件崩溃后，InnoDB数据表驱动会利用日志文件重构修改。可靠性和高速度不可兼得， innodb_flush_log_at_trx_commit 选项 决定什么时候吧事务保存到日志里。</li></ul><blockquote><p>InnoDB存储引擎在MySQL数据库中执行一次update操作的完整过程，以及涉及到的关键组件和步骤。</p></blockquote><ol><li><strong>Buffer Pool读取</strong>：InnoDB首先在Buffer Pool中查找需要更新的记录。如果记录不在内存中，它会从物理磁盘读取到Buffer Pool。</li><li><strong>UndoLog记录</strong>：在实际修改数据之前，InnoDB会记录Undo Log，这是一种用于保证事务原子性和一致性的机制。Undo Log最初写入内存，然后由后台线程定期刷新到磁盘。</li><li><strong>Buffer Pool更新</strong>：执行update操作时，InnoDB会在Buffer Pool中更新数据，并将修改后的数据页标记为“脏页”，表示需要写入磁盘。</li><li><strong>RedoLog Buffer记录</strong>：同时，InnoDB会将修改操作记录到Redo Log Buffer中。</li><li><strong>事务提交</strong>：所有修改操作完成后，事务被提交。此时，Redo Log会被写入磁盘，确保事务的持久性。</li><li><strong>磁盘写入</strong>：提交事务后，InnoDB会将Buffer Pool中的脏页异步写入磁盘，这个过程由后台线程控制，可能会有延迟。</li><li><strong>Binlog记录</strong>：在事务提交过程中，InnoDB会将事务信息记录到Binlog中，这是MySQL实现主从复制的关键机制。Binlog记录了事务的详细信息，如时间、数据库名、表名、事务ID和SQL语句等。</li></ol><p>在binlog和redolog的写入过程中，分成了2阶段的，通过2阶段提交的方式来保证一致性的。</p><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/image-20240918211556431.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="mysql中的事务" tabindex="-1"><a class="header-anchor" href="#mysql中的事务"><span>MySQL中的事务</span></a></h2><p>在默认情况下，MySQL每执行一条SQL语句，都是一个单独的事务。如果需要在一个事务中包含多条SQL语句，那么需要开启事务和结束事务。</p><ul><li><p>开启事务：start transaction</p></li><li><p>结束事务：commit或rollback</p><p>在执行SQL语句之前，先执行start transaction，这就开启了一个事务（事务的起点），然后可以去执行多条SQL语句，最后要结束事务，commit表示提交，即事务中的多条SQL语句所作出的影响会持久到数据库中，或者rollback，表示回滚到事务的起点，之前做的所有操作都被撤销了。</p></li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> NAME <span class="token operator">|</span> balance <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> zs   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> ls   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> ww   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">UPDATE</span> account <span class="token keyword">SET</span> balance<span class="token operator">=</span><span class="token number">900</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">&#39;zs&#39;</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> NAME <span class="token operator">|</span> balance <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> zs   <span class="token operator">|</span>  <span class="token number">900.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> ls   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> ww   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">UPDATE</span> account <span class="token keyword">SET</span> balance<span class="token operator">=</span><span class="token number">1100</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">&#39;ls&#39;</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> NAME <span class="token operator">|</span> balance <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> zs   <span class="token operator">|</span>  <span class="token number">900.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> ls   <span class="token operator">|</span> <span class="token number">1100.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> ww   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">ROLLBACK</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> NAME <span class="token operator">|</span> balance <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> zs   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> ls   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> ww   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">START</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">UPDATE</span> account <span class="token keyword">SET</span> balance<span class="token operator">=</span>balance<span class="token operator">-</span><span class="token number">100</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">&#39;zs&#39;</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> NAME <span class="token operator">|</span> balance <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> zs   <span class="token operator">|</span>  <span class="token number">900.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> ls   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> ww   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">UPDATE</span> account <span class="token keyword">SET</span> balance<span class="token operator">=</span>balance<span class="token operator">+</span><span class="token number">100</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">&#39;ls&#39;</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> NAME <span class="token operator">|</span> balance <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> zs   <span class="token operator">|</span>  <span class="token number">900.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> ls   <span class="token operator">|</span> <span class="token number">1100.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> ww   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> account<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> NAME <span class="token operator">|</span> balance <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> zs   <span class="token operator">|</span>  <span class="token number">900.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> ls   <span class="token operator">|</span> <span class="token number">1100.00</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> ww   <span class="token operator">|</span> <span class="token number">1000.00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+---------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>事务隔离级别相关命令</p><ol><li><p>查看当前会话隔离级别</p><p>select @@tx_isolation;</p><p>在MySQL 8.0中：SELECT @@transaction_isolation;</p></li><li><p>查看系统当前隔离级别</p><p>select @@global.tx_isolation;</p></li><li><p>设置当前会话隔离级别</p><p>set session transaction isolatin level repeatable read;</p></li><li><p>设置系统当前隔离级别</p><p>set global transaction isolation level repeatable read;</p></li><li><p>命令行，开始事务时</p><p>set autocommit=off 或者 start transaction</p></li></ol><h2 id="jdbc事务" tabindex="-1"><a class="header-anchor" href="#jdbc事务"><span>JDBC事务</span></a></h2><p>在JDBC中处理事务，都是通过Connection完成的。</p><p><strong>同一事务中所有的操作，都在使用同一个Connection对象。</strong></p><p>①JDBC中的事务</p><p>Connection的三个方法与事务有关：</p><ul><li>setAutoCommit（boolean）:设置是否为自动提交事务，如果true（默认值为true）表示自动提交，也就是每条执行的SQL语句都是一个单独的事务，如果设置为false，那么相当于开启了事务了；<strong>con.setAutoCommit(false) 表示开启事务。</strong></li><li><strong>commit（）：提交结束事务。</strong></li><li><strong>rollback（）：回滚结束事务。</strong></li></ul><p><strong>JDBC处理事务的代码格式：</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">try</span><span class="token punctuation">{</span>
     con<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开启事务</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     con<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//try的最后提交事务      </span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span>（） <span class="token punctuation">{</span>
    con<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//回滚事务</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountDao</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    * 修改指定用户的余额
    * */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateBalance</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> con<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span><span class="token keyword">double</span> balance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;UPDATE account SET balance=balance+? WHERE name=?&quot;</span><span class="token punctuation">;</span>
            <span class="token class-name">PreparedStatement</span> pstmt <span class="token operator">=</span> con<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pstmt<span class="token punctuation">.</span><span class="token function">setDouble</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pstmt<span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pstmt<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>itcast<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">JdbcUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    * 演示转账方法
    * 所有对Connect的操作都在Service层进行的处理
    * 把所有connection的操作隐藏起来，这需要使用自定义的小工具（day19_1）
    * */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transferAccounts</span><span class="token punctuation">(</span><span class="token class-name">String</span> from<span class="token punctuation">,</span><span class="token class-name">String</span> <span class="token keyword">to</span><span class="token punctuation">,</span><span class="token keyword">double</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//对事务的操作</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            con <span class="token operator">=</span> <span class="token class-name">JdbcUtils</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            con<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AccountDao</span> dao <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountDao</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dao<span class="token punctuation">.</span><span class="token function">updateBalance</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span>from<span class="token punctuation">,</span><span class="token operator">-</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//给from减去相应金额</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;不好意思，转账失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            dao<span class="token punctuation">.</span><span class="token function">updateBalance</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span><span class="token keyword">to</span><span class="token punctuation">,</span><span class="token operator">+</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//给to加上相应金额</span>
            <span class="token comment">//提交事务</span>
            con<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                con<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fun1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">transferAccounts</span><span class="token punctuation">(</span><span class="token string">&quot;zs&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>五、事务隔离级别</p><p>1、事务的并发读问题</p><ul><li>脏读：读取到另外一个事务未提交数据（不允许出来的事）；</li><li>不可重复读：两次读取不一致；</li><li>幻读（虚读）：读到另一事务已提交数据。</li></ul><p>2、并发事务问题</p><p>因为并发事务导致的问题大致有5类，其中两类是更新问题三类是读问题。</p><ul><li><strong>脏读（dirty read）：读到另一个事务的未提交新数据，即读取到了脏数据；</strong></li><li><strong>不可重复读（unrepeatable）：对同一记录的两次读取不一致，因为另一事务对该记录做了修改；</strong></li><li><strong>幻读（虚读）（phantom read）：对同一张表的两次查询不一致，因为另一事务插入了一条记录。</strong></li></ul><p>3、四大隔离级别</p><p>4个等级的事务隔离级别，在相同的数据环境下，使用相同的输入，执行相同的工作，根据不同的隔离级别，可以导致不同的结果。不同事务隔离级别能够解决的数据并发问题的能力是不同的。</p><p>1、SERIALIZABLE(串行化)</p><ul><li>不会出现任何并发问题，因为它是对同一数据的访问是串行的，非并发访问的；</li><li>性能最差</li></ul><p><strong>2、REPEATABLE READ(可重复读)（MySQL）</strong></p><ul><li><strong>防止脏读和不可重复读，不能处理幻读</strong></li><li><strong>性能比SERIALIZABLE好</strong></li></ul><p><strong>3、READ COMMITTED(读已提交数据)（Oracle）</strong></p><ul><li><strong>防止脏读，不能处理不可重复读和幻读；</strong></li><li><strong>性能比REPEATABLE READ好</strong></li></ul><p>4、READ UNCOMMITTED(读未提交数据)</p><ul><li>可能出现任何事物并发问题，什么都不处理。</li><li>性能最好</li></ul><p>六、MySQL隔离级别</p><p>MySQL的默认隔离级别为Repeatable read,可以通过下面语句查看：</p><blockquote><p>SELECT @@<code>TX_ISOLATION</code>;</p></blockquote><p>也可以通过下面语句来设置当前连接的隔离级别：</p><blockquote><p>SET TRANSACTION ISOLATION LEVEL REPEATABLE READ ;//[4选1]</p></blockquote><p>七、JDBC设置隔离级别</p><p>con.setTransactionIsolation(int level) :参数可选值如下：</p><ul><li>Connection.TRANSACTION_READ_UNCOMMITTED；</li><li>Connection.TRANSACTION_READ_COMMITTED；</li><li>Connection.TRANSACTION_REPEATABLE_READ；</li><li>Connection.TRANSACTION_READ_SERIALIZABLE。</li></ul>`,50),t=[o];function c(l,i){return s(),a("div",null,t)}const k=n(e,[["render",c],["__file","transaction.html.vue"]]),d=JSON.parse('{"path":"/code/mysql/transaction.html","title":"事务","lang":"zh-CN","frontmatter":{"order":5,"title":"事务","date":"2021-08-07T00:00:00.000Z","category":"MySQL","tag":"MySQL","timeline":true,"article":true,"description":"MySQL事务是为确保数据一致性而将多条SQL操作封装成的逻辑工作单元，遵循ACID原则。 什么是事务？ 在人员管理系统中，你删除一个人员，你即需要删除人员的基本资料，也要删除和该人员相关的信息，如信箱，文章等等，这样，这些数据库操作语句就构成一个事务！ 事务是必须满足4个条件（ACID） **事务的原子性（ Atomicity）：**一组事务，要么成...","head":[["meta",{"property":"og:url","content":"https://du-mozzie.github.io/code/mysql/transaction.html"}],["meta",{"property":"og:title","content":"事务"}],["meta",{"property":"og:description","content":"MySQL事务是为确保数据一致性而将多条SQL操作封装成的逻辑工作单元，遵循ACID原则。 什么是事务？ 在人员管理系统中，你删除一个人员，你即需要删除人员的基本资料，也要删除和该人员相关的信息，如信箱，文章等等，这样，这些数据库操作语句就构成一个事务！ 事务是必须满足4个条件（ACID） **事务的原子性（ Atomicity）：**一组事务，要么成..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/image-20240918211556431.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-09-18T14:32:25.000Z"}],["meta",{"property":"article:author","content":"mozzie"}],["meta",{"property":"article:tag","content":"MySQL"}],["meta",{"property":"article:published_time","content":"2021-08-07T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-09-18T14:32:25.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"事务\\",\\"image\\":[\\"https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/image-20240918211556431.png\\"],\\"datePublished\\":\\"2021-08-07T00:00:00.000Z\\",\\"dateModified\\":\\"2024-09-18T14:32:25.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"mozzie\\",\\"url\\":\\"https://du-mozzie.github.io\\"}]}"]]},"headers":[{"level":2,"title":"什么是事务？","slug":"什么是事务","link":"#什么是事务","children":[]},{"level":2,"title":"事务是必须满足4个条件（ACID）","slug":"事务是必须满足4个条件-acid","link":"#事务是必须满足4个条件-acid","children":[]},{"level":2,"title":"MySQL中的事务","slug":"mysql中的事务","link":"#mysql中的事务","children":[]},{"level":2,"title":"JDBC事务","slug":"jdbc事务","link":"#jdbc事务","children":[]}],"git":{"createdTime":1717143455000,"updatedTime":1726669945000,"contributors":[{"name":"du","email":"25484255238@qq.com","commits":5}]},"readingTime":{"minutes":7.12,"words":2135},"filePathRelative":"code/mysql/transaction.md","localizedDate":"2021年8月7日","excerpt":"<p>MySQL事务是为确保数据一致性而将多条SQL操作封装成的逻辑工作单元，遵循ACID原则。</p>","autoDesc":true}');export{k as comp,d as data};
