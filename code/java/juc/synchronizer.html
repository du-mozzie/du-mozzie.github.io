<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.38" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://du-mozzie.github.io/code/java/juc/synchronizer.html"><meta property="og:title" content="åŒæ­¥å™¨"><meta property="og:description" content="AQS æ ¸å¿ƒæ€æƒ³ AQSï¼šAbstractQueuedSynchronizerï¼Œæ˜¯é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·çš„æ¡†æ¶ï¼Œè®¸å¤šåŒæ­¥ç±»å®ç°éƒ½ä¾èµ–äºè¯¥åŒæ­¥å™¨ AQS ç”¨çŠ¶æ€å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å–é”å’Œé‡Šæ”¾é” ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œå¦‚ ReentrantLock å…±äº«æ¨¡å¼å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®..."><meta property="og:type" content="article"><meta property="og:image" content="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-AQS%E5%8E%9F%E7%90%86%E5%9B%BE.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-02-08T06:35:13.000Z"><meta property="article:author" content="mozzie"><meta property="article:tag" content="Java"><meta property="article:published_time" content="2021-05-18T00:00:00.000Z"><meta property="article:modified_time" content="2025-02-08T06:35:13.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"åŒæ­¥å™¨","image":["https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-AQS%E5%8E%9F%E7%90%86%E5%9B%BE.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-AQS%E9%98%9F%E5%88%97%E8%AE%BE%E8%AE%A1.png","https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-éå…¬å¹³é”1.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%812.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%813.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%814.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%815.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F1.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F2.png","https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-æ¡ä»¶å˜é‡3.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantReadWriteLock%E7%BC%93%E5%AD%98.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantReadWriteLock%E5%8A%A0%E9%94%811.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantReadWriteLock%E5%8A%A0%E9%94%812.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantReadWriteLock%E8%A7%A3%E9%94%811.png","https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantReadWriteLockè§£é”2.png","https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-CyclicBarrierå·¥ä½œåŸç†.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-Semaphore%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B1.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-Semaphore%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B2.png"],"datePublished":"2021-05-18T00:00:00.000Z","dateModified":"2025-02-08T06:35:13.000Z","author":[{"@type":"Person","name":"mozzie","url":"https://du-mozzie.github.io"}]}</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2410206_mfj6e1vbwo.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_3294373_aaebeoej8c7.css"><script src="//hm.baidu.com/hm.js?062f74a68f105c60f10f2a0fc9cc9803"></script><script src="/assets/js/clarity.js"></script><title>åŒæ­¥å™¨</title><meta name="description" content="AQS æ ¸å¿ƒæ€æƒ³ AQSï¼šAbstractQueuedSynchronizerï¼Œæ˜¯é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·çš„æ¡†æ¶ï¼Œè®¸å¤šåŒæ­¥ç±»å®ç°éƒ½ä¾èµ–äºè¯¥åŒæ­¥å™¨ AQS ç”¨çŠ¶æ€å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å–é”å’Œé‡Šæ”¾é” ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œå¦‚ ReentrantLock å…±äº«æ¨¡å¼å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®...">
    <link rel="preload" href="/assets/style-HqpqC_EL.css" as="style"><link rel="stylesheet" href="/assets/style-HqpqC_EL.css">
    <link rel="modulepreload" href="/assets/app-BE6CABvp.js"><link rel="modulepreload" href="/assets/synchronizer.html-tcUqKekN.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/assets/images/ghibli.jpg" alt><!----><!----></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="ä¸»é¡µ"><span class="font-icon icon fa-fw fa-sm iconfont icon-home" style=""></span>ä¸»é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="ä»£ç ç¬”è®°"><span class="title"><span class="font-icon icon fa-fw fa-sm iconfont icon-code" style=""></span>ä»£ç ç¬”è®°</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/code/data-structure-and-algorithms/" aria-label="æ•°æ®ç»“æ„ä¸ç®—æ³•"><img class="icon" src="/assets/images/navbar/data-structure.svg" alt aria-hidden no-view style="">æ•°æ®ç»“æ„ä¸ç®—æ³•<!----></a></li><li class="dropdown-item"><a class="route-link nav-link active" href="/code/java/" aria-label="Java"><img class="icon" src="/assets/images/navbar/java.svg" alt aria-hidden no-view style="">Java<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/netty/" aria-label="Netty"><img class="icon" src="/assets/images/navbar/netty.svg" alt aria-hidden no-view style="">Netty<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/mysql/" aria-label="MySQL"><img class="icon" src="/assets/images/navbar/mysql.svg" alt aria-hidden no-view style="">MySQL<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/spring/" aria-label="Spring"><img class="icon" src="/assets/images/navbar/spring.svg" alt aria-hidden no-view style="">Spring<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/redis/" aria-label="Redis"><img class="icon" src="/assets/images/navbar/redis.svg" alt aria-hidden no-view style="">Redis<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/distributed/" aria-label="åˆ†å¸ƒå¼"><img class="icon" src="/assets/images/navbar/distributed.svg" alt aria-hidden no-view style="">åˆ†å¸ƒå¼<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/ai/" aria-label="AI"><img class="icon" src="/assets/images/navbar/ai.svg" alt aria-hidden no-view style="">AI<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/notes/" aria-label="æ‚è®°"><img class="icon" src="/assets/images/navbar/notes.svg" alt aria-hidden no-view style="">æ‚è®°<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="åˆ†ç±»"><span class="title"><span class="font-icon icon fa-fw fa-sm iconfont icon-type" style=""></span>åˆ†ç±»</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/category/" aria-label="åˆ†ç±»"><img class="icon" src="/assets/images/navbar/category.svg" alt aria-hidden no-view style="">åˆ†ç±»<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/tag/" aria-label="æ ‡ç­¾"><img class="icon" src="/assets/images/navbar/tag.svg" alt aria-hidden no-view style="">æ ‡ç­¾<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/timeline/" aria-label="æ—¶é—´çº¿"><img class="icon" src="/assets/images/navbar/timeline.svg" alt aria-hidden no-view style="">æ—¶é—´çº¿<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/jottings/" aria-label="éšç¬”"><span class="font-icon icon fa-fw fa-sm fa-solid fa-compass-drafting" style=""></span>éšç¬”<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/links.html" aria-label="é“¾æ¥"><span class="font-icon icon fa-fw fa-sm iconfont icon-link" style=""></span>é“¾æ¥<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/about.html" aria-label="å…³äºæˆ‘"><span class="font-icon icon fa-fw fa-sm iconfont icon-people" style=""></span>å…³äºæˆ‘<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">æ•°æ®ç»“æ„ä¸ç®—æ³•</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">Java</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/system.html" aria-label="Javaä½“ç³»"><!---->Javaä½“ç³»<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/basic-conception.html" aria-label="åŸºæœ¬æ¦‚å¿µ"><!---->åŸºæœ¬æ¦‚å¿µ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/process-control.html" aria-label="æµç¨‹æ§åˆ¶"><!---->æµç¨‹æ§åˆ¶<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/array.html" aria-label="æ•°ç»„"><!---->æ•°ç»„<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/object.html" aria-label="é¢å‘å¯¹è±¡"><!---->é¢å‘å¯¹è±¡<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/common-class.html" aria-label="å¸¸ç”¨ç±»"><!---->å¸¸ç”¨ç±»<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/exception.html" aria-label="å¼‚å¸¸"><!---->å¼‚å¸¸<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/collection.html" aria-label="é›†åˆ"><!---->é›†åˆ<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">å¹¶å‘ç¼–ç¨‹</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/process.html" aria-label="è¿›ç¨‹"><!---->è¿›ç¨‹<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/thread.html" aria-label="çº¿ç¨‹"><!---->çº¿ç¨‹<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/sync.html" aria-label="åŒæ­¥"><!---->åŒæ­¥<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/memory.html" aria-label="å†…å­˜"><!---->å†…å­˜<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/no-lock.html" aria-label="æ— é”"><!---->æ— é”<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/thread-pool.html" aria-label="çº¿ç¨‹æ± "><!---->çº¿ç¨‹æ± <!----></a></li><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/code/java/juc/synchronizer.html" aria-label="åŒæ­¥å™¨"><!---->åŒæ­¥å™¨<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/concurrent-util.html" aria-label="å¹¶å‘åŒ…"><!---->å¹¶å‘åŒ…<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/summary.html" aria-label="æ€»ç»“"><!---->æ€»ç»“<!----></a></li></ul></section></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/genericity.html" aria-label="æ³›å‹"><!---->æ³›å‹<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/io.html" aria-label="IOæµ"><!---->IOæµ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/reflect.html" aria-label="åå°„"><!---->åå°„<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/annotation.html" aria-label="æ³¨è§£"><!---->æ³¨è§£<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/jvm.html" aria-label="JVM"><!---->JVM<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">MySQL</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Netty</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Spring</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Redis</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">åˆ†å¸ƒå¼</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">AI</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">ç”Ÿäº§</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">æ‚è®°</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->åŒæ­¥å™¨</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://du-mozzie.github.io" target="_blank" rel="noopener noreferrer">mozzie</a></span><span property="author" content="mozzie"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2021-05-18T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 58 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT58M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category8 clickable" role="navigation">Java</span><!--]--><meta property="articleSection" content="Java"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag8 clickable" role="navigation">Java</span><!--]--><meta property="keywords" content="Java"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#aqs">AQS</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è®¾è®¡åŸç†">è®¾è®¡åŸç†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ¨¡æ¿å¯¹è±¡">æ¨¡æ¿å¯¹è±¡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è‡ªå®šä¹‰">è‡ªå®šä¹‰</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#re-lock">Re-Lock</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#é”å¯¹æ¯”">é”å¯¹æ¯”</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨é”">ä½¿ç”¨é”</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å…¬å¹³é”">å…¬å¹³é”</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#éå…¬åŸç†">éå…¬åŸç†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#åŠ é”">åŠ é”</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#è§£é”">è§£é”</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#å…¬å¹³åŸç†">å…¬å¹³åŸç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¯é‡å…¥">å¯é‡å…¥</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¯æ‰“æ–­">å¯æ‰“æ–­</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#åŸºæœ¬ä½¿ç”¨-1">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#å®ç°åŸç†">å®ç°åŸç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#é”è¶…æ—¶">é”è¶…æ—¶</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#åŸºæœ¬ä½¿ç”¨-2">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#å®ç°åŸç†-1">å®ç°åŸç†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#å“²å­¦å®¶å°±é¤">å“²å­¦å®¶å°±é¤</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æ¡ä»¶å˜é‡">æ¡ä»¶å˜é‡</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#åŸºæœ¬ä½¿ç”¨-3">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#å®ç°åŸç†-2">å®ç°åŸç†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#await">await</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#signal">signal</a></li><!----><!--]--></ul></li><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#readwrite">ReadWrite</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#è¯»å†™é”">è¯»å†™é”</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç¼“å­˜åº”ç”¨">ç¼“å­˜åº”ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®ç°åŸç†-3">å®ç°åŸç†</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#æˆå‘˜å±æ€§">æˆå‘˜å±æ€§</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#åŠ é”åŸç†">åŠ é”åŸç†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#è§£é”åŸç†">è§£é”åŸç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#stamped">Stamped</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#countdown">CountDown</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬ä½¿ç”¨-4">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®ç°åŸç†-4">å®ç°åŸç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#cyclicbarrier">CyclicBarrier</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬ä½¿ç”¨-5">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®ç°åŸç†-5">å®ç°åŸç†</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#æˆå‘˜å±æ€§-1">æˆå‘˜å±æ€§</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#æˆå‘˜æ–¹æ³•">æˆå‘˜æ–¹æ³•</a></li><!----><!--]--></ul></li><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#semaphore">Semaphore</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬ä½¿ç”¨-6">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®ç°åŸç†-6">å®ç°åŸç†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#propagate">PROPAGATE</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#exchanger">Exchanger</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h2 id="aqs" tabindex="-1"><a class="header-anchor" href="#aqs"><span>AQS</span></a></h2><h3 id="æ ¸å¿ƒæ€æƒ³" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒæ€æƒ³"><span>æ ¸å¿ƒæ€æƒ³</span></a></h3><p>AQSï¼šAbstractQueuedSynchronizerï¼Œæ˜¯é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·çš„æ¡†æ¶ï¼Œè®¸å¤šåŒæ­¥ç±»å®ç°éƒ½ä¾èµ–äºè¯¥åŒæ­¥å™¨</p><p>AQS ç”¨çŠ¶æ€å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†<strong>ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼</strong>ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å–é”å’Œé‡Šæ”¾é”</p><ul><li>ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œå¦‚ ReentrantLock</li><li>å…±äº«æ¨¡å¼å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æºï¼Œå¦‚ Semaphoreï¼ŒReentrantReadWriteLock æ˜¯ç»„åˆå¼</li></ul><p>AQS æ ¸å¿ƒæ€æƒ³ï¼š</p><ul><li>å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶å°†å…±äº«èµ„æºè®¾ç½®é”å®šçŠ¶æ€</li><li>è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼ŒAQS ç”¨é˜Ÿåˆ—å®ç°çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­</li></ul><p>CLH æ˜¯ä¸€ç§åŸºäºå•å‘é“¾è¡¨çš„<strong>é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”</strong>ï¼ŒAQS æ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é… <img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-AQSåŸç†å›¾.png" alt="" loading="lazy"></p><h3 id="è®¾è®¡åŸç†" tabindex="-1"><a class="header-anchor" href="#è®¾è®¡åŸç†"><span>è®¾è®¡åŸç†</span></a></h3><ul><li>è·å–é”ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">while</span><span class="token punctuation">(</span>state çŠ¶æ€ä¸å…è®¸è·å–<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">// tryAcquire(arg)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰æ­¤çº¿ç¨‹<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        å…¥é˜Ÿå¹¶é˜»å¡ park
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
å½“å‰çº¿ç¨‹å‡ºé˜Ÿ
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é‡Šæ”¾é”ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">if</span><span class="token punctuation">(</span>state çŠ¶æ€å…è®¸äº†<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">// tryRelease(arg)</span>
	æ¢å¤é˜»å¡çš„çº¿ç¨‹<span class="token punctuation">(</span>s<span class="token punctuation">)</span> unpark
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AbstractQueuedSynchronizer ä¸­ state è®¾è®¡ï¼š</p><ul><li>state ä½¿ç”¨äº† 32bit int æ¥ç»´æŠ¤åŒæ­¥çŠ¶æ€ï¼Œç‹¬å æ¨¡å¼ 0 è¡¨ç¤ºæœªåŠ é”çŠ¶æ€ï¼Œå¤§äº 0 è¡¨ç¤ºå·²ç»åŠ é”çŠ¶æ€</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> state<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><p>state <strong>ä½¿ç”¨ volatile ä¿®é¥°é…åˆ cas</strong> ä¿è¯å…¶ä¿®æ”¹æ—¶çš„åŸå­æ€§</p></li><li><p>state è¡¨ç¤º<strong>çº¿ç¨‹é‡å…¥çš„æ¬¡æ•°ï¼ˆç‹¬å æ¨¡å¼ï¼‰æˆ–è€…å‰©ä½™è®¸å¯æ•°ï¼ˆå…±äº«æ¨¡å¼ï¼‰</strong></p></li><li><p>state APIï¼š</p></li><li><p><code>protected final int getState()</code>ï¼šè·å– state çŠ¶æ€</p></li><li><p><code>protected final void setState(int newState)</code>ï¼šè®¾ç½® state çŠ¶æ€</p></li><li><p><code>protected final boolean compareAndSetState(int expect,int update)</code>ï¼š<strong>CAS</strong> å®‰å…¨è®¾ç½® state</p></li></ul><p>å°è£…çº¿ç¨‹çš„ Node èŠ‚ç‚¹ä¸­ waitstate è®¾è®¡ï¼š</p><ul><li>ä½¿ç”¨ <strong>volatile ä¿®é¥°é…åˆ CAS</strong> ä¿è¯å…¶ä¿®æ”¹æ—¶çš„åŸå­æ€§</li><li>è¡¨ç¤º Node èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œæœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// é»˜è®¤ä¸º 0</span>
<span class="token keyword">volatile</span> <span class="token keyword">int</span> waitStatus<span class="token punctuation">;</span>
<span class="token comment">// ç”±äºè¶…æ—¶æˆ–ä¸­æ–­ï¼Œæ­¤èŠ‚ç‚¹è¢«å–æ¶ˆï¼Œä¸ä¼šå†æ”¹å˜çŠ¶æ€</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANCELLED</span> <span class="token operator">=</span>  <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// æ­¤èŠ‚ç‚¹åé¢çš„èŠ‚ç‚¹å·²ï¼ˆæˆ–å³å°†ï¼‰è¢«é˜»æ­¢ï¼ˆé€šè¿‡parkï¼‰ï¼Œã€å½“å‰èŠ‚ç‚¹åœ¨é‡Šæ”¾æˆ–å–æ¶ˆæ—¶å¿…é¡»å”¤é†’åé¢çš„èŠ‚ç‚¹ã€‘</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SIGNAL</span>    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// æ­¤èŠ‚ç‚¹å½“å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CONDITION</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">// å°†releaseSharedä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PROPAGATE</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é˜»å¡æ¢å¤è®¾è®¡ï¼š</p><ul><li>ä½¿ç”¨ park &amp; unpark æ¥å®ç°çº¿ç¨‹çš„æš‚åœå’Œæ¢å¤ï¼Œå› ä¸ºå‘½ä»¤çš„å…ˆåé¡ºåºä¸å½±å“ç»“æœ</li><li>park &amp; unpark æ˜¯é’ˆå¯¹çº¿ç¨‹çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹åŒæ­¥å™¨çš„ï¼Œå› æ­¤æ§åˆ¶ç²’åº¦æ›´ä¸ºç²¾ç»†</li><li>park çº¿ç¨‹å¯ä»¥é€šè¿‡ interrupt æ‰“æ–­</li></ul><p>é˜Ÿåˆ—è®¾è®¡ï¼š</p><ul><li>ä½¿ç”¨äº† FIFO å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ï¼Œå¹¶ä¸æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œ<strong>åŒæ­¥é˜Ÿåˆ—æ˜¯åŒå‘é“¾è¡¨ï¼Œä¾¿äºå‡ºé˜Ÿå…¥é˜Ÿ</strong></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// å¤´ç»“ç‚¹ï¼ŒæŒ‡å‘å“‘å…ƒèŠ‚ç‚¹</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span> head<span class="token punctuation">;</span>
<span class="token comment">// é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼Œé˜»å¡é˜Ÿåˆ—ä¸åŒ…å«å¤´ç»“ç‚¹ï¼Œä» head.next â†’ tail è®¤ä¸ºæ˜¯é˜»å¡é˜Ÿåˆ—</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Node</span> tail<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
    <span class="token comment">// æšä¸¾ï¼šå…±äº«æ¨¡å¼</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Node</span> <span class="token constant">SHARED</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æšä¸¾ï¼šç‹¬å æ¨¡å¼</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Node</span> <span class="token constant">EXCLUSIVE</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// node éœ€è¦æ„å»ºæˆ FIFO é˜Ÿåˆ—ï¼Œprev æŒ‡å‘å‰ç»§èŠ‚ç‚¹</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Node</span> prev<span class="token punctuation">;</span>
    <span class="token comment">// next æŒ‡å‘åç»§èŠ‚ç‚¹</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Node</span> next<span class="token punctuation">;</span>
    <span class="token comment">// å½“å‰ node å°è£…çš„çº¿ç¨‹</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span>
    <span class="token comment">// æ¡ä»¶é˜Ÿåˆ—æ˜¯å•å‘é“¾è¡¨ï¼Œåªæœ‰åç»§æŒ‡é’ˆï¼Œæ¡ä»¶é˜Ÿåˆ—ä½¿ç”¨è¯¥å±æ€§</span>
    <span class="token class-name">Node</span> nextWaiter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-AQSé˜Ÿåˆ—è®¾è®¡.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>æ¡ä»¶å˜é‡æ¥å®ç°ç­‰å¾…ã€å”¤é†’æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œç±»ä¼¼äº Monitor çš„ WaitSetï¼Œ<strong>æ¡ä»¶é˜Ÿåˆ—æ˜¯å•å‘é“¾è¡¨</strong></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConditionObject</span> <span class="token keyword">implements</span> <span class="token class-name">Condition</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
     <span class="token comment">// æŒ‡å‘æ¡ä»¶é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª node èŠ‚ç‚¹</span>
     <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Node</span> firstWaiter<span class="token punctuation">;</span>
     <span class="token comment">// æŒ‡å‘æ¡ä»¶é˜Ÿåˆ—çš„æœ€åä¸€ä¸ª node èŠ‚ç‚¹</span>
     <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Node</span> lastWaiter<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¨¡æ¿å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#æ¨¡æ¿å¯¹è±¡"><span>æ¨¡æ¿å¯¹è±¡</span></a></h3><p>åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè¯¥æ¨¡å¼æ˜¯åŸºäºç»§æ‰¿çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†åœ¨ä¸æ”¹å˜æ¨¡æ¿ç»“æ„çš„å‰æä¸‹åœ¨å­ç±»ä¸­é‡æ–°å®šä¹‰æ¨¡æ¿ä¸­çš„å†…å®¹ä»¥å®ç°å¤ç”¨ä»£ç </p><ul><li>ä½¿ç”¨è€…ç»§æ‰¿ <code>AbstractQueuedSynchronizer</code> å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•</li><li>å°† AQS ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨å…¶æ¨¡æ¿æ–¹æ³•ï¼Œè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•</li></ul><p>AQS ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨æ—¶éœ€è¦é‡å†™ä¸‹é¢å‡ ä¸ª AQS æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒ</span>
<span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>			<span class="token comment">//ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false</span>
<span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>			<span class="token comment">//ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false</span>
<span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>	<span class="token comment">//å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸä¸”æœ‰å‰©ä½™èµ„æº</span>
<span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>	<span class="token comment">//å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æŠ›å‡º <code>UnsupportedOperationException</code></li><li>è¿™äº›æ–¹æ³•çš„å®ç°å¿…é¡»æ˜¯å†…éƒ¨çº¿ç¨‹å®‰å…¨çš„</li><li>AQS ç±»ä¸­çš„å…¶ä»–æ–¹æ³•éƒ½æ˜¯ final ï¼Œæ‰€ä»¥æ— æ³•è¢«å…¶ä»–ç±»ä½¿ç”¨ï¼Œåªæœ‰è¿™å‡ ä¸ªæ–¹æ³•å¯ä»¥è¢«å…¶ä»–ç±»ä½¿ç”¨</li></ul><h3 id="è‡ªå®šä¹‰" tabindex="-1"><a class="header-anchor" href="#è‡ªå®šä¹‰"><span>è‡ªå®šä¹‰</span></a></h3><p>è‡ªå®šä¹‰ä¸€ä¸ªä¸å¯é‡å…¥é”ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">MyLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>
    <span class="token comment">//ç‹¬å é” ä¸å¯é‡å…¥</span>
    <span class="token keyword">class</span> <span class="token class-name">MySync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// åŠ ä¸Šé” è®¾ç½® owner ä¸ºå½“å‰çº¿ç¨‹</span>
                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>   <span class="token comment">//è§£é”</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//volatile ä¿®é¥°çš„å˜é‡æ”¾åœ¨åé¢ï¼Œé˜²æ­¢æŒ‡ä»¤é‡æ’</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token annotation punctuation">@Override</span>   <span class="token comment">//æ˜¯å¦æŒæœ‰ç‹¬å é”</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConditionObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">MySync</span> sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>   <span class="token comment">//åŠ é”ï¼ˆä¸æˆåŠŸè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ç­‰å¾…ï¼‰</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>   <span class="token comment">//åŠ é” å¯æ‰“æ–­</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>   <span class="token comment">//å°è¯•åŠ é”ï¼Œå°è¯•ä¸€æ¬¡</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>   <span class="token comment">//å°è¯•åŠ é”ï¼Œå¸¦è¶…æ—¶</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">tryAcquireNanos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>   <span class="token comment">//è§£é”</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>   <span class="token comment">//æ¡ä»¶å˜é‡</span>
    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="re-lock" tabindex="-1"><a class="header-anchor" href="#re-lock"><span>Re-Lock</span></a></h2><h3 id="é”å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#é”å¯¹æ¯”"><span>é”å¯¹æ¯”</span></a></h3><p>ReentrantLock ç›¸å¯¹äº synchronized å…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li>é”çš„å®ç°ï¼šsynchronized æ˜¯ JVM å®ç°çš„ï¼Œè€Œ ReentrantLock æ˜¯ JDK å®ç°çš„</li><li>æ€§èƒ½ï¼šæ–°ç‰ˆæœ¬ Java å¯¹ synchronized è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œsynchronized ä¸ ReentrantLock å¤§è‡´ç›¸åŒ</li><li>ä½¿ç”¨ï¼šReentrantLock éœ€è¦æ‰‹åŠ¨è§£é”ï¼Œsynchronized æ‰§è¡Œå®Œä»£ç å—è‡ªåŠ¨è§£é”</li><li><strong>å¯ä¸­æ–­</strong>ï¼šReentrantLock å¯ä¸­æ–­ï¼Œè€Œ synchronized ä¸è¡Œ</li><li><strong>å…¬å¹³é”</strong>ï¼šå…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œå¿…é¡»æŒ‰ç…§ç”³è¯·é”çš„æ—¶é—´é¡ºåºæ¥ä¾æ¬¡è·å¾—é”</li></ol><ul><li>ReentrantLock å¯ä»¥è®¾ç½®å…¬å¹³é”ï¼Œsynchronized ä¸­çš„é”æ˜¯éå…¬å¹³çš„</li><li>ä¸å…¬å¹³é”çš„å«ä¹‰æ˜¯é˜»å¡é˜Ÿåˆ—å†…å…¬å¹³ï¼Œé˜Ÿåˆ—å¤–éå…¬å¹³</li></ul><ol><li>é”è¶…æ—¶ï¼šå°è¯•è·å–é”ï¼Œè¶…æ—¶è·å–ä¸åˆ°ç›´æ¥æ”¾å¼ƒï¼Œä¸è¿›å…¥é˜»å¡é˜Ÿåˆ—</li></ol><ul><li>ReentrantLock å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œsynchronized ä¼šä¸€ç›´ç­‰å¾…</li></ul><ol><li>é”ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼šä¸€ä¸ª ReentrantLock å¯ä»¥åŒæ—¶ç»‘å®šå¤šä¸ª Condition å¯¹è±¡ï¼Œæ›´ç»†ç²’åº¦çš„å”¤é†’çº¿ç¨‹</li><li>ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”</li></ol><h3 id="ä½¿ç”¨é”" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨é”"><span>ä½¿ç”¨é”</span></a></h3><p>æ„é€ æ–¹æ³•ï¼š<code>ReentrantLock lock = new ReentrantLock();</code></p><p>ReentrantLock ç±» APIï¼š</p><ul><li><p><code>public void lock()</code>ï¼šè·å¾—é”</p></li><li><p>å¦‚æœé”æ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹å ç”¨ï¼Œåˆ™å°†é”å®šè®¡æ•°è®¾ç½®ä¸º 1</p></li><li><p>å¦‚æœå½“å‰çº¿ç¨‹å·²ç»ä¿æŒé”å®šï¼Œåˆ™ä¿æŒè®¡æ•°å¢åŠ  1</p></li><li><p>å¦‚æœé”è¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¿æŒï¼Œåˆ™å½“å‰çº¿ç¨‹è¢«ç¦ç”¨çº¿ç¨‹è°ƒåº¦ï¼Œå¹¶ä¸”åœ¨é”å®šå·²è¢«è·å–ä¹‹å‰å¤„äºä¼‘çœ çŠ¶æ€</p></li><li><p><code>public void unlock()</code>ï¼šå°è¯•é‡Šæ”¾é”</p></li><li><p>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯è¯¥é”çš„æŒæœ‰è€…ï¼Œåˆ™ä¿æŒè®¡æ•°é€’å‡</p></li><li><p>å¦‚æœä¿æŒè®¡æ•°ç°åœ¨ä¸ºé›¶ï¼Œåˆ™é”å®šè¢«é‡Šæ”¾</p></li><li><p>å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è¯¥é”çš„æŒæœ‰è€…ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</p></li></ul><p>åŸºæœ¬è¯­æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// è·å–é”</span>
reentrantLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¸´ç•ŒåŒº</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
	<span class="token comment">// é‡Šæ”¾é”</span>
	reentrantLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å…¬å¹³é”" tabindex="-1"><a class="header-anchor" href="#å…¬å¹³é”"><span>å…¬å¹³é”</span></a></h3><h4 id="åŸºæœ¬ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨"><span>åŸºæœ¬ä½¿ç”¨</span></a></h4><p>æ„é€ æ–¹æ³•ï¼š<code>ReentrantLock lock = new ReentrantLock(true)</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ReentrantLock é»˜è®¤æ˜¯ä¸å…¬å¹³çš„ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼šå…¬å¹³é”ä¸€èˆ¬æ²¡æœ‰å¿…è¦ï¼Œä¼šé™ä½å¹¶å‘åº¦</p><h4 id="éå…¬åŸç†" tabindex="-1"><a class="header-anchor" href="#éå…¬åŸç†"><span>éå…¬åŸç†</span></a></h4><h4 id="åŠ é”" tabindex="-1"><a class="header-anchor" href="#åŠ é”"><span>åŠ é”</span></a></h4><p>NonfairSync ç»§æ‰¿è‡ª AQS</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ²¡æœ‰ç«äº‰ï¼šExclusiveOwnerThread å±äº Thread-0ï¼Œstate è®¾ç½®ä¸º 1</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// ReentrantLock.NonfairSync#lock</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç”¨ cas å°è¯•ï¼ˆä»…å°è¯•ä¸€æ¬¡ï¼‰å°† state ä» 0 æ”¹ä¸º 1, å¦‚æœæˆåŠŸè¡¨ç¤ºã€è·å¾—äº†ç‹¬å é”ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å çº¿ç¨‹</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å¤±è´¥è¿›å…¥</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°ï¼šThread-1 æ‰§è¡Œï¼ŒCAS å°è¯•å°† state ç”± 0 æ”¹ä¸º 1ï¼Œç»“æœå¤±è´¥ï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œè¿›å…¥ acquire é€»è¾‘</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// AbstractQueuedSynchronizer#acquire</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// tryAcquire å°è¯•è·å–é”å¤±è´¥æ—¶, ä¼šè°ƒç”¨ addWaiter å°†å½“å‰çº¿ç¨‹å°è£…æˆnodeå…¥é˜Ÿï¼ŒacquireQueued é˜»å¡å½“å‰çº¿ç¨‹ï¼Œ</span>
    <span class="token comment">// acquireQueued è¿”å› true è¡¨ç¤ºæŒ‚èµ·è¿‡ç¨‹ä¸­çº¿ç¨‹è¢«ä¸­æ–­å”¤é†’è¿‡ï¼Œfalse è¡¨ç¤ºæœªè¢«ä¸­æ–­è¿‡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­äº†é€»è¾‘æ¥åˆ°è¿™ï¼Œå®Œæˆä¸€æ¬¡çœŸæ­£çš„æ‰“æ–­æ•ˆæœ</span>
        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-éå…¬å¹³é”1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p>è¿›å…¥ tryAcquire å°è¯•è·å–é”é€»è¾‘ï¼Œè¿™æ—¶ state å·²ç»æ˜¯1ï¼Œç»“æœä»ç„¶å¤±è´¥ï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼ŒåŠ é”æˆåŠŸæœ‰ä¸¤ç§æƒ…å†µï¼š</p></li><li><p>å½“å‰ AQS å¤„äºæ— é”çŠ¶æ€</p></li><li><p>åŠ é”çº¿ç¨‹å°±æ˜¯å½“å‰çº¿ç¨‹ï¼Œè¯´æ˜å‘ç”Ÿäº†é”é‡å…¥</p></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// ReentrantLock.NonfairSync#tryAcquire</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// æŠ¢å æˆåŠŸè¿”å› trueï¼ŒæŠ¢å å¤±è´¥è¿”å› false</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// state å€¼</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰å¤„äºã€æ— é”çŠ¶æ€ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//å¦‚æœè¿˜æ²¡æœ‰è·å¾—é”ï¼Œå°è¯•ç”¨casè·å¾—ï¼Œè¿™é‡Œä½“ç°éå…¬å¹³æ€§: ä¸å»æ£€æŸ¥ AQS é˜Ÿåˆ—æ˜¯å¦æœ‰é˜»å¡çº¿ç¨‹ç›´æ¥è·å–é”        </span>
    	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å–é”æˆåŠŸè®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å é”çº¿ç¨‹ã€‚</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>    
	<span class="token punctuation">}</span>    
   	<span class="token comment">// å¦‚æœå·²ç»æœ‰çº¿ç¨‹è·å¾—äº†é”, ç‹¬å é”çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºã€å‘ç”Ÿäº†é”é‡å…¥ã€‘</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ›´æ–°é”é‡å…¥çš„å€¼</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
        <span class="token comment">// è¶Šç•Œåˆ¤æ–­ï¼Œå½“é‡å…¥çš„æ·±åº¦å¾ˆæ·±æ—¶ï¼Œä¼šå¯¼è‡´ nextc &lt; 0ï¼Œintå€¼è¾¾åˆ°æœ€å¤§ä¹‹åå† + 1 å˜è´Ÿæ•°</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ›´æ–° state çš„å€¼ï¼Œè¿™é‡Œä¸ä½¿ç”¨ cas æ˜¯å› ä¸ºå½“å‰çº¿ç¨‹æ­£åœ¨æŒæœ‰é”ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ“ä½œç›¸å½“äºåœ¨ä¸€ä¸ªç®¡ç¨‹å†…</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è·å–å¤±è´¥</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>æ¥ä¸‹æ¥è¿›å…¥ addWaiter é€»è¾‘ï¼Œæ„é€  Node é˜Ÿåˆ—ï¼ˆä¸æ˜¯é˜»å¡é˜Ÿåˆ—ï¼‰ï¼Œå‰ç½®æ¡ä»¶æ˜¯å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¯´æ˜æœ‰çº¿ç¨‹å ç”¨äº†é”</p></li><li><p>å›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºè¯¥ Node çš„ waitStatus çŠ¶æ€ï¼Œå…¶ä¸­ 0 ä¸ºé»˜è®¤<strong>æ­£å¸¸çŠ¶æ€</strong></p></li><li><p>Node çš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ª Node ç§°ä¸º <strong>Dummyï¼ˆå“‘å…ƒï¼‰æˆ–å“¨å…µ</strong>ï¼Œç”¨æ¥å ä½ï¼Œå¹¶ä¸å…³è”çº¿ç¨‹</p></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// AbstractQueuedSynchronizer#addWaiterï¼Œè¿”å›å½“å‰çº¿ç¨‹çš„ node èŠ‚ç‚¹</span>
<span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span> mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼   </span>
    <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Node</span> pred <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    <span class="token comment">// å¿«é€Ÿå…¥é˜Ÿï¼Œå¦‚æœ tail ä¸ä¸º nullï¼Œè¯´æ˜å­˜åœ¨é˜Ÿåˆ—</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°†å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘ å°¾èŠ‚ç‚¹</span>
        node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span>
        <span class="token comment">// é€šè¿‡ cas å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—ï¼Œæˆä¸ºå°¾èŠ‚ç‚¹ï¼Œã€å°¾æ’æ³•ã€‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token comment">// åŒå‘é“¾è¡¨</span>
            <span class="token keyword">return</span> node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// åˆå§‹æ—¶é˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€… CAS å¤±è´¥è¿›å…¥è¿™é‡Œ</span>
    <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// AbstractQueuedSynchronizer#enq</span>
<span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">enq</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è‡ªæ—‹å…¥é˜Ÿï¼Œå¿…é¡»å…¥é˜ŸæˆåŠŸæ‰ç»“æŸå¾ªç¯</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        <span class="token comment">// è¯´æ˜å½“å‰é”è¢«å ç”¨ï¼Œä¸”å½“å‰çº¿ç¨‹å¯èƒ½æ˜¯ã€ç¬¬ä¸€ä¸ªè·å–é”å¤±è´¥ã€‘çš„çº¿ç¨‹ï¼Œã€è¿˜æ²¡æœ‰å»ºç«‹é˜Ÿåˆ—ã€‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è®¾ç½®ä¸€ä¸ªã€å“‘å…ƒèŠ‚ç‚¹ã€‘ï¼Œå¤´å°¾æŒ‡é’ˆéƒ½æŒ‡å‘è¯¥èŠ‚ç‚¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetHead</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                tail <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// è‡ªæ—‹åˆ°è¿™ï¼Œæ™®é€šå…¥é˜Ÿæ–¹å¼ï¼Œé¦–å…ˆèµ‹å€¼å°¾èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ã€å°¾æ’æ³•ã€‘</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token comment">// ã€åœ¨è®¾ç½®å®Œå°¾èŠ‚ç‚¹åï¼Œæ‰æ›´æ–°çš„åŸå§‹å°¾èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ­¤æ—¶ä»å‰å¾€åéå†ä¼šä¸¢å¤±å°¾èŠ‚ç‚¹ã€‘</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//ã€æ­¤æ—¶ t.next  = nullï¼Œå¹¶ä¸”è¿™é‡Œå·²ç» CAS ç»“æŸï¼Œçº¿ç¨‹å¹¶ä¸æ˜¯å®‰å…¨çš„ã€‘</span>
                t<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token keyword">return</span> t<span class="token punctuation">;</span>	<span class="token comment">// è¿”å›å½“å‰ node çš„å‰é©±èŠ‚ç‚¹</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-éå…¬å¹³é”2.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p>çº¿ç¨‹èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—æˆåŠŸï¼Œè¿›å…¥ AbstractQueuedSynchronizer#acquireQueued é€»è¾‘é˜»å¡çº¿ç¨‹</p></li><li><p>acquireQueued ä¼šåœ¨ä¸€ä¸ªè‡ªæ—‹ä¸­ä¸æ–­å°è¯•è·å¾—é”ï¼Œå¤±è´¥åè¿›å…¥ park é˜»å¡</p></li><li><p>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯åœ¨ head èŠ‚ç‚¹åï¼Œä¼šå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œstate ä»ä¸º 1 åˆ™å¤±è´¥ï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// true è¡¨ç¤ºå½“å‰çº¿ç¨‹æŠ¢å é”å¤±è´¥ï¼Œfalse è¡¨ç¤ºæˆåŠŸ</span>
    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸­æ–­æ ‡è®°ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</span>
        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å¾—å½“å‰çº¿ç¨‹èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹</span>
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å‰é©±èŠ‚ç‚¹æ˜¯ head, FIFO é˜Ÿåˆ—çš„ç‰¹æ€§è¡¨ç¤ºè½®åˆ°å½“å‰çº¿ç¨‹å¯ä»¥å»è·å–é”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è·å–æˆåŠŸ, è®¾ç½®å½“å‰çº¿ç¨‹è‡ªå·±çš„ node ä¸º head</span>
                <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
                <span class="token comment">// è¡¨ç¤ºæŠ¢å é”æˆåŠŸ</span>
                failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment">// è¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</span>
                <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// åˆ¤æ–­æ˜¯å¦åº”å½“ parkï¼Œè¿”å› false åéœ€è¦æ–°ä¸€è½®çš„å¾ªç¯ï¼Œè¿”å› true è¿›å…¥æ¡ä»¶äºŒé˜»å¡çº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// æ¡ä»¶äºŒè¿”å›ç»“æœæ˜¯å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¢«æ‰“æ–­è¿”å› false ä¸è¿›å…¥è¿™é‡Œçš„é€»è¾‘</span>
                <span class="token comment">// ã€å°±ç®—è¢«æ‰“æ–­äº†ï¼Œä¹Ÿä¼šç»§ç»­å¾ªç¯ï¼Œå¹¶ä¸ä¼šè¿”å›ã€‘</span>
                interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// ã€å¯æ‰“æ–­æ¨¡å¼ä¸‹æ‰ä¼šè¿›å…¥è¯¥é€»è¾‘ã€‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¿›å…¥ shouldParkAfterFailedAcquire é€»è¾‘ï¼Œ<strong>å°†å‰é©± node çš„ waitStatus æ”¹ä¸º -1</strong>ï¼Œè¿”å› falseï¼›waitStatus ä¸º -1 çš„èŠ‚ç‚¹ç”¨æ¥å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span><span class="token class-name">Node</span> pred<span class="token punctuation">,</span> <span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
    <span class="token comment">// è¡¨ç¤ºå‰ç½®èŠ‚ç‚¹æ˜¯ä¸ªå¯ä»¥å”¤é†’å½“å‰èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼Œè¿”å› true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// å‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€å¤„äºå–æ¶ˆçŠ¶æ€ï¼Œéœ€è¦ã€åˆ é™¤å‰é¢æ‰€æœ‰å–æ¶ˆçš„èŠ‚ç‚¹ã€‘, è¿”å›åˆ°å¤–å±‚å¾ªç¯é‡è¯•</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–åˆ°éå–æ¶ˆçš„èŠ‚ç‚¹ï¼Œè¿æ¥ä¸Šå½“å‰èŠ‚ç‚¹</span>
        pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
    <span class="token comment">// é»˜è®¤æƒ…å†µä¸‹ node çš„ waitStatus æ˜¯ 0ï¼Œè¿›å…¥è¿™é‡Œçš„é€»è¾‘</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// ã€è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¸º Node.SIGNALã€‘ï¼Œè¿”å›å¤–å±‚å¾ªç¯é‡è¯•</span>
        <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿”å›ä¸åº”è¯¥ parkï¼Œå†æ¬¡å°è¯•ä¸€æ¬¡</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>shouldParkAfterFailedAcquire æ‰§è¡Œå®Œæ¯•å›åˆ° acquireQueued ï¼Œå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œè¿™æ—¶ state ä»ä¸º 1 è·å–å¤±è´¥ï¼ˆç¬¬å››æ¬¡ï¼‰</li><li>å½“å†æ¬¡è¿›å…¥ shouldParkAfterFailedAcquire æ—¶ï¼Œè¿™æ—¶å…¶å‰é©± node çš„ waitStatus å·²ç»æ˜¯ -1 äº†ï¼Œè¿”å› true</li><li>è¿›å…¥ parkAndCheckInterruptï¼Œ Thread-1 parkï¼ˆç°è‰²è¡¨ç¤ºï¼‰</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</span>
    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</span>
    <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å†æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ç«äº‰å¤±è´¥åï¼š <img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-éå…¬å¹³é”3.png" alt="" loading="lazy"></li></ul><h4 id="è§£é”" tabindex="-1"><a class="header-anchor" href="#è§£é”"><span>è§£é”</span></a></h4><p>ReentrantLock#unlockï¼šé‡Šæ”¾é”</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Thread-0 é‡Šæ”¾é”ï¼Œè¿›å…¥ release æµç¨‹</p><ul><li>è¿›å…¥ tryReleaseï¼Œè®¾ç½® exclusiveOwnerThread ä¸º nullï¼Œstate = 0</li><li>å½“å‰é˜Ÿåˆ—ä¸ä¸º nullï¼Œå¹¶ä¸” head çš„ waitStatus = -1ï¼Œè¿›å…¥ unparkSuccessor</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// AbstractQueuedSynchronizer#release</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°è¯•é‡Šæ”¾é”ï¼ŒtryRelease è¿”å› true è¡¨ç¤ºå½“å‰çº¿ç¨‹å·²ç»ã€å®Œå…¨é‡Šæ”¾é”ï¼Œé‡å…¥çš„é‡Šæ”¾äº†ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é˜Ÿåˆ—å¤´èŠ‚ç‚¹</span>
        <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token comment">// å¤´èŠ‚ç‚¹ä»€ä¹ˆæ—¶å€™æ˜¯ç©ºï¼Ÿæ²¡æœ‰å‘ç”Ÿé”ç«äº‰ï¼Œæ²¡æœ‰ç«äº‰çº¿ç¨‹åˆ›å»ºå“‘å…ƒèŠ‚ç‚¹</span>
        <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜é˜»å¡é˜Ÿåˆ—æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œéœ€è¦å”¤é†’ head èŠ‚ç‚¹åé¢çš„çº¿ç¨‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ReentrantLock.Sync#tryRelease</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å‡å»é‡Šæ”¾çš„å€¼ï¼Œå¯èƒ½é‡å…¥</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> releases<span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æŒæœ‰é”çš„çº¿ç¨‹ç›´æ¥æŠ¥é”™</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ˜¯å¦å·²ç»å®Œå…¨é‡Šæ”¾é”</span>
    <span class="token keyword">boolean</span> free <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰å®Œå…¨é‡Šæ”¾é”æˆåŠŸ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        free <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å½“å‰çº¿ç¨‹å°±æ˜¯æŒæœ‰é”çº¿ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ›´æ–°é”ï¼Œä¸éœ€è¦ä½¿ç”¨ CAS</span>
    <span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> free<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>è¿›å…¥ AbstractQueuedSynchronizer#unparkSuccessor æ–¹æ³•ï¼Œå”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</p></li><li><p>æ‰¾åˆ°é˜Ÿåˆ—ä¸­è·ç¦» head æœ€è¿‘çš„ä¸€ä¸ªæ²¡å–æ¶ˆçš„ Nodeï¼Œunpark æ¢å¤å…¶è¿è¡Œï¼Œæœ¬ä¾‹ä¸­å³ä¸º Thread-1</p></li><li><p>å›åˆ° Thread-1 çš„ acquireQueued æµç¨‹</p></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€</span>
    <span class="token keyword">int</span> ws <span class="token operator">=</span> node<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        
        <span class="token comment">// ã€å°è¯•é‡ç½®çŠ¶æ€ä¸º 0ã€‘ï¼Œå› ä¸ºå½“å‰èŠ‚ç‚¹è¦å®Œæˆå¯¹åç»­èŠ‚ç‚¹çš„å”¤é†’ä»»åŠ¡äº†ï¼Œä¸éœ€è¦ -1 äº†</span>
        <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token comment">// æ‰¾åˆ°éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ª    </span>
    <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>    
    <span class="token comment">// å·²å–æ¶ˆçš„èŠ‚ç‚¹ä¸èƒ½å”¤é†’ï¼Œéœ€è¦æ‰¾åˆ°è·ç¦»å¤´èŠ‚ç‚¹æœ€è¿‘çš„éå–æ¶ˆçš„èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// AQS é˜Ÿåˆ—ã€ä»åè‡³å‰ã€‘æ‰¾éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œç›´åˆ° t == å½“å‰çš„ node ä¸ºæ­¢ï¼Œæ‰¾ä¸åˆ°å°±ä¸å”¤é†’äº†</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span> t <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> node<span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token punctuation">.</span>prev<span class="token punctuation">)</span>
            <span class="token comment">// è¯´æ˜å½“å‰çº¿ç¨‹çŠ¶æ€éœ€è¦è¢«å”¤é†’</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment">// ç½®æ¢å¼•ç”¨</span>
                s <span class="token operator">=</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ã€æ‰¾åˆ°åˆé€‚çš„å¯ä»¥è¢«å”¤é†’çš„ nodeï¼Œåˆ™å”¤é†’çº¿ç¨‹ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ä»åå‘å‰çš„å”¤é†’çš„åŸå› </strong>ï¼šenq æ–¹æ³•ä¸­ï¼ŒèŠ‚ç‚¹æ˜¯å°¾æ’æ³•ï¼Œé¦–å…ˆèµ‹å€¼çš„æ˜¯å°¾èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œæ­¤æ—¶å‰é©±èŠ‚ç‚¹çš„ next å¹¶æ²¡æœ‰æŒ‡å‘å°¾èŠ‚ç‚¹ï¼Œä»å‰éå†ä¼šä¸¢å¤±å°¾èŠ‚ç‚¹</p><ul><li><p>å”¤é†’çš„çº¿ç¨‹ä¼šä» park ä½ç½®å¼€å§‹æ‰§è¡Œï¼Œå¦‚æœåŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä¼šè®¾ç½®</p></li><li><p>exclusiveOwnerThread ä¸º Thread-1ï¼Œstate = 1</p></li><li><p>head æŒ‡å‘åˆšåˆš Thread-1 æ‰€åœ¨çš„ Nodeï¼Œè¯¥ Node ä¼šæ¸…ç©º Thread</p></li><li><p>åŸæœ¬çš„ head å› ä¸ºä»é“¾è¡¨æ–­å¼€ï¼Œè€Œå¯è¢«åƒåœ¾å›æ”¶ï¼ˆå›¾ä¸­æœ‰é”™è¯¯ï¼ŒåŸæ¥çš„å¤´èŠ‚ç‚¹çš„ waitStatus è¢«æ”¹ä¸º 0 äº†ï¼‰</p></li></ul><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-éå…¬å¹³é”4.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p>å¦‚æœè¿™æ—¶æœ‰å…¶å®ƒçº¿ç¨‹æ¥ç«äº‰**ï¼ˆéå…¬å¹³ï¼‰**ï¼Œä¾‹å¦‚è¿™æ—¶æœ‰ Thread-4 æ¥äº†å¹¶æŠ¢å äº†é”</p></li><li><p>Thread-4 è¢«è®¾ç½®ä¸º exclusiveOwnerThreadï¼Œstate = 1</p></li><li><p>Thread-1 å†æ¬¡è¿›å…¥ acquireQueued æµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥ park é˜»å¡</p></li></ul><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-éå…¬å¹³é”5.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="å…¬å¹³åŸç†" tabindex="-1"><a class="header-anchor" href="#å…¬å¹³åŸç†"><span>å…¬å¹³åŸç†</span></a></h4><p>ä¸éå…¬å¹³é”ä¸»è¦åŒºåˆ«åœ¨äº tryAcquire æ–¹æ³•ï¼šå…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ‰å» CAS ç«äº‰</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3000897897090466540L</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰(false)æ‰å»ç«äº‰</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// é”é‡å…¥</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token class-name">Node</span> t <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token class-name">Node</span> s<span class="token punctuation">;</span>    
    <span class="token comment">// å¤´å°¾æŒ‡å‘ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé“¾è¡¨ä¸ºç©ºï¼Œè¿”å›false</span>
    <span class="token keyword">return</span> h <span class="token operator">!=</span> t <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// å¤´å°¾ä¹‹é—´æœ‰èŠ‚ç‚¹ï¼Œåˆ¤æ–­å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªæ˜¯ä¸æ˜¯ç©º</span>
        <span class="token comment">// ä¸æ˜¯ç©ºè¿›å…¥æœ€åçš„åˆ¤æ–­ï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹æ˜¯å¦æ˜¯æœ¬çº¿ç¨‹ï¼Œä¸æ˜¯è¿”å› trueï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹æœ‰å‰é©±èŠ‚ç‚¹</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> h<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¯é‡å…¥" tabindex="-1"><a class="header-anchor" href="#å¯é‡å…¥"><span>å¯é‡å…¥</span></a></h3><p>å¯é‡å…¥æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé”ï¼Œå¦‚æœä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½ï¼Œç›´æ¥é€ æˆæ­»é”</p><p>æºç è§£æå‚è€ƒï¼š<code>nonfairTryAcquire(int acquires))</code> å’Œ <code>tryRelease(int releases)</code></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; execute method1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">method2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; execute method2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ Lock æ–¹æ³•åŠ ä¸¤æŠŠé”ä¼šæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</p><ul><li>åŠ é”ä¸¤æ¬¡è§£é”ä¸¤æ¬¡ï¼šæ­£å¸¸æ‰§è¡Œ</li><li>åŠ é”ä¸¤æ¬¡è§£é”ä¸€æ¬¡ï¼šç¨‹åºç›´æ¥å¡æ­»ï¼Œçº¿ç¨‹ä¸èƒ½å‡ºæ¥ï¼Œä¹Ÿå°±è¯´æ˜<strong>ç”³è¯·å‡ æŠŠé”ï¼Œæœ€åéœ€è¦è§£é™¤å‡ æŠŠé”</strong></li><li>åŠ é”ä¸€æ¬¡è§£é”ä¸¤æ¬¡ï¼šè¿è¡Œç¨‹åºä¼šç›´æ¥æŠ¥é”™</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t get Lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//lock.unlock();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¯æ‰“æ–­" tabindex="-1"><a class="header-anchor" href="#å¯æ‰“æ–­"><span>å¯æ‰“æ–­</span></a></h3><h4 id="åŸºæœ¬ä½¿ç”¨-1" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨-1"><span>åŸºæœ¬ä½¿ç”¨</span></a></h4><p><code>public void lockInterruptibly()</code>ï¼šè·å¾—å¯æ‰“æ–­çš„é”</p><ul><li>å¦‚æœæ²¡æœ‰ç«äº‰æ­¤æ–¹æ³•å°±ä¼šè·å– lock å¯¹è±¡é”</li><li>å¦‚æœæœ‰ç«äº‰å°±è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ç”¨ interrupt æ‰“æ–­</li></ul><p>æ³¨æ„ï¼šå¦‚æœæ˜¯ä¸å¯ä¸­æ–­æ¨¡å¼ï¼Œé‚£ä¹ˆå³ä½¿ä½¿ç”¨äº† interrupt ä¹Ÿä¸ä¼šè®©ç­‰å¾…çŠ¶æ€ä¸­çš„çº¿ç¨‹ä¸­æ–­</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>    
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        
        <span class="token keyword">try</span> <span class="token punctuation">{</span>            
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å°è¯•è·å–é”&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
            lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ²¡æœ‰è·å–åˆ°é”ï¼Œè¢«æ‰“æ–­ï¼Œç›´æ¥è¿”å›&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
            <span class="token keyword">return</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>        
        <span class="token keyword">try</span> <span class="token punctuation">{</span>            
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è·å–åˆ°é”&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>    
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä¸»çº¿ç¨‹è¿›è¡Œæ‰“æ–­é”&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    t1<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å®ç°åŸç†" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†"><span>å®ç°åŸç†</span></a></h4><ul><li>ä¸å¯æ‰“æ–­æ¨¡å¼ï¼šå³ä½¿å®ƒè¢«æ‰“æ–­ï¼Œä»ä¼šé©»ç•™åœ¨ AQS é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œä¸€ç›´è¦<strong>ç­‰åˆ°è·å¾—é”åæ‰èƒ½å¾—çŸ¥è‡ªå·±è¢«æ‰“æ–­</strong>äº†</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//é˜»å¡ç­‰å¾…        </span>
        <span class="token comment">// å¦‚æœacquireQueuedè¿”å›trueï¼Œæ‰“æ–­çŠ¶æ€ interrupted = true        </span>
        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// çŸ¥é“è‡ªå·±è¢«æ‰“æ–­äº†ï¼Œéœ€è¦é‡æ–°äº§ç”Ÿä¸€æ¬¡ä¸­æ–­å®Œæˆä¸­æ–­æ•ˆæœ</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token keyword">try</span> <span class="token punctuation">{</span>        
        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                
                <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>                
                p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC                </span>
                failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                
                <span class="token comment">// è¿˜æ˜¯éœ€è¦è·å¾—é”å, æ‰èƒ½è¿”å›æ‰“æ–­çŠ¶æ€</span>
                <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>            
            <span class="token punctuation">}</span>            
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// æ¡ä»¶äºŒä¸­åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œè¢«æ‰“æ–­è¿”å›trueï¼Œè®¾ç½®ä¸­æ–­æ ‡è®°ä¸º trueï¼Œã€è·å–é”åè¿”å›ã€‘</span>
                interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>                  
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
     <span class="token comment">// é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</span>
     <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
     <span class="token comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œè¢«æ‰“æ–­è¿”å›true</span>
     <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å¯æ‰“æ–­æ¨¡å¼ï¼šAbstractQueuedSynchronizer#acquireInterruptiblyï¼Œ<strong>è¢«æ‰“æ–­åä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸</strong></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>    
    sync<span class="token punctuation">.</span><span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­äº†ç›´æ¥è¿”å› false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// æ²¡è·å–åˆ°é”ï¼Œè¿›å…¥è¿™é‡Œ</span>
        <span class="token function">doAcquireInterruptibly</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿”å›å°è£…å½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// ã€åœ¨ park è¿‡ç¨‹ä¸­å¦‚æœè¢« interrupt ä¼šæŠ›å‡ºå¼‚å¸¸ã€‘, è€Œä¸ä¼šå†æ¬¡è¿›å…¥å¾ªç¯è·å–é”åæ‰å®Œæˆæ‰“æ–­æ•ˆæœ</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>    
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// æŠ›å‡ºå¼‚å¸¸å‰ä¼šè¿›å…¥è¿™é‡Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token comment">// å–æ¶ˆå½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// å–æ¶ˆèŠ‚ç‚¹å‡ºé˜Ÿçš„é€»è¾‘</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cancelAcquire</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤ç©º</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token comment">// æŠŠå½“å‰èŠ‚ç‚¹å°è£…çš„ Thread ç½®ä¸ºç©º</span>
    node<span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token comment">// è·å–å½“å‰å–æ¶ˆçš„ node çš„å‰é©±èŠ‚ç‚¹</span>
    <span class="token class-name">Node</span> pred <span class="token operator">=</span> node<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
    <span class="token comment">// å‰é©±èŠ‚ç‚¹ä¹Ÿè¢«å–æ¶ˆäº†ï¼Œå¾ªç¯æ‰¾åˆ°å‰é¢æœ€è¿‘çš„æ²¡è¢«å–æ¶ˆçš„èŠ‚ç‚¹</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
    
	<span class="token comment">// è·å–å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œå¯èƒ½æ˜¯å½“å‰ nodeï¼Œä¹Ÿå¯èƒ½æ˜¯ waitStatus &gt; 0 çš„èŠ‚ç‚¹</span>
    <span class="token class-name">Node</span> predNext <span class="token operator">=</span> pred<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    
	<span class="token comment">// æŠŠå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º ã€å–æ¶ˆçŠ¶æ€ 1ã€‘</span>
    node<span class="token punctuation">.</span>waitStatus <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">CANCELLED</span><span class="token punctuation">;</span>
    
	<span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹ï¼ŒæŠŠå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> tail <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> pred<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æŠŠå‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ç½®ç©ºï¼Œè¿™é‡Œç›´æ¥æŠŠæ‰€æœ‰çš„å–æ¶ˆèŠ‚ç‚¹å‡ºé˜Ÿ</span>
        <span class="token function">compareAndSetNext</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> predNext<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯´æ˜å½“å‰èŠ‚ç‚¹ä¸æ˜¯ tail èŠ‚ç‚¹</span>
        <span class="token keyword">int</span> ws<span class="token punctuation">;</span>
        <span class="token comment">// æ¡ä»¶ä¸€æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹ä¸æ˜¯ head.next èŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> head <span class="token operator">&amp;&amp;</span>
            <span class="token comment">// åˆ¤æ–­å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ä¸æ˜¯ -1ï¼Œä¸æˆç«‹è¯´æ˜å‰é©±çŠ¶æ€å¯èƒ½æ˜¯ 0 æˆ–è€…åˆšè¢«å…¶ä»–çº¿ç¨‹å–æ¶ˆæ’é˜Ÿäº†</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span> <span class="token operator">||</span>
             <span class="token comment">// å¦‚æœçŠ¶æ€ä¸æ˜¯ -1ï¼Œè®¾ç½®å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º -1</span>
             <span class="token punctuation">(</span>ws <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token comment">// å‰é©±èŠ‚ç‚¹çš„çº¿ç¨‹ä¸ä¸ºnull</span>
            pred<span class="token punctuation">.</span>thread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
            <span class="token class-name">Node</span> next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token comment">// å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æ˜¯æ­£å¸¸èŠ‚ç‚¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment">// æŠŠ å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ è®¾ç½®ä¸º å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œã€ä»é˜Ÿåˆ—ä¸­åˆ é™¤äº†å½“å‰èŠ‚ç‚¹ã€‘</span>
                <span class="token function">compareAndSetNext</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> predNext<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// å½“å‰èŠ‚ç‚¹æ˜¯ head.next èŠ‚ç‚¹ï¼Œå”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span>
            <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        node<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span> <span class="token comment">// help GC</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="é”è¶…æ—¶" tabindex="-1"><a class="header-anchor" href="#é”è¶…æ—¶"><span>é”è¶…æ—¶</span></a></h3><h4 id="åŸºæœ¬ä½¿ç”¨-2" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨-2"><span>åŸºæœ¬ä½¿ç”¨</span></a></h4><p><code>public boolean tryLock()</code>ï¼šå°è¯•è·å–é”ï¼Œè·å–åˆ°è¿”å› trueï¼Œè·å–ä¸åˆ°ç›´æ¥æ”¾å¼ƒï¼Œä¸è¿›å…¥é˜»å¡é˜Ÿåˆ—</p><p><code>public boolean tryLock(long timeout, TimeUnit unit)</code>ï¼šåœ¨ç»™å®šæ—¶é—´å†…è·å–é”ï¼Œè·å–ä¸åˆ°å°±é€€å‡º</p><p>æ³¨æ„ï¼štryLock æœŸé—´ä¹Ÿå¯ä»¥è¢«æ‰“æ–­</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è·å–ä¸åˆ°é”&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è¢«æ‰“æ–­ï¼Œè·å–ä¸åˆ°é”&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;è·å–åˆ°é”&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä¸»çº¿ç¨‹è·å–åˆ°é”&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä¸»çº¿ç¨‹é‡Šæ”¾äº†é”&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å®ç°åŸç†-1" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†-1"><span>å®ç°åŸç†</span></a></h4><ul><li>æˆå‘˜å˜é‡ï¼šæŒ‡å®šè¶…æ—¶é™åˆ¶çš„é˜ˆå€¼ï¼Œå°äºè¯¥å€¼çš„çº¿ç¨‹ä¸ä¼šè¢«æŒ‚èµ·</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> spinForTimeoutThreshold <span class="token operator">=</span> <span class="token number">1000L</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¶…æ—¶æ—¶é—´è®¾ç½®çš„å°äºè¯¥å€¼ï¼Œå°±ä¼šè¢«ç¦æ­¢æŒ‚èµ·ï¼Œå› ä¸ºé˜»å¡åœ¨å”¤é†’çš„æˆæœ¬å¤ªé«˜ï¼Œä¸å¦‚é€‰æ‹©è‡ªæ—‹ç©ºè½¬</p><ul><li>tryLock()</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   
    <span class="token comment">// åªå°è¯•ä¸€æ¬¡</span>
    <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>tryLock(long timeout, TimeUnit unit)</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquireNanos</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">,</span> <span class="token keyword">long</span> nanosTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token comment">// tryAcquire å°è¯•ä¸€æ¬¡</span>
    <span class="token keyword">return</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">doAcquireNanos</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> nanosTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token keyword">return</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">doAcquireNanos</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">,</span> <span class="token keyword">long</span> nanosTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nanosTimeout <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–æœ€åæœŸé™çš„æ—¶é—´æˆ³</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> deadline <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> nanosTimeout<span class="token punctuation">;</span>
    <span class="token comment">//...</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//...</span>
            <span class="token comment">// è®¡ç®—è¿˜éœ€ç­‰å¾…çš„æ—¶é—´</span>
            nanosTimeout <span class="token operator">=</span> deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nanosTimeout <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span>	<span class="token comment">//æ—¶é—´å·²åˆ°     </span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token comment">// å¦‚æœ nanosTimeout å¤§äºè¯¥å€¼ï¼Œæ‰æœ‰é˜»å¡çš„æ„ä¹‰ï¼Œå¦åˆ™ç›´æ¥è‡ªæ—‹ä¼šå¥½ç‚¹</span>
                nanosTimeout <span class="token operator">&gt;</span> spinForTimeoutThreshold<span class="token punctuation">)</span>
                <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nanosTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ã€è¢«æ‰“æ–­ä¼šæŠ¥å¼‚å¸¸ã€‘</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å“²å­¦å®¶å°±é¤" tabindex="-1"><a class="header-anchor" href="#å“²å­¦å®¶å°±é¤"><span>å“²å­¦å®¶å°±é¤</span></a></h4><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Chopstick</span> c1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//...</span>
    <span class="token class-name">Chopstick</span> c5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;è‹æ ¼æ‹‰åº•&quot;</span><span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;æŸæ‹‰å›¾&quot;</span><span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;äºšé‡Œå£«å¤šå¾·&quot;</span><span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;èµ«æ‹‰å…‹åˆ©ç‰¹&quot;</span><span class="token punctuation">,</span> c4<span class="token punctuation">,</span> c5<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">new</span> <span class="token class-name">Philosopher</span><span class="token punctuation">(</span><span class="token string">&quot;é˜¿åŸºç±³å¾·&quot;</span><span class="token punctuation">,</span> c5<span class="token punctuation">,</span> c1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Philosopher</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token class-name">Chopstick</span> left<span class="token punctuation">;</span>
    <span class="token class-name">Chopstick</span> right<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å°è¯•è·å¾—å·¦æ‰‹ç­·å­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>left<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å°è¯•è·å¾—å³æ‰‹ç­·å­</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>right<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;eating...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                            right<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    left<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Chopstick</span> <span class="token keyword">extends</span> <span class="token class-name">ReentrantLock</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Chopstick</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;ç­·å­{&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token char">&#39;}&#39;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¡ä»¶å˜é‡" tabindex="-1"><a class="header-anchor" href="#æ¡ä»¶å˜é‡"><span>æ¡ä»¶å˜é‡</span></a></h3><h4 id="åŸºæœ¬ä½¿ç”¨-3" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨-3"><span>åŸºæœ¬ä½¿ç”¨</span></a></h4><p>synchronized çš„æ¡ä»¶å˜é‡ï¼Œæ˜¯å½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥ WaitSet ç­‰å¾…ï¼›ReentrantLock çš„æ¡ä»¶å˜é‡æ¯” synchronized å¼ºå¤§ä¹‹å¤„åœ¨äºæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</p><p>ReentrantLock ç±»è·å– Condition å¯¹è±¡ï¼š<code>public Condition newCondition()</code></p><p>Condition ç±» APIï¼š</p><ul><li><code>void await()</code>ï¼šå½“å‰çº¿ç¨‹ä»è¿è¡ŒçŠ¶æ€è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œé‡Šæ”¾é”</li><li><code>void signal()</code>ï¼šå”¤é†’ä¸€ä¸ªç­‰å¾…åœ¨ Condition ä¸Šçš„çº¿ç¨‹ï¼Œä½†æ˜¯å¿…é¡»è·å¾—ä¸è¯¥ Condition ç›¸å…³çš„é”</li></ul><p>ä½¿ç”¨æµç¨‹ï¼š</p><ul><li><strong>await / signal å‰éœ€è¦è·å¾—é”</strong></li><li>await æ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”è¿›å…¥ ConditionObject ç­‰å¾…</li><li>await çš„çº¿ç¨‹è¢«å”¤é†’å»é‡æ–°ç«äº‰ lock é”</li><li><strong>çº¿ç¨‹åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«æ‰“æ–­ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸</strong></li><li>ç«äº‰ lock é”æˆåŠŸåï¼Œä» await åç»§ç»­æ‰§è¡Œ</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>    
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„æ¡ä»¶å˜é‡</span>
    <span class="token class-name">Condition</span> condition1 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Condition</span> condition2 <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è¿›å…¥ç­‰å¾…&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//è¿›å…¥ä¼‘æ¯å®¤ç­‰å¾…</span>
            condition1<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è¢«å”¤é†’äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>    
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//å«é†’</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>            
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å”¤é†’</span>
            condition2<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å®ç°åŸç†-2" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†-2"><span>å®ç°åŸç†</span></a></h4><h4 id="await" tabindex="-1"><a class="header-anchor" href="#await"><span>await</span></a></h4><p>æ€»ä½“æµç¨‹æ˜¯å°† await çº¿ç¨‹åŒ…è£…æˆ node èŠ‚ç‚¹æ”¾å…¥ ConditionObject çš„æ¡ä»¶é˜Ÿåˆ—ï¼Œå¦‚æœè¢«å”¤é†’å°±å°† node è½¬ç§»åˆ° AQS çš„æ‰§è¡Œé˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…è·å–é”ï¼Œ<strong>æ¯ä¸ª Condition å¯¹è±¡éƒ½åŒ…å«ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—</strong></p><ul><li>å¼€å§‹ Thread-0 æŒæœ‰é”ï¼Œè°ƒç”¨ awaitï¼Œçº¿ç¨‹è¿›å…¥ ConditionObject ç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­ï¼Œè°ƒç”¨ await æ–¹æ³•çš„çº¿ç¨‹éƒ½æ˜¯æŒé”çŠ¶æ€çš„ï¼Œæ‰€ä»¥è¯´é€»è¾‘é‡Œ<strong>ä¸å­˜åœ¨å¹¶å‘</strong></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
     <span class="token comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œæ˜¯å°±ç›´æ¥ç»™ä¸ªä¸­æ–­å¼‚å¸¸</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å°†è°ƒç”¨ await çš„çº¿ç¨‹åŒ…è£…æˆ Nodeï¼Œæ·»åŠ åˆ°æ¡ä»¶é˜Ÿåˆ—å¹¶è¿”å›</span>
    <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addConditionWaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å®Œå…¨é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”ï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹å”¤é†’å½“å‰çº¿ç¨‹çš„å‰ææ˜¯ã€æŒæœ‰é”ã€‘</span>
    <span class="token keyword">int</span> savedState <span class="token operator">=</span> <span class="token function">fullyRelease</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// è®¾ç½®æ‰“æ–­æ¨¡å¼ä¸ºæ²¡æœ‰è¢«æ‰“æ–­ï¼ŒçŠ¶æ€ç ä¸º 0</span>
    <span class="token keyword">int</span> interruptMode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜»å¡é˜Ÿåˆ—, park é˜»å¡ï¼Œç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isOnSyncQueue</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœè¢«æ‰“æ–­ï¼Œé€€å‡ºç­‰å¾…é˜Ÿåˆ—ï¼Œå¯¹åº”çš„ node ã€ä¹Ÿä¼šè¢«è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—ã€‘å°¾éƒ¨ï¼ŒçŠ¶æ€è®¾ç½®ä¸º 0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>interruptMode <span class="token operator">=</span> <span class="token function">checkInterruptWhileWaiting</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹é€€å‡ºç­‰å¾…é˜Ÿåˆ—ï¼Œè¿›å…¥ã€é˜»å¡é˜Ÿåˆ—ã€‘</span>
    
    <span class="token comment">// å°è¯•æªé”ï¼Œé‡Šæ”¾äº†å¤šå°‘é”å°±ã€é‡æ–°è·å–å¤šå°‘é”ã€‘ï¼Œè·å–é”æˆåŠŸåˆ¤æ–­æ‰“æ–­æ¨¡å¼</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">acquireQueued</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> savedState<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> interruptMode <span class="token operator">!=</span> <span class="token constant">THROW_IE</span><span class="token punctuation">)</span>
        interruptMode <span class="token operator">=</span> <span class="token constant">REINTERRUPT</span><span class="token punctuation">;</span>
    
    <span class="token comment">// node åœ¨æ¡ä»¶é˜Ÿåˆ—æ—¶ å¦‚æœè¢«å¤–éƒ¨çº¿ç¨‹ä¸­æ–­å”¤é†’ï¼Œä¼šåŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä½†æ˜¯å¹¶æœªè®¾ nextWaiter = null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nextWaiter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token comment">// æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆçš„ Node</span>
        <span class="token function">unlinkCancelledWaiters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜æŒ‚èµ·æœŸé—´å‘ç”Ÿè¿‡ä¸­æ–­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptMode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">// åº”ç”¨æ‰“æ–­æ¨¡å¼</span>
        <span class="token function">reportInterruptAfterWait</span><span class="token punctuation">(</span>interruptMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶é‡æ–°è®¾ç½®æ‰“æ–­çŠ¶æ€</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">REINTERRUPT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶æŠ›å‡ºå¼‚å¸¸</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">THROW_IE</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-æ¡ä»¶å˜é‡1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><strong>åˆ›å»ºæ–°çš„ Node çŠ¶æ€ä¸º -2ï¼ˆNode.CONDITIONï¼‰</strong>ï¼Œå…³è” Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">addConditionWaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–å½“å‰æ¡ä»¶é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œä¿å­˜åˆ°å±€éƒ¨å˜é‡ t ä¸­</span>
    <span class="token class-name">Node</span> t <span class="token operator">=</span> lastWaiter<span class="token punctuation">;</span>
    <span class="token comment">// å½“å‰é˜Ÿåˆ—ä¸­ä¸æ˜¯ç©ºï¼Œå¹¶ä¸”èŠ‚ç‚¹çš„çŠ¶æ€ä¸æ˜¯ CONDITIONï¼ˆ-2ï¼‰ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å‘ç”Ÿäº†ä¸­æ–­</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">CONDITION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆçš„ Node</span>
        <span class="token function">unlinkCancelledWaiters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¸…ç†å®Œæˆé‡æ–°è·å– å°¾èŠ‚ç‚¹ çš„å¼•ç”¨</span>
        t <span class="token operator">=</span> lastWaiter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// åˆ›å»ºä¸€ä¸ªå…³è”å½“å‰çº¿ç¨‹çš„æ–° node, è®¾ç½®çŠ¶æ€ä¸º CONDITION(-2)ï¼Œæ·»åŠ è‡³é˜Ÿåˆ—å°¾éƒ¨</span>
    <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">CONDITION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        firstWaiter <span class="token operator">=</span> node<span class="token punctuation">;</span>		<span class="token comment">// ç©ºé˜Ÿåˆ—ç›´æ¥æ”¾åœ¨é˜Ÿé¦–ã€ä¸ç”¨CASå› ä¸ºæ‰§è¡Œçº¿ç¨‹æ˜¯æŒé”çº¿ç¨‹ï¼Œå¹¶å‘å®‰å…¨ã€‘</span>
    <span class="token keyword">else</span>
        t<span class="token punctuation">.</span>nextWaiter <span class="token operator">=</span> node<span class="token punctuation">;</span>	<span class="token comment">// éç©ºé˜Ÿåˆ—é˜Ÿå°¾è¿½åŠ </span>
    lastWaiter <span class="token operator">=</span> node<span class="token punctuation">;</span>			<span class="token comment">// æ›´æ–°é˜Ÿå°¾çš„å¼•ç”¨</span>
    <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆï¼ˆä¸æ˜¯CONDITIONï¼‰çš„ nodeï¼Œã€é“¾è¡¨åˆ é™¤çš„é€»è¾‘ã€‘</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unlinkCancelledWaiters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»å¤´èŠ‚ç‚¹å¼€å§‹éå†ã€FIFOã€‘</span>
    <span class="token class-name">Node</span> t <span class="token operator">=</span> firstWaiter<span class="token punctuation">;</span>
    <span class="token comment">// æŒ‡å‘æ­£å¸¸çš„ CONDITION èŠ‚ç‚¹</span>
    <span class="token class-name">Node</span> trail <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// ç­‰å¾…é˜Ÿåˆ—ä¸ç©º</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span>
        <span class="token class-name">Node</span> next <span class="token operator">=</span> t<span class="token punctuation">.</span>nextWaiter<span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­ t èŠ‚ç‚¹æ˜¯ä¸æ˜¯ CONDITION èŠ‚ç‚¹ï¼Œæ¡ä»¶é˜Ÿåˆ—å†…ä¸æ˜¯ CONDITION å°±ä¸æ˜¯æ­£å¸¸çš„</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">CONDITION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token comment">// ä¸æ˜¯æ­£å¸¸èŠ‚ç‚¹ï¼Œéœ€è¦ t ä¸ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ–­å¼€</span>
            t<span class="token punctuation">.</span>nextWaiter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜éå†åˆ°çš„èŠ‚ç‚¹è¿˜æœªç¢°åˆ°è¿‡æ­£å¸¸èŠ‚ç‚¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>trail <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token comment">// æ›´æ–° firstWaiter æŒ‡é’ˆä¸ºä¸‹ä¸ªèŠ‚ç‚¹</span>
                firstWaiter <span class="token operator">=</span> next<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token comment">// è®©ä¸Šä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹æŒ‡å‘ å½“å‰å–æ¶ˆèŠ‚ç‚¹çš„ ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œã€åˆ é™¤éæ­£å¸¸çš„èŠ‚ç‚¹ã€‘</span>
                trail<span class="token punctuation">.</span>nextWaiter <span class="token operator">=</span> next<span class="token punctuation">;</span>
            <span class="token comment">// t æ˜¯å°¾èŠ‚ç‚¹äº†ï¼Œæ›´æ–° lastWaiter æŒ‡å‘æœ€åä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                lastWaiter <span class="token operator">=</span> trail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// trail æŒ‡å‘çš„æ˜¯æ­£å¸¸èŠ‚ç‚¹ </span>
            trail <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æŠŠ t.next èµ‹å€¼ç»™ tï¼Œå¾ªç¯éå†</span>
        t <span class="token operator">=</span> next<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ¥ä¸‹æ¥ Thread-0 è¿›å…¥ AQS çš„ fullyRelease æµç¨‹ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// çº¿ç¨‹å¯èƒ½é‡å…¥ï¼Œéœ€è¦å°† state å…¨éƒ¨é‡Šæ”¾</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">fullyRelease</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å®Œå…¨é‡Šæ”¾é”æ˜¯å¦æˆåŠŸï¼Œfalse ä»£è¡¨æˆåŠŸ</span>
    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰çº¿ç¨‹æ‰€æŒæœ‰çš„ state å€¼æ€»æ•°</span>
        <span class="token keyword">int</span> savedState <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// release -&gt; tryRelease è§£é”é‡å…¥é”</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">release</span><span class="token punctuation">(</span>savedState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// é‡Šæ”¾æˆåŠŸ</span>
            failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// è¿”å›è§£é”çš„æ·±åº¦</span>
            <span class="token keyword">return</span> savedState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// è§£é”å¤±è´¥æŠ›å‡ºå¼‚å¸¸</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ²¡æœ‰é‡Šæ”¾æˆåŠŸï¼Œå°†å½“å‰ node è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            node<span class="token punctuation">.</span>waitStatus <span class="token operator">=</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">CANCELLED</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>fullyRelease ä¸­ä¼š unpark AQS é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç«äº‰é”ï¼Œå‡è®¾ Thread-1 ç«äº‰æˆåŠŸ <img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantLock-æ¡ä»¶å˜é‡2.png" alt="" loading="lazy"></li><li>Thread-0 è¿›å…¥ isOnSyncQueue é€»è¾‘åˆ¤æ–­èŠ‚ç‚¹<strong>æ˜¯å¦ç§»åŠ¨åˆ°é˜»å¡é˜Ÿåˆ—</strong>ï¼Œæ²¡æœ‰å°± park é˜»å¡ Thread-0</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">isOnSyncQueue</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// node çš„çŠ¶æ€æ˜¯ CONDITIONï¼Œsignal æ–¹æ³•æ˜¯å…ˆä¿®æ”¹çŠ¶æ€å†è¿ç§»ï¼Œæ‰€ä»¥å‰é©±èŠ‚ç‚¹ä¸ºç©ºè¯æ˜è¿˜ã€æ²¡æœ‰å®Œæˆè¿ç§»ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>waitStatus <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">CONDITION</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>prev <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// è¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»æˆåŠŸå…¥é˜Ÿåˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä¸”å½“å‰èŠ‚ç‚¹åé¢å·²ç»æœ‰å…¶å®ƒ nodeï¼Œå› ä¸ºæ¡ä»¶é˜Ÿåˆ—çš„ next æŒ‡é’ˆä¸º null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>next <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token comment">// è¯´æ˜ã€å¯èƒ½åœ¨é˜»å¡é˜Ÿåˆ—ï¼Œä½†æ˜¯æ˜¯å°¾èŠ‚ç‚¹ã€‘</span>
    <span class="token comment">// ä»é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹å¼€å§‹å‘å‰ã€éå†æŸ¥æ‰¾ nodeã€‘ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°è¿”å› trueï¼ŒæŸ¥æ‰¾ä¸åˆ°è¿”å› false</span>
    <span class="token keyword">return</span> <span class="token function">findNodeFromTail</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>await çº¿ç¨‹ park åå¦‚æœè¢« unpark æˆ–è€…è¢«æ‰“æ–­ï¼Œéƒ½ä¼šè¿›å…¥ checkInterruptWhileWaiting åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼š<strong>åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«æ‰“æ–­çš„çº¿ç¨‹éœ€è¦æŠ›å‡ºå¼‚å¸¸</strong></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">checkInterruptWhileWaiting</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Thread.interrupted() è¿”å›å½“å‰çº¿ç¨‹ä¸­æ–­æ ‡è®°ä½ï¼Œå¹¶ä¸”é‡ç½®å½“å‰æ ‡è®°ä½ ä¸º false</span>
    <span class="token comment">// å¦‚æœè¢«ä¸­æ–­äº†ï¼Œæ ¹æ®æ˜¯å¦åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«ä¸­æ–­çš„ï¼Œè®¾ç½®ä¸­æ–­çŠ¶æ€ç </span>
    <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token punctuation">(</span><span class="token function">transferAfterCancelledWait</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">THROW_IE</span> <span class="token operator">:</span> <span class="token constant">REINTERRUPT</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// è¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨çº¿ç¨‹æ˜¯è¢«æ‰“æ–­å”¤é†’æ—¶æ‰ä¼šè°ƒç”¨</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">transferAfterCancelledWait</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰nodeä¸€å®šæ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—å†…ï¼Œå› ä¸º signal è¿ç§»èŠ‚ç‚¹åˆ°é˜»å¡é˜Ÿåˆ—æ—¶ï¼Œä¼šå°†èŠ‚ç‚¹çš„çŠ¶æ€ä¿®æ”¹ä¸º 0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">CONDITION</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æŠŠã€ä¸­æ–­å”¤é†’çš„ node åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ã€‘</span>
        <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¡¨ç¤ºæ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—å†…è¢«ä¸­æ–­äº†ï¼Œè®¾ç½®ä¸º THROW_IE ä¸º -1</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//æ‰§è¡Œåˆ°è¿™é‡Œçš„æƒ…å†µï¼š</span>
    <span class="token comment">//1.å½“å‰nodeå·²ç»è¢«å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ signal æ–¹æ³•å°†å…¶è¿ç§»åˆ° é˜»å¡é˜Ÿåˆ— å†…äº†</span>
    <span class="token comment">//2.å½“å‰nodeæ­£åœ¨è¢«å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ signal æ–¹æ³•å°†å…¶è¿ç§»è‡³ é˜»å¡é˜Ÿåˆ— è¿›è¡Œä¸­çŠ¶æ€</span>
    
    <span class="token comment">// å¦‚æœå½“å‰çº¿ç¨‹è¿˜æ²¡åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä¸€ç›´é‡Šæ”¾ CPU</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isOnSyncQueue</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è¡¨ç¤ºå½“å‰èŠ‚ç‚¹è¢«ä¸­æ–­å”¤é†’æ—¶ä¸åœ¨æ¡ä»¶é˜Ÿåˆ—äº†ï¼Œè®¾ç½®ä¸º REINTERRUPT ä¸º 1</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æœ€åå¼€å§‹å¤„ç†ä¸­æ–­çŠ¶æ€ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">reportInterruptAfterWait</span><span class="token punctuation">(</span><span class="token keyword">int</span> interruptMode<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜ã€åœ¨æ¡ä»¶é˜Ÿåˆ—å†…å‘ç”Ÿè¿‡ä¸­æ–­ï¼Œæ­¤æ—¶ await æ–¹æ³•æŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptMode <span class="token operator">==</span> <span class="token constant">THROW_IE</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜ã€åœ¨æ¡ä»¶é˜Ÿåˆ—å¤–å‘ç”Ÿçš„ä¸­æ–­ï¼Œæ­¤æ—¶è®¾ç½®å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ä½ä¸º trueã€‘</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptMode <span class="token operator">==</span> <span class="token constant">REINTERRUPT</span><span class="token punctuation">)</span>
        <span class="token comment">// è¿›è¡Œä¸€æ¬¡è‡ªå·±æ‰“æ–­ï¼Œäº§ç”Ÿä¸­æ–­çš„æ•ˆæœ</span>
        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="signal" tabindex="-1"><a class="header-anchor" href="#signal"><span>signal</span></a></h4><ul><li>å‡è®¾ Thread-1 è¦æ¥å”¤é†’ Thread-0ï¼Œè¿›å…¥ ConditionObject çš„ doSignal æµç¨‹ï¼Œ<strong>å–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Node</strong>ï¼Œå³ Thread-0 æ‰€åœ¨ Nodeï¼Œå¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…çº¿ç¨‹å®‰å…¨</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­è°ƒç”¨ signal æ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦æ˜¯ç‹¬å é”æŒæœ‰çº¿ç¨‹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–æ¡ä»¶é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Node</span>
    <span class="token class-name">Node</span> first <span class="token operator">=</span> firstWaiter<span class="token punctuation">;</span>
    <span class="token comment">// ä¸ä¸ºç©ºå°±å°†ç¬¬è¯¥èŠ‚ç‚¹ã€è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token function">doSignal</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// å”¤é†’ - ã€å°†æ²¡å–æ¶ˆçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—å°¾éƒ¨ã€‘</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doSignal</span><span class="token punctuation">(</span><span class="token class-name">Node</span> first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ nullï¼Œå½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹äº†ï¼Œé˜Ÿåˆ—ä¸­åªæœ‰å½“å‰ä¸€ä¸ªèŠ‚ç‚¹äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>firstWaiter <span class="token operator">=</span> first<span class="token punctuation">.</span>nextWaiter<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            lastWaiter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        first<span class="token punctuation">.</span>nextWaiter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ Node è½¬ç§»è‡³ AQS é˜Ÿåˆ—ï¼Œä¸æˆåŠŸä¸”è¿˜æœ‰èŠ‚ç‚¹åˆ™ç»§ç»­å¾ªç¯</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">transferForSignal</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>first <span class="token operator">=</span> firstWaiter<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// signalAll() ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå”¤é†’æ‰€æœ‰çš„èŠ‚ç‚¹</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doSignalAll</span><span class="token punctuation">(</span><span class="token class-name">Node</span> first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lastWaiter <span class="token operator">=</span> firstWaiter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> next <span class="token operator">=</span> first<span class="token punctuation">.</span>nextWaiter<span class="token punctuation">;</span>
        first<span class="token punctuation">.</span>nextWaiter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">transferForSignal</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span><span class="token punctuation">;</span>
        first <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token comment">// å”¤é†’æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œéƒ½æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ä¸­</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>first <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ‰§è¡Œ transferForSignalï¼Œ<strong>å…ˆå°†èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º 0ï¼Œç„¶ååŠ å…¥ AQS é˜»å¡é˜Ÿåˆ—å°¾éƒ¨</strong>ï¼Œå°† Thread-3 çš„ waitStatus æ”¹ä¸º -1</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// å¦‚æœèŠ‚ç‚¹çŠ¶æ€æ˜¯å–æ¶ˆ, è¿”å› false è¡¨ç¤ºè½¬ç§»å¤±è´¥, å¦åˆ™è½¬ç§»æˆåŠŸ</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">transferForSignal</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// CAS ä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä¿®æ”¹ä¸º 0ï¼Œå› ä¸ºå½“å‰èŠ‚ç‚¹é©¬ä¸Šè¦è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº†</span>
    <span class="token comment">// å¦‚æœçŠ¶æ€å·²ç»ä¸æ˜¯ CONDITION, è¯´æ˜çº¿ç¨‹è¢«å–æ¶ˆï¼ˆawait é‡Šæ”¾å…¨éƒ¨é”å¤±è´¥ï¼‰æˆ–è€…è¢«ä¸­æ–­ï¼ˆå¯æ‰“æ–­ cancelAcquireï¼‰</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">CONDITION</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// è¿”å›å‡½æ•°è°ƒç”¨å¤„ç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ã€å…ˆæ”¹çŠ¶æ€ï¼Œå†è¿›è¡Œè¿ç§»ã€‘</span>
    <span class="token comment">// å°†å½“å‰ node å…¥é˜»å¡é˜Ÿåˆ—ï¼Œp æ˜¯å½“å‰èŠ‚ç‚¹åœ¨é˜»å¡é˜Ÿåˆ—çš„ã€å‰é©±èŠ‚ç‚¹ã€‘</span>
    <span class="token class-name">Node</span> p <span class="token operator">=</span> <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ws <span class="token operator">=</span> p<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
    
    <span class="token comment">// å¦‚æœå‰é©±èŠ‚ç‚¹è¢«å–æ¶ˆæˆ–è€…ä¸èƒ½è®¾ç½®çŠ¶æ€ä¸º Node.SIGNALï¼Œå°± unpark å–æ¶ˆå½“å‰èŠ‚ç‚¹çº¿ç¨‹çš„é˜»å¡çŠ¶æ€, </span>
    <span class="token comment">// è®© thread-0 çº¿ç¨‹ç«äº‰é”ï¼Œé‡æ–°åŒæ­¥çŠ¶æ€</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-æ¡ä»¶å˜é‡3.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>Thread-1 é‡Šæ”¾é”ï¼Œè¿›å…¥ unlock æµç¨‹</li></ul><h2 id="readwrite" tabindex="-1"><a class="header-anchor" href="#readwrite"><span>ReadWrite</span></a></h2><h3 id="è¯»å†™é”" tabindex="-1"><a class="header-anchor" href="#è¯»å†™é”"><span>è¯»å†™é”</span></a></h3><p>ç‹¬å é”ï¼šæŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ï¼Œå¯¹ ReentrantLock å’Œ Synchronized è€Œè¨€éƒ½æ˜¯ç‹¬å é”</p><p>å…±äº«é”ï¼šæŒ‡è¯¥é”å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹é”æŒæœ‰</p><p>ReentrantReadWriteLock å…¶<strong>è¯»é”æ˜¯å…±äº«é”ï¼Œå†™é”æ˜¯ç‹¬å é”</strong></p><p>ä½œç”¨ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä¸ºäº†æ»¡è¶³å¹¶å‘é‡ï¼Œè¯»å–å…±äº«èµ„æºåº”è¯¥åŒæ—¶è¿›è¡Œï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™</p><p>ä½¿ç”¨è§„åˆ™ï¼š</p><ul><li>åŠ é”è§£é”æ ¼å¼ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>r<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¸´ç•ŒåŒº</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è¯»-è¯»èƒ½å…±å­˜ã€è¯»-å†™ä¸èƒ½å…±å­˜ã€å†™-å†™ä¸èƒ½å…±å­˜</li><li>è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡</li><li><strong>é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒ</strong>ï¼šæŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ä¼šå¯¼è‡´è·å–å†™é”æ°¸ä¹…ç­‰å¾…ï¼Œéœ€è¦å…ˆé‡Šæ”¾è¯»ï¼Œå†å»è·å¾—å†™é”</li><li><strong>é‡å…¥æ—¶é™çº§æ”¯æŒ</strong>ï¼šæŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”ï¼Œé€ æˆåªæœ‰å½“å‰çº¿ç¨‹ä¼šæŒæœ‰è¯»é”ï¼Œå› ä¸ºå†™é”ä¼šäº’æ–¥å…¶ä»–çš„é”</li><li>ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰äº†è¯»é”ï¼Œæ­¤æ—¶ç¬¬äºŒä¸ªçº¿ç¨‹å»è·å–å†™é”ä¼šå¤±è´¥ï¼Œç¬¬ä¸‰ä¸ªçº¿ç¨‹ï¼ˆåœ¨ç¬¬äºŒä¸ªçº¿ç¨‹ä¹‹åï¼‰å»è·å–è¯»é”ä¹Ÿä¼šå¤±è´¥ï¼Œå› ä¸ºå†™é”çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œ<strong>å¦‚æœä¸è¿™æ ·å¯èƒ½ä¼šå¯¼è‡´å†™é”ä¸€ç›´æ— æ³•è·å–</strong></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    r<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// é™çº§ä¸ºè¯»é”, é‡Šæ”¾å†™é”, è¿™æ ·èƒ½å¤Ÿè®©å…¶å®ƒçº¿ç¨‹è¯»å–ç¼“å­˜</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span><span class="token punctuation">{</span>
    	w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è¦åœ¨å†™é”é‡Šæ”¾ä¹‹å‰è·å–è¯»é”</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span><span class="token punctuation">{</span>
	r<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ„é€ æ–¹æ³•ï¼š</p><ul><li><code>public ReentrantReadWriteLock()</code>ï¼šé»˜è®¤æ„é€ æ–¹æ³•ï¼Œéå…¬å¹³é”</li><li><code>public ReentrantReadWriteLock(boolean fair)</code>ï¼štrue ä¸ºå…¬å¹³é”</li></ul><p>å¸¸ç”¨APIï¼š</p><ul><li><code>public ReentrantReadWriteLock.ReadLock readLock()</code>ï¼šè¿”å›è¯»é”</li><li><code>public ReentrantReadWriteLock.WriteLock writeLock()</code>ï¼šè¿”å›å†™é”</li><li><code>public void lock()</code>ï¼šåŠ é”</li><li><code>public void unlock()</code>ï¼šè§£é”</li><li><code>public boolean tryLock()</code>ï¼šå°è¯•è·å–é”</li></ul><p>è¯»è¯»å¹¶å‘ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReentrantReadWriteLock</span> rw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span> r <span class="token operator">=</span> rw<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> w <span class="token operator">=</span> rw<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread 1 running &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread 2 running &quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç¼“å­˜åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜åº”ç”¨"><span>ç¼“å­˜åº”ç”¨</span></a></h3><p>ç¼“å­˜æ›´æ–°æ—¶ï¼Œæ˜¯å…ˆæ¸…ç¼“å­˜è¿˜æ˜¯å…ˆæ›´æ–°æ•°æ®åº“</p><ul><li>å…ˆæ¸…ç¼“å­˜ï¼šå¯èƒ½é€ æˆåˆšæ¸…ç†ç¼“å­˜è¿˜æ²¡æœ‰æ›´æ–°æ•°æ®åº“ï¼Œçº¿ç¨‹ç›´æ¥æŸ¥è¯¢äº†æ•°æ®åº“æ›´æ–°è¿‡æœŸæ•°æ®åˆ°ç¼“å­˜</li><li>å…ˆæ›´æ–°æ®åº“ï¼šå¯èƒ½é€ æˆåˆšæ›´æ–°æ•°æ®åº“ï¼Œè¿˜æ²¡æ¸…ç©ºç¼“å­˜å°±æœ‰çº¿ç¨‹ä»ç¼“å­˜æ‹¿åˆ°äº†æ—§æ•°æ®</li><li>è¡¥å……æƒ…å†µï¼šæŸ¥è¯¢çº¿ç¨‹ A æŸ¥è¯¢æ•°æ®æ—¶æ°å¥½ç¼“å­˜æ•°æ®ç”±äºæ—¶é—´åˆ°æœŸå¤±æ•ˆï¼Œæˆ–æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è¯¢ <img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantReadWriteLockç¼“å­˜.png" alt="" loading="lazy"></li></ul><p>å¯ä»¥ä½¿ç”¨è¯»å†™é”è¿›è¡Œæ“ä½œ</p><h3 id="å®ç°åŸç†-3" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†-3"><span>å®ç°åŸç†</span></a></h3><h4 id="æˆå‘˜å±æ€§" tabindex="-1"><a class="header-anchor" href="#æˆå‘˜å±æ€§"><span>æˆå‘˜å±æ€§</span></a></h4><p>è¯»å†™é”ç”¨çš„æ˜¯åŒä¸€ä¸ª Sycn åŒæ­¥å™¨ï¼Œå› æ­¤ç­‰å¾…é˜Ÿåˆ—ã€state ç­‰ä¹Ÿæ˜¯åŒä¸€ä¸ªï¼ŒåŸç†ä¸ ReentrantLock åŠ é”ç›¸æ¯”æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„ï¼Œä¸åŒæ˜¯<strong>å†™é”çŠ¶æ€å äº† state çš„ä½ 16 ä½ï¼Œè€Œè¯»é”ä½¿ç”¨çš„æ˜¯ state çš„é«˜ 16 ä½</strong></p><ul><li>è¯»å†™é”ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span> readerLock<span class="token punctuation">;</span>		
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> writerLock<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ„é€ æ–¹æ³•ï¼šé»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œå¯ä»¥æŒ‡å®šå‚æ•°åˆ›å»ºå…¬å¹³é”</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// true ä¸ºå…¬å¹³é”</span>
    sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿™ä¸¤ä¸ª lock å…±äº«åŒä¸€ä¸ª sync å®ä¾‹ï¼Œéƒ½æ˜¯ç”± ReentrantReadWriteLock çš„ sync æä¾›åŒæ­¥å®ç°</span>
    readerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    writerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Sync ç±»çš„å±æ€§ï¼š</p><ul><li>ç»Ÿè®¡å˜é‡ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// ç”¨æ¥ç§»ä½</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SHARED_SHIFT</span>   <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
<span class="token comment">// é«˜16ä½çš„1</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SHARED_UNIT</span>    <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHARED_SHIFT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 65535ï¼Œ16ä¸ª1ï¼Œä»£è¡¨å†™é”çš„æœ€å¤§é‡å…¥æ¬¡æ•°</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_COUNT</span>      <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHARED_SHIFT</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// ä½16ä½æ©ç ï¼š0b 1111 1111 1111 1111ï¼Œç”¨æ¥è·å–å†™é”é‡å…¥çš„æ¬¡æ•°</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">EXCLUSIVE_MASK</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHARED_SHIFT</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è·å–è¯»å†™é”çš„æ¬¡æ•°ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// è·å–è¯»å†™é”çš„è¯»é”åˆ†é…çš„æ€»æ¬¡æ•°</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">sharedCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>    <span class="token punctuation">{</span> <span class="token keyword">return</span> c <span class="token operator">&gt;&gt;&gt;</span> <span class="token constant">SHARED_SHIFT</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// å†™é”ï¼ˆç‹¬å ï¼‰é”çš„é‡å…¥æ¬¡æ•°</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> c <span class="token operator">&amp;</span> <span class="token constant">EXCLUSIVE_MASK</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å†…éƒ¨ç±»ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// è®°å½•è¯»é”çº¿ç¨‹è‡ªå·±çš„æŒæœ‰è¯»é”çš„æ•°é‡ï¼ˆé‡å…¥æ¬¡æ•°ï¼‰ï¼Œå› ä¸º state é«˜16ä½è®°å½•çš„æ˜¯å…¨å±€èŒƒå›´å†…æ‰€æœ‰çš„è¯»çº¿ç¨‹è·å–è¯»é”çš„æ€»é‡</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HoldCounter</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// Use id, not reference, to avoid garbage retention</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> tid <span class="token operator">=</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// çº¿ç¨‹å®‰å…¨çš„å­˜æ”¾çº¿ç¨‹å„è‡ªçš„ HoldCounter å¯¹è±¡</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalHoldCounter</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token class-name">HoldCounter</span>\<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">HoldCounter</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HoldCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å†…éƒ¨ç±»å®ä¾‹ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// å½“å‰çº¿ç¨‹æŒæœ‰çš„å¯é‡å…¥è¯»é”çš„æ•°é‡ï¼Œè®¡æ•°ä¸º 0 æ—¶åˆ é™¤</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">ThreadLocalHoldCounter</span> readHolds<span class="token punctuation">;</span>
<span class="token comment">// è®°å½•æœ€åä¸€ä¸ªè·å–ã€è¯»é”ã€‘çº¿ç¨‹çš„ HoldCounter å¯¹è±¡</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">HoldCounter</span> cachedHoldCounter<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>é¦–æ¬¡è·å–é”ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Thread</span> firstReader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// è®°å½•è¯¥çº¿ç¨‹æŒæœ‰çš„è¯»é”æ¬¡æ•°ï¼ˆè¯»é”é‡å…¥æ¬¡æ•°ï¼‰</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">int</span> firstReaderHoldCount<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Sync æ„é€ æ–¹æ³•ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    readHolds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalHoldCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç¡®ä¿å…¶ä»–çº¿ç¨‹çš„æ•°æ®å¯è§æ€§ï¼Œstate æ˜¯ volatile ä¿®é¥°çš„å˜é‡ï¼Œé‡å†™è¯¥å€¼ä¼šå°†çº¿ç¨‹æœ¬åœ°ç¼“å­˜æ•°æ®ã€åŒæ­¥è‡³ä¸»å­˜ã€‘</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åŠ é”åŸç†" tabindex="-1"><a class="header-anchor" href="#åŠ é”åŸç†"><span>åŠ é”åŸç†</span></a></h4><ul><li>t1 çº¿ç¨‹ï¼šw.lockï¼ˆ<strong>å†™é”</strong>ï¼‰ï¼ŒæˆåŠŸä¸Šé” state = 0_1</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// lock()  -&gt; sync.acquire(1);</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°è¯•è·å¾—å†™é”ï¼Œè·å¾—å†™é”å¤±è´¥ï¼Œå°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼ </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å¾—ä½ 16 ä½, ä»£è¡¨å†™é”çš„ state è®¡æ•°</span>
    <span class="token keyword">int</span> w <span class="token operator">=</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¯´æ˜æœ‰è¯»é”æˆ–è€…å†™é”</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// c != 0 and w == 0 è¡¨ç¤ºæœ‰è¯»é”ï¼Œã€è¯»é”ä¸èƒ½å‡çº§ã€‘ï¼Œç›´æ¥è¿”å› false</span>
        <span class="token comment">// w != 0 è¯´æ˜æœ‰å†™é”ï¼Œå†™é”çš„æ‹¥æœ‰è€…ä¸æ˜¯è‡ªå·±ï¼Œè·å–å¤±è´¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> current <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        
        <span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œåªæœ‰ä¸€ç§æƒ…å†µï¼šã€å†™é”é‡å…¥ã€‘ï¼Œæ‰€ä»¥ä¸‹é¢å‡ è¡Œä»£ç ä¸å­˜åœ¨å¹¶å‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">+</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token constant">MAX_COUNT</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å†™é”é‡å…¥, è·å¾—é”æˆåŠŸï¼Œæ²¡æœ‰å¹¶å‘ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨ CAS</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>c <span class="token operator">+</span> acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// c == 0ï¼Œè¯´æ˜æ²¡æœ‰ä»»ä½•é”ï¼Œåˆ¤æ–­å†™é”æ˜¯å¦è¯¥é˜»å¡ï¼Œæ˜¯ false å°±å°è¯•è·å–é”ï¼Œå¤±è´¥è¿”å› false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">writerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c <span class="token operator">+</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å¾—é”æˆåŠŸï¼Œè®¾ç½®é”çš„æŒæœ‰çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹</span>
    <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// éå…¬å¹³é” writerShouldBlock æ€»æ˜¯è¿”å› false, æ— éœ€é˜»å¡</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">writerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token comment">// å…¬å¹³é”ä¼šæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰(false)æ‰å»ç«äº‰</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">writerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>t2 r.lockï¼ˆ<strong>è¯»é”</strong>ï¼‰ï¼Œè¿›å…¥ tryAcquireShared æµç¨‹ï¼š</p></li><li><p>è¿”å› -1 è¡¨ç¤ºå¤±è´¥</p></li><li><p>å¦‚æœè¿”å› 0 è¡¨ç¤ºæˆåŠŸ</p></li><li><p>è¿”å›æ­£æ•°è¡¨ç¤ºè¿˜æœ‰å¤šå°‘åç»§èŠ‚ç‚¹æ”¯æŒå…±äº«æ¨¡å¼ï¼Œè¯»å†™é”è¿”å› 1</p></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// tryAcquireShared è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–è¯»é”å¤±è´¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">doAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// å°è¯•ä»¥å…±äº«æ¨¡å¼è·å–</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// exclusiveCount(c) ä»£è¡¨ä½ 16 ä½, å†™é”çš„ stateï¼Œæˆç«‹è¯´æ˜æœ‰çº¿ç¨‹æŒæœ‰å†™é”</span>
    <span class="token comment">// å†™é”çš„æŒæœ‰è€…ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è·å–è¯»é”å¤±è´¥ï¼Œã€å†™é”å…è®¸é™çº§ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> current<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token comment">// é«˜ 16 ä½ï¼Œä»£è¡¨è¯»é”çš„ stateï¼Œå…±äº«é”åˆ†é…å‡ºå»çš„æ€»æ¬¡æ•°</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">sharedCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¯»é”æ˜¯å¦åº”è¯¥é˜»å¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">readerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>	r <span class="token operator">&lt;</span> <span class="token constant">MAX_COUNT</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c <span class="token operator">+</span> <span class="token constant">SHARED_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">// å°è¯•å¢åŠ è¯»é”è®¡æ•°</span>
        <span class="token comment">// åŠ é”æˆåŠŸ</span>
        <span class="token comment">// åŠ é”ä¹‹å‰è¯»é”ä¸º 0ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            firstReader <span class="token operator">=</span> current<span class="token punctuation">;</span>
            firstReaderHoldCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">// ç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹æ˜¯è‡ªå·±å°±å‘ç”Ÿäº†è¯»é”é‡å…¥</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            firstReaderHoldCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// cachedHoldCounter è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹çš„ holdCounter å¯¹è±¡ï¼Œå³æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span>
            <span class="token class-name">HoldCounter</span> rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>
            <span class="token comment">// è¯´æ˜è¿˜æ²¡è®¾ç½® rh</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// è·å–å½“å‰çº¿ç¨‹çš„é”é‡å…¥çš„å¯¹è±¡ï¼Œèµ‹å€¼ç»™ cachedHoldCounter</span>
                cachedHoldCounter <span class="token operator">=</span> rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è¿˜æ²¡é‡å…¥</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rh<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                readHolds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rh<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// é‡å…¥ + 1</span>
            rh<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è¯»é”åŠ é”æˆåŠŸ</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// é€»è¾‘åˆ°è¿™ åº”è¯¥é˜»å¡ï¼Œæˆ–è€… cas åŠ é”å¤±è´¥</span>
    <span class="token comment">// ä¼šä¸æ–­å°è¯• for (;;) è·å–è¯»é”, æ‰§è¡Œè¿‡ç¨‹ä¸­æ— é˜»å¡</span>
    <span class="token keyword">return</span> <span class="token function">fullTryAcquireShared</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// éå…¬å¹³é” readerShouldBlock åå‘å†™é”ä¸€äº›ï¼Œçœ‹ AQS é˜»å¡é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯å†™é”ï¼Œæ˜¯åˆ™é˜»å¡ï¼Œåä¹‹ä¸é˜»å¡</span>
<span class="token comment">// é˜²æ­¢ä¸€ç›´æœ‰è¯»é”çº¿ç¨‹ï¼Œå¯¼è‡´å†™é”çº¿ç¨‹é¥¥é¥¿</span>
<span class="token comment">// true åˆ™è¯¥é˜»å¡, false åˆ™ä¸é˜»å¡</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">readerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">apparentlyFirstQueuedIsExclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">readerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">fullTryAcquireShared</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å½“å‰è¯»é”çº¿ç¨‹æŒæœ‰çš„è¯»é”æ¬¡æ•°å¯¹è±¡</span>
    <span class="token class-name">HoldCounter</span> rh <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¯´æ˜æœ‰çº¿ç¨‹æŒæœ‰å†™é”</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å†™é”ä¸æ˜¯è‡ªå·±åˆ™è·å–é”å¤±è´¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> current<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">readerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ firstReaderï¼Œå½“å‰é”æ˜¯è¯»å¿™ç¢ŒçŠ¶æ€ï¼Œè€Œä¸”å½“å‰çº¿ç¨‹ä¹Ÿæ˜¯è¯»é”é‡å…¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// assert firstReaderHoldCount &gt; 0;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æœ€åä¸€ä¸ªè¯»é”çš„ HoldCounter</span>
                    rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>
                    <span class="token comment">// è¯´æ˜å½“å‰çº¿ç¨‹ä¹Ÿä¸æ˜¯æœ€åä¸€ä¸ªè¯»é”</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// è·å–å½“å‰çº¿ç¨‹çš„ HoldCounter</span>
                        rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜ HoldCounter å¯¹è±¡æ˜¯ä¸Šä¸€æ­¥ä»£ç æ–°å»ºçš„</span>
                        <span class="token comment">// å½“å‰çº¿ç¨‹ä¸æ˜¯é”é‡å…¥ï¼Œåœ¨ readerShouldBlock() è¿”å› true æ—¶éœ€è¦å»æ’é˜Ÿ</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>rh<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                            <span class="token comment">// é˜²æ­¢å†…å­˜æ³„æ¼</span>
                            readHolds<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rh<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è¶Šç•Œåˆ¤æ–­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sharedCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">MAX_COUNT</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¯»é”åŠ é”ï¼Œæ¡ä»¶å†…çš„é€»è¾‘ä¸ tryAcquireShared ç›¸åŒ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c <span class="token operator">+</span> <span class="token constant">SHARED_UNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sharedCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                firstReader <span class="token operator">=</span> current<span class="token punctuation">;</span>
                firstReaderHoldCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                firstReaderHoldCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rh<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    readHolds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rh<span class="token punctuation">)</span><span class="token punctuation">;</span>
                rh<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
                cachedHoldCounter <span class="token operator">=</span> rh<span class="token punctuation">;</span> <span class="token comment">// cache for release</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è·å–è¯»é”å¤±è´¥ï¼Œè¿›å…¥ sync.doAcquireShared(1) æµç¨‹å¼€å§‹é˜»å¡ï¼Œé¦–å…ˆä¹Ÿæ˜¯è°ƒç”¨ addWaiter æ·»åŠ èŠ‚ç‚¹ï¼Œä¸åŒä¹‹å¤„åœ¨äºèŠ‚ç‚¹è¢«è®¾ç½®ä¸º Node.SHARED æ¨¡å¼è€Œé Node.EXCLUSIVE æ¨¡å¼ï¼Œæ³¨æ„æ­¤æ—¶ t2 ä»å¤„äºæ´»è·ƒçŠ¶æ€</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºå…±äº«æ¨¡å¼</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SHARED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å–å‰é©±èŠ‚ç‚¹</span>
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¦‚æœå‰é©±èŠ‚ç‚¹å°±å¤´èŠ‚ç‚¹å°±å»å°è¯•è·å–é”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å†ä¸€æ¬¡å°è¯•è·å–è¯»é”</span>
                <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// r &gt;= 0 è¡¨ç¤ºè·å–æˆåŠŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//ã€è¿™é‡Œä¼šè®¾ç½®è‡ªå·±ä¸ºå¤´èŠ‚ç‚¹ï¼Œå”¤é†’ç›¸è¿çš„ååºçš„å…±äº«èŠ‚ç‚¹ã€‘</span>
                    <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span>
                        <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ˜¯å¦åœ¨è·å–è¯»é”å¤±è´¥æ—¶é˜»å¡      					 park å½“å‰çº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œåœ¨ doAcquireShared å†… for (;ğŸ˜‰ å¾ªç¯ä¸€æ¬¡ï¼ŒshouldParkAfterFailedAcquire å†…æŠŠå‰é©±èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º -1ï¼Œå† for (;ğŸ˜‰ å¾ªç¯ä¸€æ¬¡å°è¯• tryAcquireSharedï¼Œä¸æˆåŠŸåœ¨ parkAndCheckInterrupt() å¤„ park <img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantReadWriteLockåŠ é”1.png" alt="" loading="lazy"></p><ul><li>è¿™ç§çŠ¶æ€ä¸‹ï¼Œå‡è®¾åˆæœ‰ t3 r.lockï¼Œt4 w.lockï¼Œè¿™æœŸé—´ t1 ä»ç„¶æŒæœ‰é”ï¼Œå°±å˜æˆäº†ä¸‹é¢çš„æ ·å­ <img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantReadWriteLockåŠ é”2.png" alt="" loading="lazy"></li></ul><h4 id="è§£é”åŸç†" tabindex="-1"><a class="header-anchor" href="#è§£é”åŸç†"><span>è§£é”åŸç†</span></a></h4><ul><li>t1 w.unlockï¼Œ å†™é”è§£é”</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// é‡Šæ”¾é”</span>
    sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°è¯•é‡Šæ”¾é”</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token comment">// å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºå¹¶ä¸”ä¸æ˜¯ç­‰å¾…çŠ¶æ€ä¸æ˜¯ 0ï¼Œå”¤é†’åç»§çš„éå–æ¶ˆèŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> nextc <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> releases<span class="token punctuation">;</span>
    <span class="token comment">// å› ä¸ºå¯é‡å…¥çš„åŸå› , å†™é”è®¡æ•°ä¸º 0, æ‰ç®—é‡Šæ”¾æˆåŠŸ</span>
    <span class="token keyword">boolean</span> free <span class="token operator">=</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>free<span class="token punctuation">)</span>
        <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> free<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å”¤é†’æµç¨‹ sync.unparkSuccessorï¼Œè¿™æ—¶ t2 åœ¨ doAcquireShared çš„ parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œï¼Œç»§ç»­å¾ªç¯ï¼Œæ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€</li><li>æ¥ä¸‹æ¥ t2 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼›è¿˜ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ sharedï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ doReleaseShared() å°† head çš„çŠ¶æ€ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ—¶ t3 åœ¨ doAcquireShared å†… parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œï¼Œ<strong>å”¤é†’è¿ç»­çš„æ‰€æœ‰çš„å…±äº«èŠ‚ç‚¹</strong></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> propagate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span> 
    <span class="token comment">// è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹</span>
    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰ï¼Œä¸º 0 å°±æ²¡æœ‰èµ„æº</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propagate <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> h <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>h <span class="token operator">=</span> head<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>
        <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœå½“å‰æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ã€ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ã€‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span><span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// å”¤é†’åç»§èŠ‚ç‚¹</span>
            <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span>
	<span class="token comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h <span class="token operator">!=</span> tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> ws <span class="token operator">=</span> h<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
            <span class="token comment">// SIGNAL å”¤é†’åç»§</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å› ä¸ºè¯»é”å…±äº«ï¼Œå¦‚æœå…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨é‡Šæ”¾è¯»é”ï¼Œé‚£ä¹ˆéœ€è¦å°† waitStatus å…ˆæ”¹ä¸º 0</span>
            	<span class="token comment">// é˜²æ­¢ unparkSuccessor è¢«å¤šæ¬¡æ‰§è¡Œ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>  
                <span class="token comment">// å”¤é†’åç»§èŠ‚ç‚¹</span>
                <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å¦‚æœå·²ç»æ˜¯ 0 äº†ï¼Œæ”¹ä¸º -3ï¼Œç”¨æ¥è§£å†³ä¼ æ’­æ€§</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">PROPAGATE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>                
        <span class="token punctuation">}</span>
        <span class="token comment">// æ¡ä»¶ä¸æˆç«‹è¯´æ˜è¢«å”¤é†’çš„èŠ‚ç‚¹éå¸¸ç§¯æï¼Œç›´æ¥å°†è‡ªå·±è®¾ç½®ä¸ºäº†æ–°çš„ headï¼Œ</span>
        <span class="token comment">// æ­¤æ—¶å”¤é†’å®ƒçš„èŠ‚ç‚¹ï¼ˆå‰é©±ï¼‰æ‰§è¡Œ h == head ä¸æˆç«‹ï¼Œæ‰€ä»¥ä¸ä¼šè·³å‡ºå¾ªç¯ï¼Œä¼šç»§ç»­å”¤é†’æ–°çš„ head èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> head<span class="token punctuation">)</span>                   
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ReentrantReadWriteLockè§£é”1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ shared äº†ï¼Œå› æ­¤ä¸ä¼šç»§ç»­å”¤é†’ t4 æ‰€åœ¨èŠ‚ç‚¹</li><li>t2 è¯»é”è§£é”ï¼Œè¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œä½†è®¡æ•°è¿˜ä¸ä¸ºé›¶ï¼Œt3 åŒæ ·è®©è®¡æ•°å‡ä¸€ï¼Œè®¡æ•°ä¸ºé›¶ï¼Œè¿›å…¥doReleaseShared() å°†å¤´èŠ‚ç‚¹ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryReleaseShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">-</span> <span class="token constant">SHARED_UNIT</span><span class="token punctuation">;</span>
        <span class="token comment">// è¯»é”çš„è®¡æ•°ä¸ä¼šå½±å“å…¶å®ƒè·å–è¯»é”çº¿ç¨‹, ä½†ä¼šå½±å“å…¶å®ƒè·å–å†™é”çº¿ç¨‹ï¼Œè®¡æ•°ä¸º 0 æ‰æ˜¯çœŸæ­£é‡Šæ”¾</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> nextc<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// è¿”å›æ˜¯å¦å·²ç»å®Œå…¨é‡Šæ”¾äº† </span>
            <span class="token keyword">return</span> nextc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>t4 åœ¨ acquireQueued ä¸­ parkAndCheckInterrupt å¤„æ¢å¤è¿è¡Œï¼Œå†æ¬¡ for (;ğŸ˜‰ è¿™æ¬¡è‡ªå·±æ˜¯å¤´èŠ‚ç‚¹çš„ä¸´èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–èŠ‚ç‚¹ç«äº‰ï¼ŒtryAcquire(1) æˆåŠŸï¼Œä¿®æ”¹å¤´ç»“ç‚¹ï¼Œæµç¨‹ç»“æŸ <img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantReadWriteLockè§£é”2.png" alt="" loading="lazy"></li></ul><h3 id="stamped" tabindex="-1"><a class="header-anchor" href="#stamped"><span>Stamped</span></a></h3><p>StampedLockï¼šè¯»å†™é”ï¼Œè¯¥ç±»è‡ª JDK 8 åŠ å…¥ï¼Œæ˜¯ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–è¯»æ€§èƒ½</p><p>ç‰¹ç‚¹ï¼š</p><ul><li>åœ¨ä½¿ç”¨è¯»é”ã€å†™é”æ—¶éƒ½å¿…é¡»é…åˆæˆ³ä½¿ç”¨</li><li>StampedLock ä¸æ”¯æŒæ¡ä»¶å˜é‡</li><li>StampedLock <strong>ä¸æ”¯æŒé‡å…¥</strong></li></ul><p>åŸºæœ¬ç”¨æ³•</p><ul><li>åŠ è§£è¯»é”ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// ç±»ä¼¼äº unparkï¼Œè§£æŒ‡å®šçš„é”</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åŠ è§£å†™é”ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ä¹è§‚è¯»ï¼ŒStampedLock æ”¯æŒ <code>tryOptimisticRead()</code> æ–¹æ³•ï¼Œè¯»å–å®Œæ¯•ååšä¸€æ¬¡<strong>æˆ³æ ¡éªŒ</strong>ï¼Œå¦‚æœæ ¡éªŒé€šè¿‡ï¼Œè¡¨ç¤ºè¿™æœŸé—´æ²¡æœ‰å…¶ä»–çº¿ç¨‹çš„å†™æ“ä½œï¼Œæ•°æ®å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¦‚æœæ ¡éªŒæ²¡é€šè¿‡ï¼Œéœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// éªŒæˆ³</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// é”å‡çº§</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æä¾›ä¸€ä¸ªæ•°æ®å®¹å™¨ç±»å†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„ read() æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„ write() æ–¹æ³•ï¼š</p><ul><li>è¯»-è¯»å¯ä»¥ä¼˜åŒ–</li><li>è¯»-å†™ä¼˜åŒ–è¯»ï¼Œè¡¥åŠ è¯»é”</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataContainerStamped</span> dataContainer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataContainerStamped</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    	dataContainer<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        dataContainer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">DataContainerStamped</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> data<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StampedLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> readTime<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; optimistic read locking&quot;</span> <span class="token operator">+</span> stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>readTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æˆ³æœ‰æ•ˆï¼Œç›´æ¥è¿”å›æ•°æ®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Sout</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; optimistic read finish...&quot;</span> <span class="token operator">+</span> stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è¯´æ˜å…¶ä»–çº¿ç¨‹æ›´æ”¹äº†æˆ³ï¼Œéœ€è¦é”å‡çº§äº†ï¼Œä»ä¹è§‚è¯»å‡çº§åˆ°è¯»é”</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; updating to read lock&quot;</span> <span class="token operator">+</span> stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; read lock&quot;</span> <span class="token operator">+</span> stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>readTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; read finish...&quot;</span> <span class="token operator">+</span> stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; read unlock &quot;</span> <span class="token operator">+</span>  stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> newData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; write lock &quot;</span> <span class="token operator">+</span> stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> newData<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; write unlock &quot;</span> <span class="token operator">+</span> stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="countdown" tabindex="-1"><a class="header-anchor" href="#countdown"><span>CountDown</span></a></h2><h3 id="åŸºæœ¬ä½¿ç”¨-4" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨-4"><span>åŸºæœ¬ä½¿ç”¨</span></a></h3><p>CountDownLatchï¼šè®¡æ•°å™¨ï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥åä½œï¼Œ<strong>ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ</strong></p><p>æ„é€ å™¨ï¼š</p><ul><li><code>public CountDownLatch(int count)</code>ï¼šåˆå§‹åŒ–å”¤é†’éœ€è¦çš„ down å‡ æ­¥</li></ul><p>å¸¸ç”¨APIï¼š</p><ul><li><code>public void await()</code>ï¼šè®©å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œå¿…é¡» down å®Œåˆå§‹åŒ–çš„æ•°å­—æ‰å¯ä»¥è¢«å”¤é†’ï¼Œå¦åˆ™è¿›å…¥æ— é™ç­‰å¾…</li><li><code>public void countDown()</code>ï¼šè®¡æ•°å™¨è¿›è¡Œå‡ 1ï¼ˆdown 1ï¼‰</li></ul><p>åº”ç”¨ï¼šåŒæ­¥ç­‰å¾…å¤šä¸ª Rest è¿œç¨‹è°ƒç”¨ç»“æŸ</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// LOL 10äººè¿›å…¥æ¸¸æˆå€’è®¡æ—¶</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ExecutorService</span> service <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> all <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> finalJ <span class="token operator">=</span> j<span class="token punctuation">;</span><span class="token comment">//å¸¸é‡</span>
        service<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//éšæœºä¼‘çœ </span>
                all<span class="token punctuation">[</span>finalJ<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token string">&quot;%&quot;</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;\r&quot;</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// \rä»£è¡¨è¦†ç›–</span>
            <span class="token punctuation">}</span>
            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;\næ¸¸æˆå¼€å§‹&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    service<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
[100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%]
æ¸¸æˆå¼€å§‹
</span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®ç°åŸç†-4" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†-4"><span>å®ç°åŸç†</span></a></h3><p>é˜»å¡ç­‰å¾…ï¼š</p><ul><li>çº¿ç¨‹è°ƒç”¨ await() ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆä»»åŠ¡ï¼šæ”¯æŒæ‰“æ–­</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// AbstractQueuedSynchronizer#acquireSharedInterruptibly</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼ŒæŠ›å‡ºæ‰“æ–­å¼‚å¸¸</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å°è¯•è·å–å…±äº«é”ï¼Œæ¡ä»¶æˆç«‹è¯´æ˜ state &gt; 0ï¼Œæ­¤æ—¶çº¿ç¨‹å…¥é˜Ÿé˜»å¡ç­‰å¾…ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹è·å–å…±äº«èµ„æº</span>
    <span class="token comment">// æ¡ä»¶ä¸æˆç«‹è¯´æ˜ state = 0ï¼Œæ­¤æ—¶ä¸éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œç›´æ¥ç»“æŸå‡½æ•°è°ƒç”¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">doAcquireSharedInterruptibly</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// CountDownLatch.Sync#tryAcquireShared</span>
<span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>çº¿ç¨‹è¿›å…¥ AbstractQueuedSynchronizer#doAcquireSharedInterruptibly å‡½æ•°é˜»å¡æŒ‚èµ·ï¼Œç­‰å¾… latch å˜ä¸º 0ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†è°ƒç”¨latch.await()æ–¹æ³•çš„çº¿ç¨‹ åŒ…è£…æˆ SHARED ç±»å‹çš„ node åŠ å…¥åˆ° AQS çš„é˜»å¡é˜Ÿåˆ—ä¸­</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SHARED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹</span>
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å‰é©±èŠ‚ç‚¹æ—¶å¤´èŠ‚ç‚¹å°±å¯ä»¥å°è¯•è·å–é”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å†æ¬¡å°è¯•è·å–é”ï¼Œè·å–æˆåŠŸè¿”å› 1</span>
                <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è·å–é”æˆåŠŸï¼Œè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸º head èŠ‚ç‚¹ï¼Œå¹¶ä¸”å‘åä¼ æ’­</span>
                    <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// é˜»å¡åœ¨è¿™é‡Œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­åæŠ›å‡ºå¼‚å¸¸ï¼Œè¿›å…¥å–æ¶ˆèŠ‚ç‚¹çš„é€»è¾‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è·å–å…±äº«é”æˆåŠŸï¼Œè¿›å…¥å”¤é†’é˜»å¡é˜Ÿåˆ—ä¸­ä¸å¤´èŠ‚ç‚¹ç›¸è¿çš„ SHARED æ¨¡å¼çš„èŠ‚ç‚¹ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> propagate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token comment">// å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„ head èŠ‚ç‚¹ï¼Œå‰é©±èŠ‚ç‚¹å’ŒæŒæœ‰çº¿ç¨‹ç½®ä¸º null</span>
    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// propagate = 1ï¼Œæ¡ä»¶ä¸€æˆç«‹</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propagate <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> h <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> head<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span>
        <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token comment">// å½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹æ—¶ next ä¸º nullï¼Œæˆ–è€…åç»§èŠ‚ç‚¹æ˜¯ SHARED å…±äº«æ¨¡å¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span><span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// å”¤é†’æ‰€æœ‰çš„ç­‰å¾…å…±äº«é”çš„èŠ‚ç‚¹</span>
            <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è®¡æ•°å‡ä¸€ï¼š</p><ul><li>çº¿ç¨‹è¿›å…¥ countDown() å®Œæˆè®¡æ•°å™¨å‡ä¸€ï¼ˆé‡Šæ”¾é”ï¼‰çš„æ“ä½œ</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°è¯•é‡Šæ”¾å…±äº«é”</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryReleaseShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é‡Šæ”¾é”æˆåŠŸå¼€å§‹å”¤é†’é˜»å¡èŠ‚ç‚¹</span>
        <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ›´æ–° state å€¼ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡ï¼Œstate å€¼å‡ä¸€ï¼Œå½“ state -1 æ­£å¥½ä¸º 0 æ—¶ï¼Œè¿”å› true</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å‰é¢ã€å·²ç»æœ‰çº¿ç¨‹è§¦å‘å”¤é†’æ“ä½œã€‘äº†ï¼Œè¿™é‡Œè¿”å› false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¡æ•°å™¨å‡ä¸€</span>
        <span class="token keyword">int</span> nextc <span class="token operator">=</span> c<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> nextc<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// è®¡æ•°å™¨ä¸º 0 æ—¶è¿”å› true</span>
            <span class="token keyword">return</span> nextc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>state = 0 æ—¶ï¼Œå½“å‰çº¿ç¨‹éœ€è¦æ‰§è¡Œ<strong>å”¤é†’é˜»å¡èŠ‚ç‚¹çš„ä»»åŠ¡</strong></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ˜¯ç©ºé˜Ÿåˆ—</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h <span class="token operator">!=</span> tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> ws <span class="token operator">=</span> h<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
            <span class="token comment">// å¤´èŠ‚ç‚¹çš„çŠ¶æ€ä¸º signalï¼Œè¯´æ˜åç»§èŠ‚ç‚¹æ²¡æœ‰è¢«å”¤é†’è¿‡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// cas è®¾ç½®å¤´èŠ‚ç‚¹çš„çŠ¶æ€ä¸º 0ï¼Œè®¾ç½®å¤±è´¥ç»§ç»­è‡ªæ—‹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token comment">// å”¤é†’åç»§èŠ‚ç‚¹</span>
                <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å·²ç»è®¾ç½®äº†å¤´èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œé‡æ–°è®¾ç½®ä¸º PROPAGATE ä¼ æ’­å±æ€§</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">PROPAGATE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ¡ä»¶ä¸æˆç«‹è¯´æ˜è¢«å”¤é†’çš„èŠ‚ç‚¹éå¸¸ç§¯æï¼Œç›´æ¥å°†è‡ªå·±è®¾ç½®ä¸ºäº†æ–°çš„headï¼Œ</span>
        <span class="token comment">// æ­¤æ—¶å”¤é†’å®ƒçš„èŠ‚ç‚¹ï¼ˆå‰é©±ï¼‰æ‰§è¡Œ h == head ä¸æˆç«‹ï¼Œæ‰€ä»¥ä¸ä¼šè·³å‡ºå¾ªç¯ï¼Œä¼šç»§ç»­å”¤é†’æ–°çš„ head èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> head<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="cyclicbarrier" tabindex="-1"><a class="header-anchor" href="#cyclicbarrier"><span>CyclicBarrier</span></a></h2><h3 id="åŸºæœ¬ä½¿ç”¨-5" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨-5"><span>åŸºæœ¬ä½¿ç”¨</span></a></h3><p>CyclicBarrierï¼šå¾ªç¯å±éšœï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åä½œï¼Œç­‰å¾…çº¿ç¨‹æ»¡è¶³æŸä¸ªè®¡æ•°ï¼Œæ‰èƒ½è§¦å‘è‡ªå·±æ‰§è¡Œ</p><p>å¸¸ç”¨æ–¹æ³•ï¼š</p><ul><li><p><code>public CyclicBarrier(int parties, Runnable barrierAction)</code>ï¼šç”¨äºåœ¨çº¿ç¨‹åˆ°è¾¾å±éšœ parties æ—¶ï¼Œæ‰§è¡Œ barrierAction</p></li><li><p>partiesï¼šä»£è¡¨å¤šå°‘ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœå¼€å§‹è§¦å‘çº¿ç¨‹ä»»åŠ¡</p></li><li><p>barrierActionï¼šçº¿ç¨‹ä»»åŠ¡</p></li><li><p><code>public int await()</code>ï¼šçº¿ç¨‹è°ƒç”¨ await æ–¹æ³•é€šçŸ¥ CyclicBarrier æœ¬çº¿ç¨‹å·²ç»åˆ°è¾¾å±éšœ</p></li></ul><p>ä¸ CountDownLatch çš„åŒºåˆ«ï¼šCyclicBarrier æ˜¯å¯ä»¥é‡ç”¨çš„</p><p>åº”ç”¨ï¼šå¯ä»¥å®ç°å¤šçº¿ç¨‹ä¸­ï¼ŒæŸä¸ªä»»åŠ¡åœ¨ç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä»¥åè§¦å‘</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ExecutorService</span> service <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">CyclicBarrier</span> barrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;task1 task2 finish...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å¾ªç¯é‡ç”¨</span>
        service<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;task1 begin...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                barrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2 - 1 = 1</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        service<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;task2 begin...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                barrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1 - 1 = 0</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    service<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®ç°åŸç†-5" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†-5"><span>å®ç°åŸç†</span></a></h3><h4 id="æˆå‘˜å±æ€§-1" tabindex="-1"><a class="header-anchor" href="#æˆå‘˜å±æ€§-1"><span>æˆå‘˜å±æ€§</span></a></h4><ul><li>å…¨å±€é”ï¼šåˆ©ç”¨å¯é‡å…¥é”å®ç°çš„å·¥å…·ç±»</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// barrier å®ç°æ˜¯ä¾èµ–äºConditionæ¡ä»¶é˜Ÿåˆ—ï¼Œcondition æ¡ä»¶é˜Ÿåˆ—å¿…é¡»ä¾èµ–lockæ‰èƒ½ä½¿ç”¨</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// çº¿ç¨‹æŒ‚èµ·å®ç°ä½¿ç”¨çš„ condition é˜Ÿåˆ—ï¼Œå½“å‰ä»£æ‰€æœ‰çº¿ç¨‹åˆ°ä½ï¼Œè¿™ä¸ªæ¡ä»¶é˜Ÿåˆ—å†…çš„çº¿ç¨‹æ‰ä¼šè¢«å”¤é†’</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> trip <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>çº¿ç¨‹æ•°é‡ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> parties<span class="token punctuation">;</span>	<span class="token comment">// ä»£è¡¨å¤šå°‘ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœå¼€å§‹è§¦å‘çº¿ç¨‹ä»»åŠ¡</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>			<span class="token comment">// è¡¨ç¤ºå½“å‰â€œä»£â€è¿˜æœ‰å¤šå°‘ä¸ªçº¿ç¨‹æœªåˆ°ä½ï¼Œåˆå§‹å€¼ä¸º parties</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å½“å‰ä»£ä¸­æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°ä½åè¦æ‰§è¡Œçš„äº‹ä»¶ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Runnable</span> barrierCommand<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>ä»£ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// è¡¨ç¤º barrier å¯¹è±¡å½“å‰ ä»£</span>
<span class="token keyword">private</span> <span class="token class-name">Generation</span> generation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Generation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Generation</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¡¨ç¤ºå½“å‰â€œä»£â€æ˜¯å¦è¢«æ‰“ç ´ï¼Œå¦‚æœè¢«æ‰“ç ´å†æ¥åˆ°è¿™ä¸€ä»£çš„çº¿ç¨‹ å°±ä¼šç›´æ¥æŠ›å‡º BrokenException å¼‚å¸¸</span>
    <span class="token comment">// ä¸”åœ¨è¿™ä¸€ä»£æŒ‚èµ·çš„çº¿ç¨‹éƒ½ä¼šè¢«å”¤é†’ï¼Œç„¶åæŠ›å‡º BrokerException å¼‚å¸¸ã€‚</span>
    <span class="token keyword">boolean</span> broken <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ„é€ æ–¹æ³•ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">CyclicBarrie</span><span class="token punctuation">(</span><span class="token keyword">int</span> parties<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> barrierAction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å› ä¸ºå°äºç­‰äº 0 çš„ barrier æ²¡æœ‰ä»»ä½•æ„ä¹‰</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parties <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>parties <span class="token operator">=</span> parties<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> parties<span class="token punctuation">;</span>
    <span class="token comment">// å¯ä»¥ä¸º null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>barrierCommand <span class="token operator">=</span> barrierAction<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-CyclicBarrierå·¥ä½œåŸç†.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="æˆå‘˜æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#æˆå‘˜æ–¹æ³•"><span>æˆå‘˜æ–¹æ³•</span></a></h4><ul><li>await()ï¼šé˜»å¡ç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°ä½</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">BrokenBarrierException</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">dowait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> toe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>toe<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// cannot happen</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// timedï¼šè¡¨ç¤ºå½“å‰è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦æŒ‡å®šäº†è¶…æ—¶æ—¶é•¿ï¼Œå¦‚æœ true è¡¨ç¤ºçº¿ç¨‹æ˜¯å“åº”è¶…æ—¶çš„</span>
<span class="token comment">// nanosï¼šçº¿ç¨‹ç­‰å¾…è¶…æ—¶æ—¶é•¿ï¼Œå•ä½æ˜¯çº³ç§’</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">dowait</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> timed<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    <span class="token comment">// åŠ é”</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰ä»£</span>
        <span class="token keyword">final</span> <span class="token class-name">Generation</span> g <span class="token operator">=</span> generation<span class="token punctuation">;</span>

        <span class="token comment">// ã€å¦‚æœå½“å‰ä»£æ˜¯å·²ç»è¢«æ‰“ç ´çŠ¶æ€ï¼Œåˆ™å½“å‰è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºBrokenå¼‚å¸¸ã€‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>broken<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BrokenBarrierException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­äº†ï¼Œåˆ™æ‰“ç ´å½“å‰ä»£ï¼Œç„¶åå½“å‰çº¿ç¨‹æŠ›å‡ºä¸­æ–­å¼‚å¸¸</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è®¾ç½®å½“å‰ä»£çš„çŠ¶æ€ä¸º broken çŠ¶æ€ï¼Œå”¤é†’åœ¨ trip æ¡ä»¶é˜Ÿåˆ—å†…çš„çº¿ç¨‹</span>
            <span class="token function">breakBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// é€»è¾‘åˆ°è¿™è¯´æ˜ï¼Œå½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€æ˜¯ falseï¼Œ å½“å‰ä»£çš„ broken ä¸º falseï¼ˆæœªæ‰“ç ´çŠ¶æ€ï¼‰</span>
        
        <span class="token comment">// å‡è®¾ parties ç»™çš„æ˜¯ 5ï¼Œé‚£ä¹ˆindexå¯¹åº”çš„å€¼ä¸º 4,3,2,1,0</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token operator">--</span>count<span class="token punctuation">;</span>
        <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯æœ€åä¸€ä¸ªåˆ°è¾¾ barrier çš„çº¿ç¨‹ï¼Œã€éœ€è¦å¼€å¯æ–°ä»£ï¼Œå”¤é†’é˜»å¡çº¿ç¨‹ã€‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ …æ ä»»åŠ¡å¯åŠ¨æ ‡è®°</span>
            <span class="token keyword">boolean</span> ranAction <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">Runnable</span> command <span class="token operator">=</span> barrierCommand<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token comment">// å¯åŠ¨è§¦å‘çš„ä»»åŠ¡</span>
                    command<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// run()æœªæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œå¯åŠ¨æ ‡è®°è®¾ç½®ä¸º true</span>
                ranAction <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment">// å¼€å¯æ–°çš„ä¸€ä»£ï¼Œè¿™é‡Œä¼šã€å”¤é†’æ‰€æœ‰çš„é˜»å¡é˜Ÿåˆ—ã€‘</span>
                <span class="token function">nextGeneration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è¿”å› 0 å› ä¸ºå½“å‰çº¿ç¨‹æ˜¯æ­¤ä»£æœ€åä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹ï¼Œindex == 0</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœ command.run() æ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œä¼šè¿›å…¥åˆ°è¿™é‡Œ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ranAction<span class="token punctuation">)</span>
                    <span class="token function">breakBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è‡ªæ—‹ï¼Œä¸€ç›´åˆ°æ¡ä»¶æ»¡è¶³ã€å½“å‰ä»£è¢«æ‰“ç ´ã€çº¿ç¨‹è¢«ä¸­æ–­ï¼Œç­‰å¾…è¶…æ—¶</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ ¹æ®æ˜¯å¦éœ€è¦è¶…æ—¶ç­‰å¾…é€‰æ‹©é˜»å¡æ–¹æ³•</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timed<span class="token punctuation">)</span>
                    <span class="token comment">// å½“å‰çº¿ç¨‹é‡Šæ”¾æ‰ lockï¼Œã€è¿›å…¥åˆ° trip æ¡ä»¶é˜Ÿåˆ—çš„å°¾éƒ¨æŒ‚èµ·è‡ªå·±ã€‘ï¼Œç­‰å¾…è¢«å”¤é†’</span>
                    trip<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nanos <span class="token operator">&gt;</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                    nanos <span class="token operator">=</span> trip<span class="token punctuation">.</span><span class="token function">awaitNanos</span><span class="token punctuation">(</span>nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è¢«ä¸­æ–­åæ¥åˆ°è¿™é‡Œçš„é€»è¾‘</span>
                
                <span class="token comment">// å½“å‰ä»£æ²¡æœ‰å˜åŒ–å¹¶ä¸”æ²¡æœ‰è¢«æ‰“ç ´</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>g <span class="token operator">==</span> generation <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>g<span class="token punctuation">.</span>broken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æ‰“ç ´å±éšœ</span>
                    <span class="token function">breakBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// node èŠ‚ç‚¹åœ¨ã€æ¡ä»¶é˜Ÿåˆ—ã€‘å†…æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸</span>
                    <span class="token keyword">throw</span> ie<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ç­‰å¾…è¿‡ç¨‹ä¸­ä»£å˜åŒ–äº†ï¼Œå®Œæˆä¸€æ¬¡è‡ªæˆ‘æ‰“æ–­</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
			<span class="token comment">// å”¤é†’åçš„çº¿ç¨‹ï¼Œã€åˆ¤æ–­å½“å‰ä»£å·²ç»è¢«æ‰“ç ´ï¼Œçº¿ç¨‹å”¤é†’åä¾æ¬¡æŠ›å‡º BrokenBarrier å¼‚å¸¸ã€‘</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>broken<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BrokenBarrierException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// å½“å‰çº¿ç¨‹æŒ‚èµ·æœŸé—´ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹åˆ°ä½äº†ï¼Œç„¶åè§¦å‘äº†å¼€å¯æ–°çš„ä¸€ä»£çš„é€»è¾‘</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>g <span class="token operator">!=</span> generation<span class="token punctuation">)</span>
                <span class="token keyword">return</span> index<span class="token punctuation">;</span>
			<span class="token comment">// å½“å‰çº¿ç¨‹ trip ä¸­ç­‰å¾…è¶…æ—¶ï¼Œç„¶åä¸»åŠ¨è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> nanos <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">breakBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æŠ›å‡ºè¶…æ—¶å¼‚å¸¸</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// è§£é”</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>breakBarrier()ï¼šæ‰“ç ´ Barrier å±éšœ</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">breakBarrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†ä»£ä¸­çš„ broken è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºè¿™ä¸€ä»£æ˜¯è¢«æ‰“ç ´äº†ï¼Œå†æ¥åˆ°è¿™ä¸€ä»£çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸</span>
    generation<span class="token punctuation">.</span>broken <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// é‡ç½® count ä¸º parties</span>
    count <span class="token operator">=</span> parties<span class="token punctuation">;</span>
    <span class="token comment">// å°†åœ¨tripæ¡ä»¶é˜Ÿåˆ—å†…æŒ‚èµ·çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’ï¼Œå”¤é†’åçš„çº¿ç¨‹ä¼šæ£€æŸ¥å½“å‰æ˜¯å¦æ˜¯æ‰“ç ´çš„ï¼Œç„¶åæŠ›å‡ºå¼‚å¸¸</span>
    trip<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>nextGeneration()ï¼šå¼€å¯æ–°çš„ä¸‹ä¸€ä»£</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">nextGeneration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†åœ¨ trip æ¡ä»¶é˜Ÿåˆ—å†…æŒ‚èµ·çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’</span>
    trip<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é‡ç½® count ä¸º parties</span>
    count <span class="token operator">=</span> parties<span class="token punctuation">;</span>

    <span class="token comment">// å¼€å¯æ–°çš„ä¸€ä»£ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çš„generationå¯¹è±¡ï¼Œè¡¨ç¤ºæ–°çš„ä¸€ä»£ï¼Œæ–°çš„ä¸€ä»£å’Œä¸Šä¸€ä»£ã€æ²¡æœ‰ä»»ä½•å…³ç³»ã€‘</span>
    generation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Generation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚è€ƒè§†é¢‘ï¼šhttps://space.bilibili.com/457326371/</p><h2 id="semaphore" tabindex="-1"><a class="header-anchor" href="#semaphore"><span>Semaphore</span></a></h2><h3 id="åŸºæœ¬ä½¿ç”¨-6" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨-6"><span>åŸºæœ¬ä½¿ç”¨</span></a></h3><p>synchronized å¯ä»¥èµ·åˆ°é”çš„ä½œç”¨ï¼Œä½†æŸä¸ªæ—¶é—´æ®µå†…ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ</p><p>Semaphoreï¼ˆä¿¡å·é‡ï¼‰ç”¨æ¥é™åˆ¶èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™ï¼Œéé‡å…¥é”</p><p>æ„é€ æ–¹æ³•ï¼š</p><ul><li><code>public Semaphore(int permits)</code>ï¼špermits è¡¨ç¤ºè®¸å¯çº¿ç¨‹çš„æ•°é‡ï¼ˆstateï¼‰</li><li><code>public Semaphore(int permits, boolean fair)</code>ï¼šfair è¡¨ç¤ºå…¬å¹³æ€§ï¼Œå¦‚æœè®¾ä¸º trueï¼Œä¸‹æ¬¡æ‰§è¡Œçš„çº¿ç¨‹ä¼šæ˜¯ç­‰å¾…æœ€ä¹…çš„çº¿ç¨‹</li></ul><p>å¸¸ç”¨APIï¼š</p><ul><li><code>public void acquire()</code>ï¼šè¡¨ç¤ºè·å–è®¸å¯</li><li><code>public void release()</code>ï¼šè¡¨ç¤ºé‡Šæ”¾è®¸å¯ï¼Œacquire() å’Œ release() æ–¹æ³•ä¹‹é—´çš„ä»£ç ä¸ºåŒæ­¥ä»£ç </li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.åˆ›å»ºSemaphoreå¯¹è±¡</span>
    <span class="token class-name">Semaphore</span> semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. 10ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 3. è·å–è®¸å¯</span>
                semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">sout</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">sout</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; end...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// 4. é‡Šæ”¾è®¸å¯</span>
                semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®ç°åŸç†-6" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†-6"><span>å®ç°åŸç†</span></a></h3><p>åŠ é”æµç¨‹ï¼š</p><ul><li>Semaphore çš„ permitsï¼ˆstateï¼‰ä¸º 3ï¼Œè¿™æ—¶ 5 ä¸ªçº¿ç¨‹æ¥è·å–èµ„æº</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">Sync</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token keyword">permits</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡è®¾å…¶ä¸­ Thread-1ï¼ŒThread-2ï¼ŒThread-4 CAS ç«äº‰æˆåŠŸï¼Œpermits å˜ä¸º 0ï¼Œè€Œ Thread-0 å’Œ Thread-3 ç«äº‰å¤±è´¥ï¼Œè¿›å…¥ AQS é˜Ÿåˆ—park é˜»å¡</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// acquire() -&gt; sync.acquireSharedInterruptibly(1)ï¼Œå¯ä¸­æ–­</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å°è¯•è·å–é€šè¡Œè¯ï¼Œè·å–æˆåŠŸè¿”å› &gt;= 0çš„å€¼</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment">// è·å–è®¸å¯è¯å¤±è´¥ï¼Œè¿›å…¥é˜»å¡</span>
        <span class="token function">doAcquireSharedInterruptibly</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// tryAcquireShared() -&gt; nonfairTryAcquireShared()</span>
<span class="token comment">// éå…¬å¹³ï¼Œå…¬å¹³é”ä¼šåœ¨å¾ªç¯å†… hasQueuedPredecessors()æ–¹æ³•åˆ¤æ–­é˜»å¡é˜Ÿåˆ—æ˜¯å¦æœ‰ä¸´å¤´èŠ‚ç‚¹(ç¬¬äºŒä¸ªèŠ‚ç‚¹)</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">nonfairTryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å– state ï¼Œstate è¿™é‡Œã€è¡¨ç¤ºé€šè¡Œè¯ã€‘</span>
        <span class="token keyword">int</span> available <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¡ç®—å½“å‰çº¿ç¨‹è·å–é€šè¡Œè¯å®Œæˆä¹‹åï¼Œé€šè¡Œè¯è¿˜å‰©ä½™æ•°é‡</span>
        <span class="token keyword">int</span> remaining <span class="token operator">=</span> available <span class="token operator">-</span> acquires<span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœè®¸å¯å·²ç»ç”¨å®Œ, è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–å¤±è´¥,</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>remaining <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
            <span class="token comment">// è®¸å¯è¯è¶³å¤Ÿåˆ†é…çš„ï¼Œå¦‚æœ cas é‡è¯•æˆåŠŸ, è¿”å›æ­£æ•°, è¡¨ç¤ºè·å–æˆåŠŸ</span>
            <span class="token function">compareAndSetState</span><span class="token punctuation">(</span>available<span class="token punctuation">,</span> remaining<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> remaining<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireSharedInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†è°ƒç”¨ Semaphore.aquire æ–¹æ³•çš„çº¿ç¨‹ï¼ŒåŒ…è£…æˆ node åŠ å…¥åˆ° AQS çš„é˜»å¡é˜Ÿåˆ—ä¸­</span>
    <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SHARED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–æ ‡è®°</span>
    <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹å¯ä»¥å†æ¬¡è·å–è®¸å¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å†æ¬¡å°è¯•è·å–è®¸å¯ï¼Œã€è¿”å›å‰©ä½™çš„è®¸å¯è¯æ•°é‡ã€‘</span>
                <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æˆåŠŸåæœ¬çº¿ç¨‹å‡ºé˜Ÿï¼ˆAQSï¼‰, æ‰€åœ¨ Nodeè®¾ç½®ä¸º head</span>
                    <span class="token comment">// r è¡¨ç¤ºã€å¯ç”¨èµ„æºæ•°ã€‘, ä¸º 0 åˆ™ä¸ä¼šç»§ç»­ä¼ æ’­</span>
                    <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// ä¸æˆåŠŸ, è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹ waitStatus = Node.SIGNAL, ä¸‹è½®è¿›å…¥ park é˜»å¡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¢«æ‰“æ–­åè¿›å…¥è¯¥é€»è¾‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
            <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> propagate<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹</span>
    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// propagate è¡¨ç¤ºæœ‰ã€å…±äº«èµ„æºã€‘ï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰</span>
    <span class="token comment">// head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATEï¼ŒdoReleaseShared å‡½æ•°ä¸­è®¾ç½®çš„</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propagate <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> h <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>h <span class="token operator">=</span> head<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ï¼Œåšä¸€æ¬¡å”¤é†’</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span><span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-Semaphoreå·¥ä½œæµç¨‹1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>è¿™æ—¶ Thread-4 é‡Šæ”¾äº† permitsï¼ŒçŠ¶æ€å¦‚ä¸‹</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// release() -&gt; releaseShared()</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°è¯•é‡Šæ”¾é”</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryReleaseShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>    
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰é”èµ„æºçš„å¯ç”¨è®¸å¯è¯æ•°é‡</span>
        <span class="token keyword">int</span> current <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> next <span class="token operator">=</span> current <span class="token operator">+</span> releases<span class="token punctuation">;</span>
        <span class="token comment">// ç´¢å¼•è¶Šç•Œåˆ¤æ–­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">&lt;</span> current<span class="token punctuation">)</span>            
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum permit count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token comment">// é‡Šæ”¾é”</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span>            
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token comment">// PROPAGATE è¯¦è§£    </span>
    <span class="token comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark	</span>
    <span class="token comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-Semaphoreå·¥ä½œæµç¨‹2.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>æ¥ä¸‹æ¥ Thread-0 ç«äº‰æˆåŠŸï¼Œpermits å†æ¬¡è®¾ç½®ä¸º 0ï¼Œè®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹ï¼Œå¹¶ä¸” unpark æ¥ä¸‹æ¥çš„å…±äº«çŠ¶æ€çš„ Thread-3 èŠ‚ç‚¹ï¼Œä½†ç”±äº permits æ˜¯ 0ï¼Œå› æ­¤ Thread-3 åœ¨å°è¯•ä¸æˆåŠŸåå†æ¬¡è¿›å…¥ park çŠ¶æ€</li></ul><h3 id="propagate" tabindex="-1"><a class="header-anchor" href="#propagate"><span>PROPAGATE</span></a></h3><p>å‡è®¾å­˜åœ¨æŸæ¬¡å¾ªç¯ä¸­é˜Ÿåˆ—é‡Œæ’é˜Ÿçš„ç»“ç‚¹æƒ…å†µä¸º <code>head(-1) â†’ t1(-1) â†’ t2(0)</code>ï¼Œå­˜åœ¨å°†è¦é‡Šæ”¾ä¿¡å·é‡çš„ T3 å’Œ T4ï¼Œé‡Šæ”¾é¡ºåºä¸ºå…ˆ T3 å T4</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// è€ç‰ˆæœ¬ä»£ç </span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> propagate<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token comment">// æœ‰ç©ºé—²èµ„æº    </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propagate <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    	
        <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        
        <span class="token comment">// ä¸‹ä¸€ä¸ª        </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span><span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            
            <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­£å¸¸æµç¨‹ï¼š</p><ul><li>T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0</li><li>T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œç„¶å T4 é‡Šæ”¾ï¼Œå”¤é†’ T2</li></ul><p>BUG æµç¨‹ï¼š</p><ul><li>T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0</li><li>T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œè°ƒç”¨ tryAcquireSharedï¼Œè¿”å›å€¼ä¸º 0ï¼ˆè·å–é”æˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™èµ„æºé‡ï¼‰</li><li>T1 è¿˜æ²¡è°ƒç”¨ setHeadAndPropagate æ–¹æ³•ï¼ŒT4 è°ƒç”¨ releaseShared(1)ï¼Œæ­¤æ—¶ head.waitStatus ä¸º 0ï¼ˆæ­¤æ—¶è¯»åˆ°çš„ head å’Œ 1 ä¸­ä¸ºåŒä¸€ä¸ª headï¼‰ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼Œå› æ­¤ä¸è°ƒç”¨ unparkSuccessor(head)</li><li>T1 è·å–ä¿¡å·é‡æˆåŠŸï¼Œè°ƒç”¨ setHeadAndPropagate(t1.node, 0) æ—¶ï¼Œå› ä¸ºä¸æ»¡è¶³ propagate &gt; 0ï¼ˆå‰©ä½™èµ„æºé‡ == 0ï¼‰ï¼Œä»è€Œä¸ä¼šå”¤é†’åç»§ç»“ç‚¹ï¼Œ <strong>T2 çº¿ç¨‹å¾—ä¸åˆ°å”¤é†’</strong></li></ul><p>æ›´æ–°åæµç¨‹ï¼š</p><ul><li>T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0</li><li>T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œè°ƒç”¨ tryAcquireSharedï¼Œè¿”å›å€¼ä¸º 0ï¼ˆè·å–é”æˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™èµ„æºé‡ï¼‰</li><li>T1 è¿˜æ²¡è°ƒç”¨ setHeadAndPropagate æ–¹æ³•ï¼ŒT4 è°ƒç”¨ releaseShared()ï¼Œæ­¤æ—¶ head.waitStatus ä¸º 0ï¼ˆæ­¤æ—¶è¯»åˆ°çš„ head å’Œ 1 ä¸­ä¸ºåŒä¸€ä¸ª headï¼‰ï¼Œè°ƒç”¨ doReleaseShared() å°†ç­‰å¾…çŠ¶æ€ç½®ä¸º <strong>PROPAGATEï¼ˆ-3ï¼‰</strong></li><li>T1 è·å–ä¿¡å·é‡æˆåŠŸï¼Œè°ƒç”¨ setHeadAndPropagate æ—¶ï¼Œè¯»åˆ° h.waitStatus &lt; 0ï¼Œä»è€Œè°ƒç”¨ doReleaseShared() å”¤é†’ T2</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> propagate<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹</span>
    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰</span>
    <span class="token comment">// head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propagate <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> h <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>h <span class="token operator">=</span> head<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ï¼Œåšä¸€æ¬¡å”¤é†’</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> s<span class="token punctuation">.</span><span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// å”¤é†’</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark	</span>
    <span class="token comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE    </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> h <span class="token operator">=</span> head<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h <span class="token operator">!=</span> tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> ws <span class="token operator">=</span> h<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// é˜²æ­¢ unparkSuccessor è¢«å¤šæ¬¡æ‰§è¡Œ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">SIGNAL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token comment">// å”¤é†’åç»§èŠ‚ç‚¹</span>
                <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å¦‚æœå·²ç»æ˜¯ 0 äº†ï¼Œæ”¹ä¸º -3ï¼Œç”¨æ¥è§£å†³ä¼ æ’­æ€§</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">PROPAGATE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> head<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="exchanger" tabindex="-1"><a class="header-anchor" href="#exchanger"><span>Exchanger</span></a></h2><p>Exchangerï¼šäº¤æ¢å™¨ï¼Œæ˜¯ä¸€ä¸ªç”¨äºçº¿ç¨‹é—´åä½œçš„å·¥å…·ç±»ï¼Œç”¨äºè¿›è¡Œçº¿ç¨‹é—´çš„æ•°æ®äº¤æ¢</p><p>å·¥ä½œæµç¨‹ï¼šä¸¤ä¸ªçº¿ç¨‹é€šè¿‡ exchange æ–¹æ³•äº¤æ¢æ•°æ®ï¼Œå¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ exchange() æ–¹æ³•ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿæ‰§è¡Œ exchange æ–¹æ³•ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹æ—¶ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±å¯ä»¥äº¤æ¢æ•°æ®</p><p>å¸¸ç”¨æ–¹æ³•ï¼š</p><ul><li><code>public Exchanger()</code>ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº¤æ¢å™¨</li><li><code>public V exchange(V x)</code>ï¼šç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾æ­¤äº¤æ¢ç‚¹</li><li><code>public V exchange(V x, long timeout, TimeUnit unit)</code>ï¼šç­‰å¾…ä¸€å®šçš„æ—¶é—´</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExchangerDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»ºäº¤æ¢å¯¹è±¡ï¼ˆä¿¡ä½¿ï¼‰</span>
        <span class="token class-name">Exchanger</span>\<span class="token operator">&lt;</span><span class="token class-name">String</span>\<span class="token operator">&gt;</span> exchanger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exchanger</span>\<span class="token operator">&lt;</span>\<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">ThreadA</span><span class="token punctuation">(</span>exchanger<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">ThreadB</span><span class="token punctuation">(</span>exchanger<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ThreadA</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Exchanger</span>\<span class="token operator">&lt;</span><span class="token class-name">String</span>\<span class="token operator">&gt;</span> <span class="token function">exchanger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">ThreadA</span><span class="token punctuation">(</span><span class="token class-name">Exchanger</span>\<span class="token operator">&lt;</span><span class="token class-name">String</span>\<span class="token operator">&gt;</span> exchanger<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>exchanger <span class="token operator">=</span> exchanger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token function">sout</span><span class="token punctuation">(</span><span class="token string">&quot;çº¿ç¨‹Aï¼Œåšå¥½äº†ç¤¼ç‰©Aï¼Œç­‰å¾…çº¿ç¨‹Bé€æ¥çš„ç¤¼ç‰©B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å¦‚æœç­‰å¾…äº†5sè¿˜æ²¡æœ‰äº¤æ¢å°±æ­»äº¡ï¼ˆæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼</span>
            <span class="token class-name">String</span> s <span class="token operator">=</span> exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token string">&quot;ç¤¼ç‰©A&quot;</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sout</span><span class="token punctuation">(</span><span class="token string">&quot;çº¿ç¨‹Aæ”¶åˆ°çº¿ç¨‹Bçš„ç¤¼ç‰©ï¼š&quot;</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;çº¿ç¨‹Aç­‰å¾…äº†5sï¼Œæ²¡æœ‰æ”¶åˆ°ç¤¼ç‰©,æœ€ç»ˆå°±æ‰§è¡Œç»“æŸäº†!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">ThreadB</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Exchanger</span>\<span class="token operator">&lt;</span><span class="token class-name">String</span>\<span class="token operator">&gt;</span> exchanger<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">ThreadB</span><span class="token punctuation">(</span><span class="token class-name">Exchanger</span>\<span class="token operator">&lt;</span><span class="token class-name">String</span>\<span class="token operator">&gt;</span> exchanger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>exchanger <span class="token operator">=</span> exchanger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">sout</span><span class="token punctuation">(</span><span class="token string">&quot;çº¿ç¨‹B,åšå¥½äº†ç¤¼ç‰©B,ç­‰å¾…çº¿ç¨‹Aé€æ¥çš„ç¤¼ç‰©A.....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¼€å§‹äº¤æ¢ç¤¼ç‰©ã€‚å‚æ•°æ˜¯é€ç»™å…¶ä»–çº¿ç¨‹çš„ç¤¼ç‰©!</span>
            <span class="token function">sout</span><span class="token punctuation">(</span><span class="token string">&quot;çº¿ç¨‹Bæ”¶åˆ°çº¿ç¨‹Açš„ç¤¼ç‰©ï¼š&quot;</span> <span class="token operator">+</span> exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token string">&quot;ç¤¼ç‰©B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!----><!--]--><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: du.mozzie@outlook.com">mozzie</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/code/java/juc/thread-pool.html" aria-label="çº¿ç¨‹æ± "><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->çº¿ç¨‹æ± </div></a><a class="route-link nav-link next" href="/code/java/juc/concurrent-util.html" aria-label="å¹¶å‘åŒ…"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">å¹¶å‘åŒ…<!----></div></a></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><!----><div class="vp-copyright">Copyright Â© 2026 mozzie </div></footer></div><!--]--><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BE6CABvp.js" defer></script>
  </body>
</html>
