<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.9" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.38" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://du-mozzie.github.io/code/java/juc/no-lock.html"><meta property="og:title" content="æ— é”"><meta property="og:description" content="CAS åŸç† æ— é”ç¼–ç¨‹ï¼šLock Free CAS çš„å…¨ç§°æ˜¯ Compare-And-Swapï¼Œæ˜¯ CPU å¹¶å‘åŸè¯­ CAS å¹¶å‘åŸè¯­ä½“ç°åœ¨ Java è¯­è¨€ä¸­å°±æ˜¯ sun.misc.Unsafe ç±»çš„å„ä¸ªæ–¹æ³•ï¼Œè°ƒç”¨ UnSafe ç±»ä¸­çš„ CAS æ–¹æ³•ï¼ŒJVM ä¼šå®ç°å‡º CAS æ±‡ç¼–æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œå®ç°äº†åŸå­æ“ä½œ CAS æ˜¯ä¸€ç§ç³»ç»ŸåŸ..."><meta property="og:type" content="article"><meta property="og:image" content="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ä¼ªå…±äº«1.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-02-08T06:35:13.000Z"><meta property="article:author" content="mozzie"><meta property="article:tag" content="Java"><meta property="article:published_time" content="2021-05-10T00:00:00.000Z"><meta property="article:modified_time" content="2025-02-08T06:35:13.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"æ— é”","image":["https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ä¼ªå…±äº«1.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-%E4%BC%AA%E5%85%B1%E4%BA%AB2.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocal%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84JDK8%E5%89%8D.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocal%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84JDK8%E5%90%8E.png","https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-replaceStaleEntryæµç¨‹.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocal%E6%8E%A2%E6%B5%8B%E5%BC%8F%E6%B8%85%E7%90%861.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocal%E6%8E%A2%E6%B5%8B%E5%BC%8F%E6%B8%85%E7%90%862.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocal%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E5%BC%BA%E5%BC%95%E7%94%A8.png","https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocal%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E5%BC%B1%E5%BC%95%E7%94%A8.png"],"datePublished":"2021-05-10T00:00:00.000Z","dateModified":"2025-02-08T06:35:13.000Z","author":[{"@type":"Person","name":"mozzie","url":"https://du-mozzie.github.io"}]}</script><link rel="stylesheet" href="//at.alicdn.com/t/font_2410206_mfj6e1vbwo.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_3294373_aaebeoej8c7.css"><script src="//hm.baidu.com/hm.js?062f74a68f105c60f10f2a0fc9cc9803"></script><script src="/assets/js/clarity.js"></script><title>æ— é”</title><meta name="description" content="CAS åŸç† æ— é”ç¼–ç¨‹ï¼šLock Free CAS çš„å…¨ç§°æ˜¯ Compare-And-Swapï¼Œæ˜¯ CPU å¹¶å‘åŸè¯­ CAS å¹¶å‘åŸè¯­ä½“ç°åœ¨ Java è¯­è¨€ä¸­å°±æ˜¯ sun.misc.Unsafe ç±»çš„å„ä¸ªæ–¹æ³•ï¼Œè°ƒç”¨ UnSafe ç±»ä¸­çš„ CAS æ–¹æ³•ï¼ŒJVM ä¼šå®ç°å‡º CAS æ±‡ç¼–æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œå®ç°äº†åŸå­æ“ä½œ CAS æ˜¯ä¸€ç§ç³»ç»ŸåŸ...">
    <link rel="preload" href="/assets/style-hN5IEUGq.css" as="style"><link rel="stylesheet" href="/assets/style-hN5IEUGq.css">
    <link rel="modulepreload" href="/assets/app-DyhgqEf-.js"><link rel="modulepreload" href="/assets/no-lock.html-DC-ZfbcT.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/assets/images/ghibli.jpg" alt><!----><!----></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="ä¸»é¡µ"><span class="font-icon icon fa-fw fa-sm iconfont icon-home" style=""></span>ä¸»é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="ä»£ç ç¬”è®°"><span class="title"><span class="font-icon icon fa-fw fa-sm iconfont icon-code" style=""></span>ä»£ç ç¬”è®°</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/code/data-structure-and-algorithms/" aria-label="æ•°æ®ç»“æ„ä¸ç®—æ³•"><img class="icon" src="/assets/images/navbar/data-structure.svg" alt aria-hidden no-view style="">æ•°æ®ç»“æ„ä¸ç®—æ³•<!----></a></li><li class="dropdown-item"><a class="route-link nav-link active" href="/code/java/" aria-label="Java"><img class="icon" src="/assets/images/navbar/java.svg" alt aria-hidden no-view style="">Java<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/netty/" aria-label="Netty"><img class="icon" src="/assets/images/navbar/netty.svg" alt aria-hidden no-view style="">Netty<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/mysql/" aria-label="MySQL"><img class="icon" src="/assets/images/navbar/mysql.svg" alt aria-hidden no-view style="">MySQL<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/spring/" aria-label="Spring"><img class="icon" src="/assets/images/navbar/spring.svg" alt aria-hidden no-view style="">Spring<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/redis/" aria-label="Redis"><img class="icon" src="/assets/images/navbar/redis.svg" alt aria-hidden no-view style="">Redis<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/distributed/" aria-label="åˆ†å¸ƒå¼"><img class="icon" src="/assets/images/navbar/distributed.svg" alt aria-hidden no-view style="">åˆ†å¸ƒå¼<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/ai/" aria-label="AI"><img class="icon" src="/assets/images/navbar/ai.svg" alt aria-hidden no-view style="">AI<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/code/notes/" aria-label="æ‚è®°"><img class="icon" src="/assets/images/navbar/notes.svg" alt aria-hidden no-view style="">æ‚è®°<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="åˆ†ç±»"><span class="title"><span class="font-icon icon fa-fw fa-sm iconfont icon-type" style=""></span>åˆ†ç±»</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/category/" aria-label="åˆ†ç±»"><img class="icon" src="/assets/images/navbar/category.svg" alt aria-hidden no-view style="">åˆ†ç±»<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/tag/" aria-label="æ ‡ç­¾"><img class="icon" src="/assets/images/navbar/tag.svg" alt aria-hidden no-view style="">æ ‡ç­¾<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/timeline/" aria-label="æ—¶é—´çº¿"><img class="icon" src="/assets/images/navbar/timeline.svg" alt aria-hidden no-view style="">æ—¶é—´çº¿<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/jottings/" aria-label="éšç¬”"><span class="font-icon icon fa-fw fa-sm fa-solid fa-compass-drafting" style=""></span>éšç¬”<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/links.html" aria-label="é“¾æ¥"><span class="font-icon icon fa-fw fa-sm iconfont icon-link" style=""></span>é“¾æ¥<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link nav-link" href="/about.html" aria-label="å…³äºæˆ‘"><span class="font-icon icon fa-fw fa-sm iconfont icon-people" style=""></span>å…³äºæˆ‘<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">æ•°æ®ç»“æ„ä¸ç®—æ³•</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">Java</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/system.html" aria-label="Javaä½“ç³»"><!---->Javaä½“ç³»<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/basic-conception.html" aria-label="åŸºæœ¬æ¦‚å¿µ"><!---->åŸºæœ¬æ¦‚å¿µ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/process-control.html" aria-label="æµç¨‹æ§åˆ¶"><!---->æµç¨‹æ§åˆ¶<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/array.html" aria-label="æ•°ç»„"><!---->æ•°ç»„<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/object.html" aria-label="é¢å‘å¯¹è±¡"><!---->é¢å‘å¯¹è±¡<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/common-class.html" aria-label="å¸¸ç”¨ç±»"><!---->å¸¸ç”¨ç±»<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/exception.html" aria-label="å¼‚å¸¸"><!---->å¼‚å¸¸<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/collection.html" aria-label="é›†åˆ"><!---->é›†åˆ<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">å¹¶å‘ç¼–ç¨‹</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/process.html" aria-label="è¿›ç¨‹"><!---->è¿›ç¨‹<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/thread.html" aria-label="çº¿ç¨‹"><!---->çº¿ç¨‹<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/sync.html" aria-label="åŒæ­¥"><!---->åŒæ­¥<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/memory.html" aria-label="å†…å­˜"><!---->å†…å­˜<!----></a></li><li><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/code/java/juc/no-lock.html" aria-label="æ— é”"><!---->æ— é”<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/thread-pool.html" aria-label="çº¿ç¨‹æ± "><!---->çº¿ç¨‹æ± <!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/synchronizer.html" aria-label="åŒæ­¥å™¨"><!---->åŒæ­¥å™¨<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/concurrent-util.html" aria-label="å¹¶å‘åŒ…"><!---->å¹¶å‘åŒ…<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/juc/summary.html" aria-label="æ€»ç»“"><!---->æ€»ç»“<!----></a></li></ul></section></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/genericity.html" aria-label="æ³›å‹"><!---->æ³›å‹<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/io.html" aria-label="IOæµ"><!---->IOæµ<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/reflect.html" aria-label="åå°„"><!---->åå°„<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/annotation.html" aria-label="æ³¨è§£"><!---->æ³¨è§£<!----></a></li><li><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/code/java/jvm.html" aria-label="JVM"><!---->JVM<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">MySQL</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Netty</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Spring</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">Redis</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">åˆ†å¸ƒå¼</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">AI</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">ç”Ÿäº§</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">æ‚è®°</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->æ— é”</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://du-mozzie.github.io" target="_blank" rel="noopener noreferrer">mozzie</a></span><span property="author" content="mozzie"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2021-05-10T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 39 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT39M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category8 clickable" role="navigation">Java</span><!--]--><meta property="articleSection" content="Java"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag8 clickable" role="navigation">Java</span><!--]--><meta property="keywords" content="Java"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!--[--><!----><!--]--><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#cas">CAS</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸç†">åŸç†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¹è§‚é”">ä¹è§‚é”</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#atomic">Atomic</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å¸¸ç”¨api">å¸¸ç”¨API</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸç†åˆ†æ">åŸç†åˆ†æ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸå­å¼•ç”¨">åŸå­å¼•ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸå­æ•°ç»„">åŸå­æ•°ç»„</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸå­æ›´æ–°å™¨">åŸå­æ›´æ–°å™¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸå­ç´¯åŠ å™¨">åŸå­ç´¯åŠ å™¨</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#adder">Adder</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¼˜åŒ–æœºåˆ¶">ä¼˜åŒ–æœºåˆ¶</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¼ªå…±äº«">ä¼ªå…±äº«</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#æºç è§£æ">æºç è§£æ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#aba">ABA</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#unsafe">Unsafe</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#final">final</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸç†-1">åŸç†</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä¸å¯å˜">ä¸å¯å˜</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#state">State</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#local">Local</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬ä»‹ç»">åŸºæœ¬ä»‹ç»</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#å¸¸ç”¨æ–¹æ³•">å¸¸ç”¨æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å®ç°åŸç†">å®ç°åŸç†</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#åº•å±‚ç»“æ„">åº•å±‚ç»“æ„</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#æˆå‘˜å˜é‡">æˆå‘˜å˜é‡</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#æˆå‘˜æ–¹æ³•">æˆå‘˜æ–¹æ³•</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#localmap">LocalMap</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#æˆå‘˜å±æ€§">æˆå‘˜å±æ€§</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#æˆå‘˜æ–¹æ³•-1">æˆå‘˜æ–¹æ³•</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#æ¸…ç†æ–¹æ³•">æ¸…ç†æ–¹æ³•</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å†…å­˜æ³„æ¼">å†…å­˜æ³„æ¼</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#å˜é‡ä¼ é€’">å˜é‡ä¼ é€’</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#åŸºæœ¬ä½¿ç”¨-1">åŸºæœ¬ä½¿ç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level4" href="#å®ç°åŸç†-1">å®ç°åŸç†</a></li><!----><!--]--></ul></li><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h2 id="cas" tabindex="-1"><a class="header-anchor" href="#cas"><span>CAS</span></a></h2><h3 id="åŸç†" tabindex="-1"><a class="header-anchor" href="#åŸç†"><span>åŸç†</span></a></h3><p>æ— é”ç¼–ç¨‹ï¼šLock Free</p><p>CAS çš„å…¨ç§°æ˜¯ Compare-And-Swapï¼Œæ˜¯ <strong>CPU å¹¶å‘åŸè¯­</strong></p><ul><li>CAS å¹¶å‘åŸè¯­ä½“ç°åœ¨ Java è¯­è¨€ä¸­å°±æ˜¯ sun.misc.Unsafe ç±»çš„å„ä¸ªæ–¹æ³•ï¼Œè°ƒç”¨ UnSafe ç±»ä¸­çš„ CAS æ–¹æ³•ï¼ŒJVM ä¼šå®ç°å‡º CAS æ±‡ç¼–æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œå®ç°äº†åŸå­æ“ä½œ</li><li>CAS æ˜¯ä¸€ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»ŸèŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆ ï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œæ‰€ä»¥ CAS æ˜¯ä¸€æ¡ CPU çš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„</li></ul><p>åº•å±‚åŸç†ï¼šCAS çš„åº•å±‚æ˜¯ <code>lock cmpxchg</code> æŒ‡ä»¤ï¼ˆX86 æ¶æ„ï¼‰ï¼Œåœ¨å•æ ¸å’Œå¤šæ ¸ CPU ä¸‹éƒ½èƒ½å¤Ÿä¿è¯æ¯”è¾ƒäº¤æ¢çš„åŸå­æ€§</p><ul><li>ç¨‹åºæ˜¯åœ¨å•æ ¸å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œä¼šçœç•¥ lock å‰ç¼€ï¼Œå•å¤„ç†å™¨è‡ªèº«ä¼šç»´æŠ¤å¤„ç†å™¨å†…çš„é¡ºåºä¸€è‡´æ€§ï¼Œä¸éœ€è¦ lock å‰ç¼€çš„å†…å­˜å±éšœæ•ˆæœ</li><li>ç¨‹åºæ˜¯åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œä¼šä¸º cmpxchg æŒ‡ä»¤åŠ ä¸Š lock å‰ç¼€ã€‚å½“æŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šæ‰§è¡Œ<strong>æ€»çº¿é”å®šæˆ–ç¼“å­˜é”å®š</strong>ï¼Œå°†ä¿®æ”¹çš„å˜é‡å†™å…¥åˆ°ä¸»å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æœºåˆ¶æ‰€æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„åŸå­æ€§</li></ul><p>ä½œç”¨ï¼šæ¯”è¾ƒå½“å‰å·¥ä½œå†…å­˜ä¸­çš„å€¼å’Œä¸»ç‰©ç†å†…å­˜ä¸­çš„å€¼ï¼Œå¦‚æœç›¸åŒåˆ™æ‰§è¡Œè§„å®šæ“ä½œï¼Œå¦åˆ™ç»§ç»­æ¯”è¾ƒç›´åˆ°ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„å€¼ä¸€è‡´ä¸ºæ­¢</p><p>CAS ç‰¹ç‚¹ï¼š</p><ul><li>CAS ä½“ç°çš„æ˜¯<strong>æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘</strong>ï¼Œçº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œçº¿ç¨‹ä¸éœ€è¦é¢‘ç¹åˆ‡æ¢çŠ¶æ€ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç³»ç»Ÿè°ƒç”¨ï¼‰</li><li>CAS æ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³</li></ul><p>CAS ç¼ºç‚¹ï¼š</p><ul><li><p>æ‰§è¡Œçš„æ˜¯å¾ªç¯æ“ä½œï¼Œå¦‚æœæ¯”è¾ƒä¸æˆåŠŸä¸€ç›´åœ¨å¾ªç¯ï¼Œæœ€å·®çš„æƒ…å†µæŸä¸ªçº¿ç¨‹ä¸€ç›´å–åˆ°çš„å€¼å’Œé¢„æœŸå€¼éƒ½ä¸ä¸€æ ·ï¼Œå°±ä¼šæ— é™å¾ªç¯å¯¼è‡´é¥¥é¥¿ï¼Œ<strong>ä½¿ç”¨ CAS çº¿ç¨‹æ•°ä¸è¦è¶…è¿‡ CPU çš„æ ¸å¿ƒæ•°</strong>ï¼Œé‡‡ç”¨åˆ†æ®µ CAS å’Œè‡ªåŠ¨è¿ç§»æœºåˆ¶</p></li><li><p>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ</p></li><li><p>å¯¹äºä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œå¯ä»¥é€šè¿‡å¾ªç¯ CAS çš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œ</p></li><li><p>å¯¹äºå¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯ CAS å°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™<strong>åªèƒ½ç”¨é”æ¥ä¿è¯åŸå­æ€§</strong></p></li><li><p>å¼•å‡ºæ¥ ABA é—®é¢˜</p></li></ul><h3 id="ä¹è§‚é”" tabindex="-1"><a class="header-anchor" href="#ä¹è§‚é”"><span>ä¹è§‚é”</span></a></h3><p>CAS ä¸ synchronized æ€»ç»“ï¼š</p><ul><li>synchronized æ˜¯ä»æ‚²è§‚çš„è§’åº¦å‡ºå‘ï¼šæ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼šé˜»å¡ï¼ˆå…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹ï¼‰ï¼Œå› æ­¤ synchronized ä¹Ÿç§°ä¹‹ä¸ºæ‚²è§‚é”ï¼ŒReentrantLock ä¹Ÿæ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œæ€§èƒ½è¾ƒå·®</li><li>CAS æ˜¯ä»ä¹è§‚çš„è§’åº¦å‡ºå‘ï¼šæ€»æ˜¯å‡è®¾æœ€å¥½çš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ®ã€‚<strong>å¦‚æœåˆ«äººä¿®æ”¹è¿‡ï¼Œåˆ™è·å–ç°åœ¨æœ€æ–°çš„å€¼ï¼Œå¦‚æœåˆ«äººæ²¡ä¿®æ”¹è¿‡ï¼Œç›´æ¥ä¿®æ”¹å…±äº«æ•°æ®çš„å€¼</strong>ï¼ŒCAS è¿™ç§æœºåˆ¶ä¹Ÿç§°ä¹‹ä¸ºä¹è§‚é”ï¼Œç»¼åˆæ€§èƒ½è¾ƒå¥½</li></ul><h2 id="atomic" tabindex="-1"><a class="header-anchor" href="#atomic"><span>Atomic</span></a></h2><h3 id="å¸¸ç”¨api" tabindex="-1"><a class="header-anchor" href="#å¸¸ç”¨api"><span>å¸¸ç”¨API</span></a></h3><p>å¸¸è§åŸå­ç±»ï¼šAtomicIntegerã€AtomicBooleanã€AtomicLong</p><p>æ„é€ æ–¹æ³•ï¼š</p><ul><li><code>public AtomicInteger()</code>ï¼šåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤å€¼ä¸º 0 çš„åŸå­å‹ Integer</li><li><code>public AtomicInteger(int initialValue)</code>ï¼šåˆå§‹åŒ–ä¸€ä¸ªæŒ‡å®šå€¼çš„åŸå­å‹ Integer</li></ul><p>å¸¸ç”¨APIï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>public final int get()</td><td>è·å– AtomicInteger çš„å€¼</td></tr><tr><td>public final int getAndIncrement()</td><td>ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ  1ï¼Œè¿”å›çš„æ˜¯è‡ªå¢å‰çš„å€¼</td></tr><tr><td>public final int incrementAndGet()</td><td>ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ  1ï¼Œè¿”å›çš„æ˜¯è‡ªå¢åçš„å€¼</td></tr><tr><td>public final int getAndSet(int value)</td><td>ä»¥åŸå­æ–¹å¼è®¾ç½®ä¸º newValue çš„å€¼ï¼Œè¿”å›æ—§å€¼</td></tr><tr><td>public final int addAndGet(int data)</td><td>ä»¥åŸå­æ–¹å¼å°†è¾“å…¥çš„æ•°å€¼ä¸å®ä¾‹ä¸­çš„å€¼ç›¸åŠ å¹¶è¿”å› å®ä¾‹ï¼šAtomicInteger é‡Œçš„ value</td></tr></tbody></table><h3 id="åŸç†åˆ†æ" tabindex="-1"><a class="header-anchor" href="#åŸç†åˆ†æ"><span>åŸç†åˆ†æ</span></a></h3><p><strong>AtomicInteger åŸç†</strong>ï¼šè‡ªæ—‹é” + CAS ç®—æ³•</p><p>CAS ç®—æ³•ï¼šæœ‰ 3 ä¸ªæ“ä½œæ•°ï¼ˆå†…å­˜å€¼ Vï¼Œ æ—§çš„é¢„æœŸå€¼ Aï¼Œè¦ä¿®æ”¹çš„å€¼ Bï¼‰</p><ul><li>å½“æ—§çš„é¢„æœŸå€¼ A == å†…å­˜å€¼ V æ­¤æ—¶å¯ä»¥ä¿®æ”¹ï¼Œå°† V æ”¹ä¸º B</li><li>å½“æ—§çš„é¢„æœŸå€¼ A != å†…å­˜å€¼ V æ­¤æ—¶ä¸èƒ½ä¿®æ”¹ï¼Œå¹¶é‡æ–°è·å–ç°åœ¨çš„æœ€æ–°å€¼ï¼Œé‡æ–°è·å–çš„åŠ¨ä½œå°±æ˜¯è‡ªæ—‹</li></ul><p>åˆ†æ getAndSet æ–¹æ³•ï¼š</p><ul><li>AtomicIntegerï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
    * this: 		å½“å‰å¯¹è±¡
    * valueOffset:	å†…å­˜åç§»é‡ï¼Œå†…å­˜åœ°å€
    */</span>
    <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">getAndSetInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> valueOffset<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>valueOffsetï¼šåç§»é‡è¡¨ç¤ºè¯¥å˜é‡å€¼ç›¸å¯¹äºå½“å‰å¯¹è±¡åœ°å€çš„åç§»ï¼ŒUnsafe å°±æ˜¯æ ¹æ®å†…å­˜åç§»åœ°å€è·å–æ•°æ®</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>valueOffset <span class="token operator">=</span> unsafe<span class="token punctuation">.</span>objectFieldOffset
                <span class="token punctuation">(</span><span class="token class-name">AtomicInteger</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//è°ƒç”¨æœ¬åœ°æ–¹æ³•   --&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">long</span> <span class="token function">objectFieldOffset</span><span class="token punctuation">(</span><span class="token class-name">Field</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>unsafe ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// val1: AtomicIntegerå¯¹è±¡æœ¬èº«ï¼Œvar2: è¯¥å¯¹è±¡å€¼å¾—å¼•ç”¨åœ°å€ï¼Œvar4: éœ€è¦å˜åŠ¨çš„æ•°</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndSetInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> var1<span class="token punctuation">,</span> <span class="token keyword">long</span> var2<span class="token punctuation">,</span> <span class="token keyword">int</span> var4<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> var5<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// var5: ç”¨ var1 å’Œ var2 æ‰¾åˆ°çš„å†…å­˜ä¸­çš„çœŸå®å€¼</span>
        var5 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getIntVolatile</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> var5<span class="token punctuation">,</span> var4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> var5<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>var5ï¼šä»ä¸»å†…å­˜ä¸­æ‹·è´åˆ°å·¥ä½œå†…å­˜ä¸­çš„å€¼ï¼ˆæ¯æ¬¡éƒ½è¦ä»ä¸»å†…å­˜æ‹¿åˆ°æœ€æ–°çš„å€¼åˆ°æœ¬åœ°å†…å­˜ï¼‰ï¼Œç„¶åæ‰§è¡Œ <code>compareAndSwapInt()</code> å†å’Œä¸»å†…å­˜çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå‡è®¾æ–¹æ³•è¿”å› falseï¼Œé‚£ä¹ˆå°±ä¸€ç›´æ‰§è¡Œ while æ–¹æ³•ï¼Œç›´åˆ°æœŸæœ›çš„å€¼å’ŒçœŸå®å€¼ä¸€æ ·ï¼Œä¿®æ”¹æ•°æ®</p><ul><li>å˜é‡ value ç”¨ volatile ä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ï¼Œé¿å…çº¿ç¨‹ä»å·¥ä½œç¼“å­˜ä¸­è·å–å¤±æ•ˆçš„å˜é‡</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>CAS å¿…é¡»å€ŸåŠ© volatile æ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°æ¯”è¾ƒå¹¶äº¤æ¢çš„æ•ˆæœ</strong></p><p>åˆ†æ getAndUpdate æ–¹æ³•ï¼š</p><ul><li>getAndUpdateï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndUpdate</span><span class="token punctuation">(</span><span class="token class-name">IntUnaryOperator</span> updateFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> prev<span class="token punctuation">,</span> next<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        prev <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//å½“å‰å€¼ï¼Œcasçš„æœŸæœ›å€¼</span>
        next <span class="token operator">=</span> updateFunction<span class="token punctuation">.</span><span class="token function">applyAsInt</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æœŸæœ›å€¼æ›´æ–°åˆ°è¯¥å€¼</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//è‡ªæ—‹</span>
    <span class="token keyword">return</span> prev<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡½æ•°å¼æ¥å£ï¼šå¯ä»¥è‡ªå®šä¹‰æ“ä½œé€»è¾‘</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">AtomicInteger</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span><span class="token function">getAndUpdate</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>compareAndSetï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
    * this: 		å½“å‰å¯¹è±¡
    * valueOffset:	å†…å­˜åç§»é‡ï¼Œå†…å­˜åœ°å€
    * expect:		æœŸæœ›çš„å€¼
    * update: 		æ›´æ–°çš„å€¼
    */</span>
    <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> valueOffset<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åŸå­å¼•ç”¨" tabindex="-1"><a class="header-anchor" href="#åŸå­å¼•ç”¨"><span>åŸå­å¼•ç”¨</span></a></h3><p>åŸå­å¼•ç”¨ï¼šå¯¹ Object è¿›è¡ŒåŸå­æ“ä½œï¼Œæä¾›ä¸€ç§è¯»å’Œå†™éƒ½æ˜¯åŸå­æ€§çš„å¯¹è±¡å¼•ç”¨å˜é‡</p><p>åŸå­å¼•ç”¨ç±»ï¼šAtomicReferenceã€AtomicStampedReferenceã€AtomicMarkableReference</p><p>AtomicReference ç±»ï¼š</p><ul><li><p>æ„é€ æ–¹æ³•ï¼š<code>AtomicReference\&lt;T\&gt; atomicReference = new AtomicReference\&lt;T\&gt;()</code></p></li><li><p>å¸¸ç”¨ APIï¼š</p></li><li><p><code>public final boolean compareAndSet(V expectedValue, V newValue)</code>ï¼šCAS æ“ä½œ</p></li><li><p><code>public final void set(V newValue)</code>ï¼šå°†å€¼è®¾ç½®ä¸º newValue</p></li><li><p><code>public final V get()</code>ï¼šè¿”å›å½“å‰å€¼</p></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">,</span> <span class="token string">&quot;z3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// åˆ›å»ºåŸå­å¼•ç”¨åŒ…è£…ç±»</span>
        <span class="token class-name">AtomicReference</span>\<span class="token operator">&lt;</span><span class="token class-name">Student</span>\<span class="token operator">&gt;</span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span>\<span class="token operator">&lt;</span>\<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¾ç½®ä¸»å†…å­˜å…±äº«å˜é‡ä¸ºs1</span>
        atomicReference<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œå¦‚æœç°åœ¨ä¸»ç‰©ç†å†…å­˜çš„å€¼ä¸º z3ï¼Œé‚£ä¹ˆäº¤æ¢æˆ l4</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Student</span> s2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">44</span><span class="token punctuation">,</span> <span class="token string">&quot;l4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token comment">//ã€‚ã€‚ã€‚ã€‚</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åŸå­æ•°ç»„" tabindex="-1"><a class="header-anchor" href="#åŸå­æ•°ç»„"><span>åŸå­æ•°ç»„</span></a></h3><p>åŸå­æ•°ç»„ç±»ï¼šAtomicIntegerArrayã€AtomicLongArrayã€AtomicReferenceArray</p><p>AtomicIntegerArray ç±»æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
*   i		the index
* expect 	the expected value
* update 	the new value
*/</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">compareAndSetRaw</span><span class="token punctuation">(</span><span class="token function">checkedByteOffset</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> expect<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åŸå­æ›´æ–°å™¨" tabindex="-1"><a class="header-anchor" href="#åŸå­æ›´æ–°å™¨"><span>åŸå­æ›´æ–°å™¨</span></a></h3><p>åŸå­æ›´æ–°å™¨ç±»ï¼šAtomicReferenceFieldUpdaterã€AtomicIntegerFieldUpdaterã€AtomicLongFieldUpdater</p><p>åˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹å¯¹è±¡çš„æŸä¸ªåŸŸï¼ˆFieldï¼‰è¿›è¡ŒåŸå­æ“ä½œï¼Œåªèƒ½é…åˆ volatile ä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸ <code>IllegalArgumentException: Must be volatile type</code></p><p>å¸¸ç”¨ APIï¼š</p><ul><li><code>static \&lt;U\&gt; AtomicIntegerFieldUpdater\&lt;U\&gt; newUpdater(Class\&lt;U\&gt; c, String fieldName)</code>ï¼šæ„é€ æ–¹æ³•</li><li><code>abstract boolean compareAndSet(T obj, int expect, int update)</code>ï¼šCAS</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UpdateDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> field<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AtomicIntegerFieldUpdater</span> fieldUpdater <span class="token operator">=</span> <span class="token class-name">AtomicIntegerFieldUpdater</span>
            		<span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">UpdateDemo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;field&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UpdateDemo</span> updateDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fieldUpdater<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>updateDemo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>updateDemo<span class="token punctuation">.</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//10</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åŸå­ç´¯åŠ å™¨" tabindex="-1"><a class="header-anchor" href="#åŸå­ç´¯åŠ å™¨"><span>åŸå­ç´¯åŠ å™¨</span></a></h3><p>åŸå­ç´¯åŠ å™¨ç±»ï¼šLongAdderã€DoubleAdderã€LongAccumulatorã€DoubleAccumulator</p><p>LongAdder å’Œ LongAccumulator åŒºåˆ«ï¼š</p><p>ç›¸åŒç‚¹ï¼š</p><ul><li>LongAddr ä¸ LongAccumulator ç±»éƒ½æ˜¯ä½¿ç”¨éé˜»å¡ç®—æ³• CAS å®ç°çš„</li><li>LongAddr ç±»æ˜¯ LongAccumulator ç±»çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œåªæ˜¯ LongAccumulator æä¾›äº†æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ä»¥è‡ªå®šä¹‰ç´¯åŠ è§„åˆ™ï¼Œå½“accumulatorFunction ä¸º null æ—¶å°±ç­‰ä»·äº LongAddr</li></ul><p>ä¸åŒç‚¹ï¼š</p><ul><li><p>è°ƒç”¨ casBase æ—¶ï¼ŒLongAccumulator ä½¿ç”¨ function.applyAsLong(b = base, x) æ¥è®¡ç®—ï¼ŒLongAddr ä½¿ç”¨ casBase(b = base, b + x)</p></li><li><p>LongAccumulator ç±»åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼Œæ„é€ æ–¹æ³•å‚æ•°ä¸­</p></li><li><p>accumulatorFunction æ˜¯ä¸€ä¸ªåŒç›®è¿ç®—å™¨æ¥å£ï¼Œå¯ä»¥æŒ‡å®šç´¯åŠ è§„åˆ™ï¼Œæ¯”å¦‚ç´¯åŠ æˆ–è€…ç›¸ä¹˜ï¼Œå…¶æ ¹æ®è¾“å…¥çš„ä¸¤ä¸ªå‚æ•°è¿”å›ä¸€ä¸ªè®¡ç®—å€¼ï¼ŒLongAdder å†…ç½®ç´¯åŠ è§„åˆ™</p></li><li><p>identity åˆ™æ˜¯ LongAccumulator ç´¯åŠ å™¨çš„åˆå§‹å€¼ï¼ŒLongAccumulator å¯ä»¥ä¸ºç´¯åŠ å™¨æä¾›é0çš„åˆå§‹å€¼ï¼Œè€Œ LongAdder åªèƒ½æä¾›é»˜è®¤çš„ 0</p></li></ul><h2 id="adder" tabindex="-1"><a class="header-anchor" href="#adder"><span>Adder</span></a></h2><h3 id="ä¼˜åŒ–æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–æœºåˆ¶"><span>ä¼˜åŒ–æœºåˆ¶</span></a></h3><p>LongAdder æ˜¯ Java8 æä¾›çš„ç±»ï¼Œè·Ÿ AtomicLong æœ‰ç›¸åŒçš„æ•ˆæœï¼Œä½†å¯¹ CAS æœºåˆ¶è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå°è¯•ä½¿ç”¨åˆ†æ®µ CAS ä»¥åŠè‡ªåŠ¨åˆ†æ®µè¿ç§»çš„æ–¹å¼æ¥å¤§å¹…åº¦æå‡å¤šçº¿ç¨‹é«˜å¹¶å‘æ‰§è¡Œ CAS æ“ä½œçš„æ€§èƒ½</p><p>CAS åº•å±‚å®ç°æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ä¸æ–­åœ°å°è¯•ä¿®æ”¹ç›®æ ‡å€¼ï¼Œç›´åˆ°ä¿®æ”¹æˆåŠŸã€‚å¦‚æœç«äº‰ä¸æ¿€çƒˆä¿®æ”¹æˆåŠŸç‡å¾ˆé«˜ï¼Œå¦åˆ™å¤±è´¥ç‡å¾ˆé«˜ï¼Œå¤±è´¥åè¿™äº›é‡å¤çš„åŸå­æ€§æ“ä½œä¼šè€—è´¹æ€§èƒ½ï¼ˆå¯¼è‡´å¤§é‡çº¿ç¨‹<strong>ç©ºå¾ªç¯ï¼Œè‡ªæ—‹è½¬</strong>ï¼‰</p><p>ä¼˜åŒ–æ ¸å¿ƒæ€æƒ³ï¼šæ•°æ®åˆ†ç¦»ï¼Œå°† AtomicLong çš„<strong>å•ç‚¹çš„æ›´æ–°å‹åŠ›åˆ†æ‹…åˆ°å„ä¸ªèŠ‚ç‚¹ï¼Œç©ºé—´æ¢æ—¶é—´</strong>ï¼Œåœ¨ä½å¹¶å‘çš„æ—¶å€™ç›´æ¥æ›´æ–°ï¼Œå¯ä»¥ä¿éšœå’Œ AtomicLong çš„æ€§èƒ½åŸºæœ¬ä¸€è‡´ï¼Œè€Œåœ¨é«˜å¹¶å‘çš„æ—¶å€™é€šè¿‡åˆ†æ•£å‡å°‘ç«äº‰ï¼Œæé«˜äº†æ€§èƒ½</p><p><strong>åˆ†æ®µ CAS æœºåˆ¶</strong>ï¼š</p><ul><li>åœ¨å‘ç”Ÿç«äº‰æ—¶ï¼Œåˆ›å»º Cell æ•°ç»„ç”¨äºå°†ä¸åŒçº¿ç¨‹çš„æ“ä½œç¦»æ•£ï¼ˆé€šè¿‡ hash ç­‰ç®—æ³•æ˜ å°„ï¼‰åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Š</li><li>è®¾ç½®å¤šä¸ªç´¯åŠ å•å…ƒï¼ˆä¼šæ ¹æ®éœ€è¦æ‰©å®¹ï¼Œæœ€å¤§ä¸º CPU æ ¸æ•°ï¼‰ï¼ŒTherad-0 ç´¯åŠ  Cell[0]ï¼Œè€Œ Thread-1 ç´¯åŠ  Cell[1] ç­‰ï¼Œæœ€åå°†ç»“æœæ±‡æ€»</li><li>åœ¨ç´¯åŠ æ—¶æ“ä½œçš„ä¸åŒçš„ Cell å˜é‡ï¼Œå› æ­¤å‡å°‘äº† CAS é‡è¯•å¤±è´¥ï¼Œä»è€Œæé«˜æ€§èƒ½</li></ul><p><strong>è‡ªåŠ¨åˆ†æ®µè¿ç§»æœºåˆ¶</strong>ï¼šæŸä¸ª Cell çš„ value æ‰§è¡Œ CAS å¤±è´¥ï¼Œå°±ä¼šè‡ªåŠ¨å¯»æ‰¾å¦ä¸€ä¸ª Cell åˆ†æ®µå†…çš„ value å€¼è¿›è¡Œ CAS æ“ä½œ</p><h3 id="ä¼ªå…±äº«" tabindex="-1"><a class="header-anchor" href="#ä¼ªå…±äº«"><span>ä¼ªå…±äº«</span></a></h3><p>Cell ä¸ºç´¯åŠ å•å…ƒï¼šæ•°ç»„è®¿é—®ç´¢å¼•æ˜¯é€šè¿‡ Thread é‡Œçš„ threadLocalRandomProbe åŸŸå–æ¨¡å®ç°çš„ï¼Œè¿™ä¸ªåŸŸæ˜¯ ThreadLocalRandom æ›´æ–°çš„</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// Striped64.Cell</span>
<span class="token annotation punctuation">@sun.misc.Contended</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Cell</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token keyword">long</span> value<span class="token punctuation">;</span>
    <span class="token class-name">Cell</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span> value <span class="token operator">=</span> x<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">// ç”¨ cas æ–¹å¼è¿›è¡Œç´¯åŠ , prev è¡¨ç¤ºæ—§å€¼, next è¡¨ç¤ºæ–°å€¼</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">cas</span><span class="token punctuation">(</span><span class="token keyword">long</span> prev<span class="token punctuation">,</span> <span class="token keyword">long</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> valueOffset<span class="token punctuation">,</span> prev<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// çœç•¥ä¸é‡è¦ä»£ç </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Cell æ˜¯æ•°ç»„å½¢å¼ï¼Œ<strong>åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„</strong>ï¼Œ64 ä½ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ª Cell ä¸º 24 å­—èŠ‚ï¼ˆ16 å­—èŠ‚çš„å¯¹è±¡å¤´å’Œ 8 å­—èŠ‚çš„ valueï¼‰ï¼Œæ¯ä¸€ä¸ª cache line ä¸º 64 å­—èŠ‚ï¼Œå› æ­¤ç¼“å­˜è¡Œå¯ä»¥å­˜ä¸‹ 2 ä¸ªçš„ Cell å¯¹è±¡ï¼Œå½“ Core-0 è¦ä¿®æ”¹ Cell[0]ã€Core-1 è¦ä¿®æ”¹ Cell[1]ï¼Œæ— è®ºè°ä¿®æ”¹æˆåŠŸéƒ½ä¼šå¯¼è‡´å½“å‰ç¼“å­˜è¡Œå¤±æ•ˆï¼Œä»è€Œå¯¼è‡´å¯¹æ–¹çš„æ•°æ®å¤±æ•ˆï¼Œéœ€è¦é‡æ–°å»ä¸»å­˜è·å–ï¼Œå½±å“æ•ˆç‡</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ä¼ªå…±äº«1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>@sun.misc.Contendedï¼šé˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«ï¼Œåœ¨ä½¿ç”¨æ­¤æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µçš„å‰åå„å¢åŠ  128 å­—èŠ‚å¤§å°çš„ paddingï¼Œä½¿ç”¨ 2 å€äºå¤§å¤šæ•°ç¡¬ä»¶ç¼“å­˜è¡Œè®© CPU å°†å¯¹è±¡é¢„è¯»è‡³ç¼“å­˜æ—¶<strong>å ç”¨ä¸åŒçš„ç¼“å­˜è¡Œ</strong>ï¼Œè¿™æ ·å°±ä¸ä¼šé€ æˆå¯¹æ–¹ç¼“å­˜è¡Œçš„å¤±æ•ˆ</p><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ä¼ªå…±äº«2.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="æºç è§£æ" tabindex="-1"><a class="header-anchor" href="#æºç è§£æ"><span>æºç è§£æ</span></a></h3><p>Striped64 ç±»æˆå‘˜å±æ€§ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// è¡¨ç¤ºå½“å‰è®¡ç®—æœºCPUæ•°é‡</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NCPU</span> <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// ç´¯åŠ å•å…ƒæ•°ç»„, æ‡’æƒ°åˆå§‹åŒ–</span>
<span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cells<span class="token punctuation">;</span>
<span class="token comment">// åŸºç¡€å€¼, å¦‚æœæ²¡æœ‰ç«äº‰, åˆ™ç”¨ cas ç´¯åŠ è¿™ä¸ªåŸŸï¼Œå½“ cells æ‰©å®¹æ—¶ï¼Œä¹Ÿä¼šå°†æ•°æ®å†™åˆ° base ä¸­</span>
<span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> base<span class="token punctuation">;</span>
<span class="token comment">// åœ¨ cells åˆå§‹åŒ–æˆ–æ‰©å®¹æ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ, é€šè¿‡ CAS æ›´æ–° cellsBusy ç½®ä¸º 1 æ¥å®ç°ä¸€ä¸ªé”</span>
<span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> cellsBusy<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å·¥ä½œæµç¨‹ï¼š</p><ul><li>cells å ç”¨å†…å­˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¤§çš„ï¼Œæ˜¯æƒ°æ€§åŠ è½½çš„ï¼Œåœ¨æ— ç«äº‰æˆ–è€…å…¶ä»–çº¿ç¨‹æ­£åœ¨åˆå§‹åŒ– cells æ•°ç»„çš„æƒ…å†µä¸‹ï¼Œç›´æ¥æ›´æ–° base åŸŸ</li><li>åœ¨ç¬¬ä¸€æ¬¡å‘ç”Ÿç«äº‰æ—¶ï¼ˆcasBase å¤±è´¥ï¼‰ä¼šåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º 2 çš„ cells æ•°ç»„ï¼Œå°†å½“å‰ç´¯åŠ çš„å€¼åŒ…è£…ä¸º Cell å¯¹è±¡ï¼Œæ”¾å…¥æ˜ å°„çš„æ§½ä½ä¸Š</li><li>åˆ†æ®µç´¯åŠ çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹å¯¹åº”çš„ cells æ§½ä½ä¸ºç©ºï¼Œå°±ä¼šæ–°å»º Cell å¡«å……ï¼Œå¦‚æœå‡ºç°ç«äº‰ï¼Œå°±ä¼šé‡æ–°è®¡ç®—çº¿ç¨‹å¯¹åº”çš„æ§½ä½ï¼Œç»§ç»­è‡ªæ—‹å°è¯•ä¿®æ”¹</li><li>åˆ†æ®µè¿ç§»åè¿˜å‡ºç°ç«äº‰å°±ä¼šæ‰©å®¹ cells æ•°ç»„é•¿åº¦ä¸ºåŸæ¥çš„ä¸¤å€ï¼Œç„¶å rehashï¼Œ<strong>æ•°ç»„é•¿åº¦æ€»æ˜¯ 2 çš„ n æ¬¡å¹‚</strong>ï¼Œé»˜è®¤æœ€å¤§ä¸º CPU æ ¸æ•°ï¼Œä½†æ˜¯å¯ä»¥è¶…è¿‡ï¼Œå¦‚æœæ ¸æ•°æ˜¯ 6 æ ¸ï¼Œæ•°ç»„æœ€é•¿æ˜¯ 8</li></ul><p>æ–¹æ³•åˆ†æï¼š</p><ul><li>LongAdder#addï¼šç´¯åŠ æ–¹æ³•</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// as ä¸ºç´¯åŠ å•å…ƒæ•°ç»„çš„å¼•ç”¨ï¼Œb ä¸ºåŸºç¡€å€¼ï¼Œv è¡¨ç¤ºæœŸæœ›å€¼</span>
    <span class="token comment">// m è¡¨ç¤º cells æ•°ç»„çš„é•¿åº¦ - 1ï¼Œa è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„ cell å•å…ƒæ ¼</span>
    <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> as<span class="token punctuation">;</span> <span class="token keyword">long</span> b<span class="token punctuation">,</span> v<span class="token punctuation">;</span> <span class="token keyword">int</span> m<span class="token punctuation">;</span> <span class="token class-name">Cell</span> a<span class="token punctuation">;</span>
    
    <span class="token comment">// cells ä¸ä¸ºç©ºè¯´æ˜ cells å·²ç»è¢«åˆå§‹åŒ–ï¼Œçº¿ç¨‹å‘ç”Ÿäº†ç«äº‰ï¼Œå»æ›´æ–°å¯¹åº”çš„ cell æ§½ä½</span>
    <span class="token comment">// è¿›å…¥ || åçš„é€»è¾‘å»æ›´æ–° base åŸŸï¼Œæ›´æ–°å¤±è´¥è¡¨ç¤ºå‘ç”Ÿç«äº‰è¿›å…¥æ¡ä»¶</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>as <span class="token operator">=</span> cells<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">casBase</span><span class="token punctuation">(</span>b <span class="token operator">=</span> base<span class="token punctuation">,</span> b <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// uncontended ä¸º true è¡¨ç¤º cell æ²¡æœ‰ç«äº‰</span>
        <span class="token keyword">boolean</span> uncontended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        
        <span class="token comment">// æ¡ä»¶ä¸€: true è¯´æ˜ cells æœªåˆå§‹åŒ–ï¼Œå¤šçº¿ç¨‹å†™ base å‘ç”Ÿç«äº‰éœ€è¦è¿›è¡Œåˆå§‹åŒ– cells æ•°ç»„</span>
        <span class="token comment">//		  fasle è¯´æ˜ cells å·²ç»åˆå§‹åŒ–ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªæ¡ä»¶å¯»æ‰¾è‡ªå·±çš„ cell å»ç´¯åŠ </span>
        <span class="token comment">// æ¡ä»¶äºŒ: getProbe() è·å– hash å€¼ï¼Œ&amp; m çš„é€»è¾‘å’Œ HashMap çš„é€»è¾‘ç›¸åŒï¼Œä¿è¯æ•£åˆ—çš„å‡åŒ€æ€§</span>
        <span class="token comment">// 		  true è¯´æ˜å½“å‰çº¿ç¨‹å¯¹åº”ä¸‹æ ‡çš„ cell ä¸ºç©ºï¼Œéœ€è¦åˆ›å»º cell</span>
        <span class="token comment">//        false è¯´æ˜å½“å‰çº¿ç¨‹å¯¹åº”çš„ cell ä¸ä¸ºç©ºï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªæ¡ä»¶ã€å°† x å€¼ç´¯åŠ åˆ°å¯¹åº”çš„ cell ä¸­ã€‘</span>
        <span class="token comment">// æ¡ä»¶ä¸‰: æœ‰å–åç¬¦å·ï¼Œfalse è¯´æ˜ cas æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œtrue è¯´æ˜å¤±è´¥ï¼Œå½“å‰çº¿ç¨‹å¯¹åº”çš„ cell æœ‰ç«äº‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>as <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> as<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>a <span class="token operator">=</span> as<span class="token punctuation">[</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
            <span class="token operator">!</span><span class="token punctuation">(</span>uncontended <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">cas</span><span class="token punctuation">(</span>v <span class="token operator">=</span> a<span class="token punctuation">.</span>value<span class="token punctuation">,</span> v <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">longAccumulate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> uncontended<span class="token punctuation">)</span><span class="token punctuation">;</span>
        	<span class="token comment">// ã€uncontended åœ¨å¯¹åº”çš„ cell ä¸Šç´¯åŠ å¤±è´¥çš„æ—¶å€™æ‰ä¸º falseï¼Œå…¶ä½™æƒ…å†µå‡ä¸º trueã€‘</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Striped64#longAccumulateï¼šcell æ•°ç»„åˆ›å»º</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>							<span class="token comment">// x  			null 			false | true</span>
<span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">longAccumulate</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token class-name">LongBinaryOperator</span> fn<span class="token punctuation">,</span> <span class="token keyword">boolean</span> wasUncontended<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> h<span class="token punctuation">;</span>
    <span class="token comment">// å½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰å¯¹åº”çš„ cell, éœ€è¦éšæœºç”Ÿæˆä¸€ä¸ª hash å€¼ç”¨æ¥å°†å½“å‰çº¿ç¨‹ç»‘å®šåˆ° cell</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> <span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆå§‹åŒ– probeï¼Œè·å– hash å€¼</span>
        <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        h <span class="token operator">=</span> <span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
        <span class="token comment">// é»˜è®¤æƒ…å†µä¸‹ å½“å‰çº¿ç¨‹è‚¯å®šæ˜¯å†™å…¥åˆ°äº† cells[0] ä½ç½®ï¼Œä¸æŠŠå®ƒå½“åšä¸€æ¬¡çœŸæ­£çš„ç«äº‰</span>
        wasUncontended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¡¨ç¤ºã€æ‰©å®¹æ„å‘ã€‘ï¼Œfalse ä¸€å®šä¸ä¼šæ‰©å®¹ï¼Œtrue å¯èƒ½ä¼šæ‰©å®¹</span>
    <span class="token keyword">boolean</span> collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
    <span class="token comment">//è‡ªæ—‹</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// as è¡¨ç¤ºcellså¼•ç”¨ï¼Œa è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„ cellï¼Œn è¡¨ç¤º cells æ•°ç»„é•¿åº¦ï¼Œv è¡¨ç¤º æœŸæœ›å€¼</span>
        <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> as<span class="token punctuation">;</span> <span class="token class-name">Cell</span> a<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">;</span> <span class="token keyword">long</span> v<span class="token punctuation">;</span>
        <span class="token comment">// ã€CASE1ã€‘: è¡¨ç¤º cells å·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®å†™å…¥åˆ°å¯¹åº”çš„ cell ä¸­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>as <span class="token operator">=</span> cells<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> as<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// CASE1.1: true è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯¹åº”çš„ç´¢å¼•ä¸‹æ ‡çš„ Cell ä¸º nullï¼Œéœ€è¦åˆ›å»º new Cell</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">=</span> as<span class="token punctuation">[</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> h<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// åˆ¤æ–­ cellsBusy æ˜¯å¦è¢«é”</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   
                    <span class="token comment">// åˆ›å»º cell, åˆå§‹ç´¯åŠ å€¼ä¸º x</span>
                    <span class="token class-name">Cell</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cell</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token comment">// åŠ é”</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">casCellsBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// åˆ›å»ºæˆåŠŸæ ‡è®°ï¼Œè¿›å…¥ã€åˆ›å»º cell é€»è¾‘ã€‘</span>
                        <span class="token keyword">boolean</span> created <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>	
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rs<span class="token punctuation">;</span> <span class="token keyword">int</span> m<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
                            <span class="token comment">// æŠŠå½“å‰ cells æ•°ç»„èµ‹å€¼ç»™ rsï¼Œå¹¶ä¸”ä¸ä¸º null</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">=</span> cells<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                                <span class="token punctuation">(</span>m <span class="token operator">=</span> rs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                                <span class="token comment">// å†æ¬¡åˆ¤æ–­é˜²æ­¢å…¶å®ƒçº¿ç¨‹åˆå§‹åŒ–è¿‡è¯¥ä½ç½®ï¼Œå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–è¯¥ä½ç½®ä¼šé€ æˆæ•°æ®ä¸¢å¤±</span>
                                <span class="token comment">// å› ä¸ºè¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ¤æ–­ï¼Œè¿›è¡Œçš„é€»è¾‘ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å½±å“</span>
                                rs<span class="token punctuation">[</span>j <span class="token operator">=</span> <span class="token punctuation">(</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> h<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment">// æŠŠæ–°åˆ›å»ºçš„ cell å¡«å……è‡³å½“å‰ä½ç½®</span>
                                rs<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span>
                                created <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>	<span class="token comment">// è¡¨ç¤ºåˆ›å»ºå®Œæˆ</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                            cellsBusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">// è§£é”</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>created<span class="token punctuation">)</span>			<span class="token comment">// true è¡¨ç¤ºåˆ›å»ºå®Œæˆï¼Œå¯ä»¥æ¨å‡ºå¾ªç¯äº†</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// CASE1.2: æ¡ä»¶æˆç«‹è¯´æ˜çº¿ç¨‹å¯¹åº”çš„ cell æœ‰ç«äº‰, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasUncontended<span class="token punctuation">)</span>
                wasUncontended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// CASE 1.3: å½“å‰çº¿ç¨‹ rehash è¿‡ï¼Œå¦‚æœæ–°å‘½ä¸­çš„ cell ä¸ä¸ºç©ºï¼Œå°±å°è¯•ç´¯åŠ ï¼Œfalse è¯´æ˜æ–°å‘½ä¸­ä¹Ÿæœ‰ç«äº‰</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">cas</span><span class="token punctuation">(</span>v <span class="token operator">=</span> a<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> v <span class="token operator">+</span> x <span class="token operator">:</span> fn<span class="token punctuation">.</span><span class="token function">applyAsLong</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">// CASE 1.4: cells é•¿åº¦å·²ç»è¶…è¿‡äº†æœ€å¤§é•¿åº¦ CPU å†…æ ¸çš„æ•°é‡æˆ–è€…å·²ç»æ‰©å®¹</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;=</span> <span class="token constant">NCPU</span> <span class="token operator">||</span> cells <span class="token operator">!=</span> as<span class="token punctuation">)</span>
                collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 		<span class="token comment">// æ‰©å®¹æ„å‘æ”¹ä¸ºfalseï¼Œã€è¡¨ç¤ºä¸èƒ½æ‰©å®¹äº†ã€‘</span>
            <span class="token comment">// CASE 1.5: æ›´æ”¹æ‰©å®¹æ„å‘ï¼Œå¦‚æœ n &gt;= NCPUï¼Œè¿™é‡Œå°±æ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°ï¼Œcase1.4 æ°¸è¿œå…ˆäº 1.5 æ‰§è¡Œ</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>collide<span class="token punctuation">)</span>
                collide <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// CASE 1.6: ã€æ‰©å®¹é€»è¾‘ã€‘ï¼Œè¿›è¡ŒåŠ é”</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">casCellsBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// çº¿ç¨‹å®‰å…¨çš„æ£€æŸ¥ï¼Œé˜²æ­¢æœŸé—´è¢«å…¶ä»–çº¿ç¨‹æ‰©å®¹äº†</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cells <span class="token operator">==</span> as<span class="token punctuation">)</span> <span class="token punctuation">{</span>     
                        <span class="token comment">// æ‰©å®¹ä¸ºä»¥å‰çš„ 2 å€</span>
                        <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cell</span><span class="token punctuation">[</span>n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token comment">// éå†ç§»åŠ¨å€¼</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
                            rs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token comment">// æŠŠæ‰©å®¹åçš„å¼•ç”¨ç»™ cells</span>
                        cells <span class="token operator">=</span> rs<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    cellsBusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">// è§£é”</span>
                <span class="token punctuation">}</span>
                collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>	<span class="token comment">// æ‰©å®¹æ„å‘æ”¹ä¸º falseï¼Œè¡¨ç¤ºä¸æ‰©å®¹äº†</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// é‡ç½®å½“å‰çº¿ç¨‹ Hash å€¼ï¼Œè¿™å°±æ˜¯ã€åˆ†æ®µè¿ç§»æœºåˆ¶ã€‘</span>
            h <span class="token operator">=</span> <span class="token function">advanceProbe</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ã€CASE2ã€‘: è¿è¡Œåˆ°è¿™è¯´æ˜ cells è¿˜æœªåˆå§‹åŒ–ï¼Œas ä¸ºnull</span>
        <span class="token comment">// åˆ¤æ–­æ˜¯å¦æ²¡æœ‰åŠ é”ï¼Œæ²¡æœ‰åŠ é”å°±ç”¨ CAS åŠ é”</span>
        <span class="token comment">// æ¡ä»¶äºŒåˆ¤æ–­æ˜¯å¦å…¶å®ƒçº¿ç¨‹åœ¨å½“å‰çº¿ç¨‹ç»™ as èµ‹å€¼ä¹‹åä¿®æ”¹äº† cellsï¼Œè¿™é‡Œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ¤æ–­</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> cells <span class="token operator">==</span> as <span class="token operator">&amp;&amp;</span> <span class="token function">casCellsBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆå§‹åŒ–æ ‡å¿—ï¼Œå¼€å§‹ ã€åˆå§‹åŒ– cells æ•°ç»„ã€‘</span>
            <span class="token keyword">boolean</span> init <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span> 
               	<span class="token comment">// å†æ¬¡åˆ¤æ–­ cells == as é˜²æ­¢å…¶å®ƒçº¿ç¨‹å·²ç»æå‰åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–å¯¼è‡´ä¸¢å¤±æ•°æ®</span>
                <span class="token comment">// å› ä¸ºè¿™é‡Œæ˜¯ã€çº¿ç¨‹å®‰å…¨çš„ï¼Œé‡æ–°æ£€æŸ¥ï¼Œç»å…¸ DCLã€‘</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cells <span class="token operator">==</span> as<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> rs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment">// åˆå§‹åŒ–æ•°ç»„å¤§å°ä¸º2</span>
                    rs<span class="token punctuation">[</span>h <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cell</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// å¡«å……çº¿ç¨‹å¯¹åº”çš„cell</span>
                    cells <span class="token operator">=</span> rs<span class="token punctuation">;</span>
                    init <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>				<span class="token comment">// åˆå§‹åŒ–æˆåŠŸï¼Œæ ‡è®°ç½®ä¸º true</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                cellsBusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>					<span class="token comment">// è§£é”å•Š</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>init<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>							<span class="token comment">// åˆå§‹åŒ–æˆåŠŸç›´æ¥è·³å‡ºè‡ªæ—‹</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ã€CASE3ã€‘: è¿è¡Œåˆ°è¿™è¯´æ˜å…¶ä»–çº¿ç¨‹åœ¨åˆå§‹åŒ– cellsï¼Œå½“å‰çº¿ç¨‹å°†å€¼ç´¯åŠ åˆ° baseï¼Œç´¯åŠ æˆåŠŸç›´æ¥ç»“æŸè‡ªæ—‹</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casBase</span><span class="token punctuation">(</span>v <span class="token operator">=</span> base<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> v <span class="token operator">+</span> x <span class="token operator">:</span>
                                    fn<span class="token punctuation">.</span><span class="token function">applyAsLong</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>sumï¼šè·å–æœ€ç»ˆç»“æœé€šè¿‡ sum æ•´åˆï¼Œ<strong>ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸ä¿è¯å¼ºä¸€è‡´æ€§</strong></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Cell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> as <span class="token operator">=</span> cells<span class="token punctuation">;</span> <span class="token class-name">Cell</span> a<span class="token punctuation">;</span>
    <span class="token keyword">long</span> sum <span class="token operator">=</span> base<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>as <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// éå† ç´¯åŠ </span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> as<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">=</span> as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                sum <span class="token operator">+=</span> a<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="aba" tabindex="-1"><a class="header-anchor" href="#aba"><span>ABA</span></a></h2><p>ABA é—®é¢˜ï¼šå½“è¿›è¡Œè·å–ä¸»å†…å­˜å€¼æ—¶ï¼Œè¯¥å†…å­˜å€¼åœ¨å†™å…¥ä¸»å†…å­˜æ—¶å·²ç»è¢«ä¿®æ”¹äº† N æ¬¡ï¼Œä½†æ˜¯æœ€ç»ˆåˆæ”¹æˆåŸæ¥çš„å€¼</p><p>å…¶ä»–çº¿ç¨‹å…ˆæŠŠ A æ”¹æˆ B åˆæ”¹å› Aï¼Œä¸»çº¿ç¨‹<strong>ä»…èƒ½åˆ¤æ–­å‡ºå…±äº«å˜é‡çš„å€¼ä¸æœ€åˆå€¼ A æ˜¯å¦ç›¸åŒ</strong>ï¼Œä¸èƒ½æ„ŸçŸ¥åˆ°è¿™ç§ä» A æ”¹ä¸º B åˆ æ”¹å› A çš„æƒ…å†µï¼Œè¿™æ—¶ CAS è™½ç„¶æˆåŠŸï¼Œä½†æ˜¯è¿‡ç¨‹å­˜åœ¨é—®é¢˜</p><ul><li><p>æ„é€ æ–¹æ³•ï¼š</p></li><li><p><code>public AtomicStampedReference(V initialRef, int initialStamp)</code>ï¼šåˆå§‹å€¼å’Œåˆå§‹ç‰ˆæœ¬å·</p></li><li><p>å¸¸ç”¨APIï¼š</p></li><li><p><code>public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp)</code>ï¼š<strong>æœŸæœ›å¼•ç”¨å’ŒæœŸæœ›ç‰ˆæœ¬å·éƒ½ä¸€è‡´</strong>æ‰è¿›è¡Œ CAS ä¿®æ”¹æ•°æ®</p></li><li><p><code>public void set(V newReference, int newStamp)</code>ï¼šè®¾ç½®å€¼å’Œç‰ˆæœ¬å·</p></li><li><p><code>public V getReference()</code>ï¼šè¿”å›å¼•ç”¨çš„å€¼</p></li><li><p><code>public int getStamp()</code>ï¼šè¿”å›å½“å‰ç‰ˆæœ¬å·</p></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AtomicStampedReference</span>\<span class="token operator">&lt;</span><span class="token class-name">Integer</span>\<span class="token operator">&gt;</span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicStampedReference</span>\<span class="token operator">&lt;</span>\<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> startStamp <span class="token operator">=</span> atomicReference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> stamp <span class="token operator">=</span> atomicReference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> stamp<span class="token punctuation">,</span> stamp <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stamp <span class="token operator">=</span> atomicReference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> stamp<span class="token punctuation">,</span> stamp <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> startStamp<span class="token punctuation">,</span> startStamp <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">getReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//100</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;çº¿ç¨‹ä¿®æ”¹å¤±è´¥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="unsafe" tabindex="-1"><a class="header-anchor" href="#unsafe"><span>Unsafe</span></a></h2><p>Unsafe æ˜¯ CAS çš„æ ¸å¿ƒç±»ï¼Œç”±äº Java æ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿï¼Œéœ€è¦é€šè¿‡æœ¬åœ°ï¼ˆNativeï¼‰æ–¹æ³•æ¥è®¿é—®</p><p>Unsafe ç±»å­˜åœ¨ sun.misc åŒ…ï¼Œå…¶ä¸­æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ native ä¿®é¥°çš„ï¼Œéƒ½æ˜¯ç›´æ¥è°ƒç”¨<strong>æ“ä½œç³»ç»Ÿåº•å±‚èµ„æº</strong>æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ï¼ŒåŸºäºè¯¥ç±»å¯ä»¥ç›´æ¥æ“ä½œç‰¹å®šçš„å†…å­˜æ•°æ®ï¼Œå…¶å†…éƒ¨æ–¹æ³•æ“ä½œç±»ä¼¼ C çš„æŒ‡é’ˆ</p><p>æ¨¡æ‹Ÿå®ç°åŸå­æ•´æ•°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MyAtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyAtomicInteger</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>atomicInteger<span class="token punctuation">.</span><span class="token function">compareAndSwap</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicInteger<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyAtomicInteger</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Unsafe</span> <span class="token constant">UNSAFE</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">VALUE_OFFSET</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//Unsafe unsafe = Unsafe.getUnsafe()è¿™æ ·ä¼šæŠ¥é”™ï¼Œéœ€è¦åå°„è·å–</span>
            <span class="token class-name">Field</span> theUnsafe <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;theUnsafe&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            theUnsafe<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token constant">UNSAFE</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Unsafe</span><span class="token punctuation">)</span> theUnsafe<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è·å– value å±æ€§çš„å†…å­˜åœ°å€ï¼Œvalue å±æ€§æŒ‡å‘è¯¥åœ°å€ï¼Œç›´æ¥è®¾ç½®è¯¥åœ°å€çš„å€¼å¯ä»¥ä¿®æ”¹ value çš„å€¼</span>
            <span class="token constant">VALUE_OFFSET</span> <span class="token operator">=</span> <span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">objectFieldOffset</span><span class="token punctuation">(</span>
                		   <span class="token class-name">MyAtomicInteger</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> <span class="token operator">|</span> <span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">MyAtomicInteger</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSwap</span><span class="token punctuation">(</span><span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">int</span> next <span class="token operator">=</span> update<span class="token punctuation">;</span>
            <span class="token comment">//							å½“å‰å¯¹è±¡  å†…å­˜åç§»é‡    æœŸæœ›å€¼ æ›´æ–°å€¼</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">UNSAFE</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">VALUE_OFFSET</span><span class="token punctuation">,</span> prev<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;CASæˆåŠŸ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="final" tabindex="-1"><a class="header-anchor" href="#final"><span>final</span></a></h2><h3 id="åŸç†-1" tabindex="-1"><a class="header-anchor" href="#åŸç†-1"><span>åŸç†</span></a></h3><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestFinal</span> <span class="token punctuation">{</span>
	<span class="token keyword">final</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å­—èŠ‚ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token number">0</span><span class="token operator">:</span> aload_0
<span class="token number">1</span><span class="token operator">:</span> invokespecial #<span class="token number">1</span> <span class="token comment">// Method java/lang/Object.&quot;\&lt;init\&gt;&quot;:()V</span>
<span class="token number">4</span><span class="token operator">:</span> aload_0
<span class="token number">5</span><span class="token operator">:</span> bipush <span class="token number">20</span>		<span class="token comment">// å°†å€¼ç›´æ¥æ”¾å…¥æ ˆä¸­</span>
<span class="token number">7</span><span class="token operator">:</span> putfield #<span class="token number">2</span> 		<span class="token comment">// Field a:I</span>
<span class="token operator">&lt;</span><span class="token operator">--</span> å†™å±éšœ
<span class="token number">10</span><span class="token operator">:</span> <span class="token keyword">return</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>final å˜é‡çš„èµ‹å€¼é€šè¿‡ putfield æŒ‡ä»¤æ¥å®Œæˆï¼Œåœ¨è¿™æ¡æŒ‡ä»¤ä¹‹åä¹Ÿä¼šåŠ å…¥å†™å±éšœï¼Œä¿è¯åœ¨å…¶å®ƒçº¿ç¨‹è¯»åˆ°å®ƒçš„å€¼æ—¶ä¸ä¼šå‡ºç°ä¸º 0 çš„æƒ…å†µ</p><p>å…¶ä»–çº¿ç¨‹è®¿é—® final ä¿®é¥°çš„å˜é‡</p><ul><li><strong>å¤åˆ¶ä¸€ä»½æ”¾å…¥æ ˆä¸­</strong>ç›´æ¥è®¿é—®ï¼Œæ•ˆç‡é«˜</li><li>å¤§äº short æœ€å¤§å€¼ä¼šå°†å…¶å¤åˆ¶åˆ°ç±»çš„å¸¸é‡æ± ï¼Œè®¿é—®æ—¶ä»å¸¸é‡æ± è·å–</li></ul><h3 id="ä¸å¯å˜" tabindex="-1"><a class="header-anchor" href="#ä¸å¯å˜"><span>ä¸å¯å˜</span></a></h3><p>ä¸å¯å˜ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡ä¸èƒ½å¤Ÿä¿®æ”¹å…¶å†…éƒ¨çŠ¶æ€ï¼ˆå±æ€§ï¼‰ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸å¯å˜å¯¹è±¡</p><p>ä¸å¯å˜å¯¹è±¡çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸å­˜åœ¨å¹¶å‘ä¿®æ”¹å’Œå¯è§æ€§é—®é¢˜ï¼Œæ˜¯å¦ä¸€ç§é¿å…ç«äº‰çš„æ–¹å¼</p><p>String ç±»ä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œè¯¥ç±»å’Œç±»ä¸­æ‰€æœ‰å±æ€§éƒ½æ˜¯ final çš„</p><ul><li>ç±»ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥ç±»ä¸­çš„æ–¹æ³•ä¸èƒ½è¢«è¦†ç›–ï¼Œé˜²æ­¢å­ç±»æ— æ„é—´ç ´åä¸å¯å˜æ€§</li><li>æ— å†™å…¥æ–¹æ³•ï¼ˆsetï¼‰ç¡®ä¿å¤–éƒ¨ä¸èƒ½å¯¹å†…éƒ¨å±æ€§è¿›è¡Œä¿®æ”¹</li><li>å±æ€§ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸èƒ½ä¿®æ”¹</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">String</span>
    <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span><span class="token punctuation">,</span> <span class="token class-name">Comparable</span>\<span class="token operator">&lt;</span><span class="token class-name">String</span>\<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">CharSequence</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/** The value is used for character storage. */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//....</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ›´æ”¹ String ç±»æ•°æ®æ—¶ï¼Œä¼šæ„é€ æ–°å­—ç¬¦ä¸²å¯¹è±¡ï¼Œç”Ÿæˆæ–°çš„ char[] valueï¼Œé€šè¿‡<strong>åˆ›å»ºå‰¯æœ¬å¯¹è±¡æ¥é¿å…å…±äº«çš„æ–¹å¼ç§°ä¹‹ä¸ºä¿æŠ¤æ€§æ‹·è´</strong></li></ul><h2 id="state" tabindex="-1"><a class="header-anchor" href="#state"><span>State</span></a></h2><p>æ— çŠ¶æ€ï¼šæˆå‘˜å˜é‡ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥ç§°ä¸ºçŠ¶æ€ä¿¡æ¯ï¼Œæ— çŠ¶æ€å°±æ˜¯æ²¡æœ‰æˆå‘˜å˜é‡</p><p>Servlet ä¸ºäº†ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ï¼Œä¸€èˆ¬ä¸ä¸º Servlet è®¾ç½®æˆå‘˜å˜é‡ï¼Œè¿™ç§æ²¡æœ‰ä»»ä½•æˆå‘˜å˜é‡çš„ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„</p><h2 id="local" tabindex="-1"><a class="header-anchor" href="#local"><span>Local</span></a></h2><h3 id="åŸºæœ¬ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä»‹ç»"><span>åŸºæœ¬ä»‹ç»</span></a></h3><p>ThreadLocal ç±»ç”¨æ¥æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œè¿™ç§å˜é‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è®¿é—®ï¼ˆé€šè¿‡ get å’Œ set æ–¹æ³•è®¿é—®ï¼‰æ—¶èƒ½ä¿è¯å„ä¸ªçº¿ç¨‹çš„å˜é‡ç›¸å¯¹ç‹¬ç«‹äºå…¶ä»–çº¿ç¨‹å†…çš„å˜é‡ï¼Œåˆ†é…åœ¨å †å†…çš„ <strong>TLAB</strong> ä¸­</p><p>ThreadLocal å®ä¾‹é€šå¸¸æ¥è¯´éƒ½æ˜¯ <code>private static</code> ç±»å‹çš„ï¼Œå±äºä¸€ä¸ªçº¿ç¨‹çš„æœ¬åœ°å˜é‡ï¼Œç”¨äºå…³è”çº¿ç¨‹å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šåœ¨ ThreadLocal ä¸­ä¿å­˜ä¸€ä»½è¯¥çº¿ç¨‹ç‹¬æœ‰çš„æ•°æ®ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„</p><p>ThreadLocal ä½œç”¨ï¼š</p><ul><li>çº¿ç¨‹å¹¶å‘ï¼šåº”ç”¨åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„åœºæ™¯ä¸‹</li><li>ä¼ é€’æ•°æ®ï¼šé€šè¿‡ ThreadLocal å®ç°åœ¨åŒä¸€çº¿ç¨‹ä¸åŒå‡½æ•°æˆ–ç»„ä»¶ä¸­ä¼ é€’å…¬å…±å˜é‡ï¼Œå‡å°‘ä¼ é€’å¤æ‚åº¦</li><li>çº¿ç¨‹éš”ç¦»ï¼šæ¯ä¸ªçº¿ç¨‹çš„å˜é‡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šäº’ç›¸å½±å“</li></ul><p>å¯¹æ¯” synchronizedï¼š</p><table><thead><tr><th></th><th>synchronized</th><th>ThreadLocal</th></tr></thead><tbody><tr><td>åŸç†</td><td>åŒæ­¥æœºåˆ¶é‡‡ç”¨<strong>ä»¥æ—¶é—´æ¢ç©ºé—´</strong>çš„æ–¹å¼ï¼Œåªæä¾›äº†ä¸€ä»½å˜é‡ï¼Œè®©ä¸åŒçš„çº¿ç¨‹æ’é˜Ÿè®¿é—®</td><td>ThreadLocal é‡‡ç”¨<strong>ä»¥ç©ºé—´æ¢æ—¶é—´</strong>çš„æ–¹å¼ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æä¾›äº†ä¸€ä»½å˜é‡çš„å‰¯æœ¬ï¼Œä»è€Œå®ç°åŒæ—¶è®¿é—®è€Œç›¸ä¸å¹²æ‰°</td></tr><tr><td>ä¾§é‡ç‚¹</td><td>å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥</td><td>å¤šçº¿ç¨‹ä¸­è®©æ¯ä¸ªçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»</td></tr></tbody></table><h3 id="åŸºæœ¬ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨"><span>åŸºæœ¬ä½¿ç”¨</span></a></h3><h4 id="å¸¸ç”¨æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#å¸¸ç”¨æ–¹æ³•"><span>å¸¸ç”¨æ–¹æ³•</span></a></h4><table><thead><tr><th>æ–¹æ³•</th><th>æè¿°</th></tr></thead><tbody><tr><td>ThreadLocal&lt;&gt;()</td><td>åˆ›å»º ThreadLocal å¯¹è±¡</td></tr><tr><td>protected T initialValue()</td><td>è¿”å›å½“å‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼</td></tr><tr><td>public void set( T value)</td><td>è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public T get()</td><td>è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public void remove()</td><td>ç§»é™¤å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr></tbody></table><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token class-name">String</span>\<span class="token operator">&gt;</span> tl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span>\<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å˜é‡</span>
        <span class="token keyword">return</span> tl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å˜é‡contentç»‘å®šåˆ°å½“å‰çº¿ç¨‹</span>
        tl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyDemo</span> demo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è®¾ç½®æ•°æ®</span>
                    demo<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;çš„æ•°æ®&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;-----------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;---&gt;&quot;</span> <span class="token operator">+</span> demo<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;çº¿ç¨‹&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åº”ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨åœºæ™¯"><span>åº”ç”¨åœºæ™¯</span></a></h4><p>ThreadLocal é€‚ç”¨äºä¸‹é¢ä¸¤ç§åœºæ™¯ï¼š</p><ul><li>æ¯ä¸ªçº¿ç¨‹éœ€è¦æœ‰è‡ªå·±å•ç‹¬çš„å®ä¾‹</li><li>å®ä¾‹éœ€è¦åœ¨å¤šä¸ªæ–¹æ³•ä¸­å…±äº«ï¼Œä½†ä¸å¸Œæœ›è¢«å¤šçº¿ç¨‹å…±äº«</li></ul><p>ThreadLocal æ–¹æ¡ˆæœ‰ä¸¤ä¸ªçªå‡ºçš„ä¼˜åŠ¿ï¼š</p><ol><li>ä¼ é€’æ•°æ®ï¼šä¿å­˜æ¯ä¸ªçº¿ç¨‹ç»‘å®šçš„æ•°æ®ï¼Œåœ¨éœ€è¦çš„åœ°æ–¹å¯ä»¥ç›´æ¥è·å–ï¼Œé¿å…å‚æ•°ç›´æ¥ä¼ é€’å¸¦æ¥çš„ä»£ç è€¦åˆé—®é¢˜</li><li>çº¿ç¨‹éš”ç¦»ï¼šå„çº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»å´åˆå…·å¤‡å¹¶å‘æ€§ï¼Œé¿å…åŒæ­¥æ–¹å¼å¸¦æ¥çš„æ€§èƒ½æŸå¤±</li></ol><p>ThreadLocal ç”¨äºæ•°æ®è¿æ¥çš„äº‹åŠ¡ç®¡ç†ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcUtils</span> <span class="token punctuation">{</span>
    <span class="token comment">// ThreadLocalå¯¹è±¡ï¼Œå°†connectionç»‘å®šåœ¨å½“å‰çº¿ç¨‹ä¸­</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token class-name">Connection</span>\<span class="token operator">&gt;</span> tl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// c3p0 æ•°æ®åº“è¿æ¥æ± å¯¹è±¡å±æ€§</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ComboPooledDataSource</span> ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComboPooledDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–è¿æ¥</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Connection</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{</span>
        <span class="token comment">//å–å‡ºå½“å‰çº¿ç¨‹ç»‘å®šçš„connectionå¯¹è±¡</span>
        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> tl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä»è¿æ¥æ± ä¸­å–å‡º</span>
            conn <span class="token operator">=</span> ds<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//å†å°†connectionå¯¹è±¡ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ä¸­ï¼Œéå¸¸é‡è¦çš„æ“ä½œ</span>
            tl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> conn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”¨ ThreadLocal ä½¿ SimpleDateFormat ä»ç‹¬äº«å˜é‡å˜æˆå•ä¸ªçº¿ç¨‹å˜é‡ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalDateUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token class-name">DateFormat</span>\<span class="token operator">&gt;</span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token class-name">DateFormat</span>\<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token class-name">DateFormat</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Date</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">String</span> dateStr<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParseException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">Date</span> date<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®ç°åŸç†" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†"><span>å®ç°åŸç†</span></a></h3><h4 id="åº•å±‚ç»“æ„" tabindex="-1"><a class="header-anchor" href="#åº•å±‚ç»“æ„"><span>åº•å±‚ç»“æ„</span></a></h4><p>JDK8 ä»¥å‰ï¼šæ¯ä¸ª ThreadLocal éƒ½åˆ›å»ºä¸€ä¸ª Mapï¼Œç„¶åç”¨çº¿ç¨‹ä½œä¸º Map çš„ keyï¼Œè¦å­˜å‚¨çš„å±€éƒ¨å˜é‡ä½œä¸º Map çš„ valueï¼Œè¾¾åˆ°å„ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡éš”ç¦»çš„æ•ˆæœã€‚è¿™ç§ç»“æ„ä¼šé€ æˆ Map ç»“æ„è¿‡å¤§å’Œå†…å­˜æ³„éœ²ï¼Œå› ä¸º Thread åœæ­¢åæ— æ³•é€šè¿‡ key åˆ é™¤å¯¹åº”çš„æ•°æ®</p><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocalæ•°æ®ç»“æ„JDK8å‰.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>JDK8 ä»¥åï¼šæ¯ä¸ª Thread ç»´æŠ¤ä¸€ä¸ª ThreadLocalMapï¼Œè¿™ä¸ª Map çš„ key æ˜¯ ThreadLocal å®ä¾‹æœ¬èº«ï¼Œvalue æ˜¯çœŸæ­£è¦å­˜å‚¨çš„å€¼</p><ul><li><strong>æ¯ä¸ª Thread çº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª Map (ThreadLocalMap)</strong></li><li>Map é‡Œé¢å­˜å‚¨ ThreadLocal å¯¹è±¡ï¼ˆkeyï¼‰å’Œçº¿ç¨‹çš„ç§æœ‰å˜é‡ï¼ˆvalueï¼‰</li><li>Thread å†…éƒ¨çš„ Map æ˜¯ç”± ThreadLocal ç»´æŠ¤çš„ï¼Œç”± ThreadLocal è´Ÿè´£å‘ map è·å–å’Œè®¾ç½®çº¿ç¨‹çš„å˜é‡å€¼</li><li>å¯¹äºä¸åŒçš„çº¿ç¨‹ï¼Œæ¯æ¬¡è·å–å‰¯æœ¬å€¼æ—¶ï¼Œåˆ«çš„çº¿ç¨‹å¹¶ä¸èƒ½è·å–åˆ°å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å€¼ï¼Œå½¢æˆå‰¯æœ¬çš„éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°</li></ul><figure><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocalæ•°æ®ç»“æ„JDK8å.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>JDK8 å‰åå¯¹æ¯”ï¼š</p><ul><li>æ¯ä¸ª Map å­˜å‚¨çš„ Entry æ•°é‡ä¼šå˜å°‘ï¼Œå› ä¸ºä¹‹å‰çš„å­˜å‚¨æ•°é‡ç”± Thread çš„æ•°é‡å†³å®šï¼Œç°åœ¨ç”± ThreadLocal çš„æ•°é‡å†³å®šï¼Œåœ¨å®é™…ç¼–ç¨‹å½“ä¸­ï¼Œå¾€å¾€ ThreadLocal çš„æ•°é‡è¦å°‘äº Thread çš„æ•°é‡</li><li>å½“ Thread é”€æ¯ä¹‹åï¼Œå¯¹åº”çš„ ThreadLocalMap ä¹Ÿä¼šéšä¹‹é”€æ¯ï¼Œèƒ½å‡å°‘å†…å­˜çš„ä½¿ç”¨ï¼Œ<strong>é˜²æ­¢å†…å­˜æ³„éœ²</strong></li></ul><h4 id="æˆå‘˜å˜é‡" tabindex="-1"><a class="header-anchor" href="#æˆå‘˜å˜é‡"><span>æˆå‘˜å˜é‡</span></a></h4><ul><li>Thread ç±»çš„ç›¸å…³å±æ€§ï¼š<strong>æ¯ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ä¸€ä¸ª ThreadLocalMap å¯¹è±¡</strong>ï¼Œå­˜æ”¾ç”± ThreadLocal å’Œæ•°æ®ç»„æˆçš„ Entry é”®å€¼å¯¹</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>è®¡ç®— ThreadLocal å¯¹è±¡çš„å“ˆå¸Œå€¼ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadLocalHashCode <span class="token operator">=</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä½¿ç”¨ <code>threadLocalHashCode &amp; (table.length - 1)</code> è®¡ç®—å½“å‰ entry éœ€è¦å­˜æ”¾çš„ä½ç½®</p><ul><li>æ¯åˆ›å»ºä¸€ä¸ª ThreadLocal å¯¹è±¡å°±ä¼šä½¿ç”¨ nextHashCode åˆ†é…ä¸€ä¸ª hash å€¼ç»™è¿™ä¸ªå¯¹è±¡ï¼š</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicInteger</span> nextHashCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ–æ³¢é‚£å¥‘æ•°ä¹Ÿå«é»„é‡‘åˆ†å‰²æ•°ï¼Œhash çš„<strong>å¢é‡</strong>å°±æ˜¯è¿™ä¸ªæ•°å­—ï¼Œå¸¦æ¥çš„å¥½å¤„æ˜¯ hash åˆ†å¸ƒéå¸¸å‡åŒ€ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">HASH_INCREMENT</span> <span class="token operator">=</span> <span class="token number">0x61c88647</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="æˆå‘˜æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#æˆå‘˜æ–¹æ³•"><span>æˆå‘˜æ–¹æ³•</span></a></h4><p>æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸º ThreadLocal å±äºä¸€ä¸ªçº¿ç¨‹çš„ï¼ŒThreadLocal ä¸­çš„æ–¹æ³•ï¼Œé€»è¾‘éƒ½æ˜¯è·å–å½“å‰çº¿ç¨‹ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡ï¼Œç„¶åè¿›è¡Œæ•°æ®çš„å¢åˆ æ”¹æŸ¥ï¼Œæ²¡æœ‰æŒ‡å®šåˆå§‹å€¼çš„ threadlcoal å¯¹è±¡é»˜è®¤èµ‹å€¼ä¸º null</p><ul><li><p>initialValue()ï¼šè¿”å›è¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼</p></li><li><p>å»¶è¿Ÿè°ƒç”¨çš„æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œ get æ–¹æ³•æ—¶æ‰æ‰§è¡Œ</p></li><li><p>è¯¥æ–¹æ³•ç¼ºçœï¼ˆé»˜è®¤ï¼‰å®ç°ç›´æ¥è¿”å›ä¸€ä¸ª null</p></li><li><p>å¦‚æœæƒ³è¦ä¸€ä¸ªåˆå§‹å€¼ï¼Œå¯ä»¥é‡å†™æ­¤æ–¹æ³•ï¼Œ è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ª <code>protected</code> çš„æ–¹æ³•ï¼Œä¸ºäº†è®©å­ç±»è¦†ç›–è€Œè®¾è®¡çš„</p></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>nextHashCode()ï¼šè®¡ç®—å“ˆå¸Œå€¼ï¼ŒThreadLocal çš„æ•£åˆ—æ–¹å¼ç§°ä¹‹ä¸º<strong>æ–æ³¢é‚£å¥‘æ•£åˆ—</strong>ï¼Œæ¯æ¬¡è·å–å“ˆå¸Œå€¼éƒ½ä¼šåŠ ä¸Š HASH_INCREMENTï¼Œè¿™æ ·åšå¯ä»¥å°½é‡é¿å… hash å†²çªï¼Œè®©å“ˆå¸Œå€¼èƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨ 2 çš„ n æ¬¡æ–¹çš„æ•°ç»„ä¸­</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å“ˆå¸Œå€¼è‡ªå¢ä¸€ä¸ª HASH_INCREMENT æ•°å€¼</span>
    <span class="token keyword">return</span> nextHashCode<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token constant">HASH_INCREMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>set()ï¼šä¿®æ”¹å½“å‰çº¿ç¨‹ä¸å½“å‰ threadlocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­ map æ˜¯å¦å­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token comment">// è°ƒç”¨ threadLocalMap.set æ–¹æ³•è¿›è¡Œé‡å†™æˆ–è€…æ·»åŠ </span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token comment">// map ä¸ºç©ºï¼Œè°ƒç”¨ createMap è¿›è¡Œ ThreadLocalMap å¯¹è±¡çš„åˆå§‹åŒ–ã€‚å‚æ•°1æ˜¯å½“å‰çº¿ç¨‹ï¼Œå‚æ•°2æ˜¯å±€éƒ¨å˜é‡</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// è·å–å½“å‰çº¿ç¨‹ Thread å¯¹åº”ç»´æŠ¤çš„ ThreadLocalMap </span>
<span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// åˆ›å»ºå½“å‰çº¿ç¨‹Threadå¯¹åº”ç»´æŠ¤çš„ThreadLocalMap </span>
<span class="token keyword">void</span> <span class="token function">createMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">T</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ã€è¿™é‡Œçš„ this æ˜¯è°ƒç”¨æ­¤æ–¹æ³•çš„ threadLocalã€‘ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Map å¹¶è®¾ç½®ç¬¬ä¸€ä¸ªæ•°æ®</span>
    t<span class="token punctuation">.</span>threadLocals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>get()ï¼šè·å–å½“å‰çº¿ç¨‹ä¸å½“å‰ ThreadLocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœæ­¤mapå­˜åœ¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»¥å½“å‰çš„ ThreadLocal ä¸º keyï¼Œè°ƒç”¨ getEntry è·å–å¯¹åº”çš„å­˜å‚¨å®ä½“ e</span>
        <span class="token class-name">ThreadLocalMap<span class="token punctuation">.</span>Entry</span> e <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¯¹ e è¿›è¡Œåˆ¤ç©º </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å–å­˜å‚¨å®ä½“ e å¯¹åº”çš„ valueå€¼</span>
            <span class="token class-name">T</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*æœ‰ä¸¤ç§æƒ…å†µæœ‰æ‰§è¡Œå½“å‰ä»£ç 
      ç¬¬ä¸€ç§æƒ…å†µ: map ä¸å­˜åœ¨ï¼Œè¡¨ç¤ºæ­¤çº¿ç¨‹æ²¡æœ‰ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡
      ç¬¬äºŒç§æƒ…å†µ: map å­˜åœ¨, ä½†æ˜¯ã€æ²¡æœ‰ä¸å½“å‰ ThreadLocal å…³è”çš„ entryã€‘ï¼Œå°±ä¼šè®¾ç½®ä¸ºé»˜è®¤å€¼ */</span>
    <span class="token comment">// åˆå§‹åŒ–å½“å‰çº¿ç¨‹ä¸å½“å‰ threadLocal å¯¹è±¡ç›¸å…³è”çš„ value</span>
    <span class="token keyword">return</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">T</span> <span class="token function">setInitialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è°ƒç”¨initialValueè·å–åˆå§‹åŒ–çš„å€¼ï¼Œæ­¤æ–¹æ³•å¯ä»¥è¢«å­ç±»é‡å†™, å¦‚æœä¸é‡å†™é»˜è®¤è¿”å› null</span>
    <span class="token class-name">T</span> value <span class="token operator">=</span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­ map æ˜¯å¦åˆå§‹åŒ–è¿‡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token comment">// å­˜åœ¨åˆ™è°ƒç”¨ map.set è®¾ç½®æ­¤å®ä½“ entryï¼Œvalue æ˜¯é»˜è®¤çš„å€¼</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token comment">// è°ƒç”¨ createMap è¿›è¡Œ ThreadLocalMap å¯¹è±¡çš„åˆå§‹åŒ–ä¸­</span>
        <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿”å›çº¿ç¨‹ä¸å½“å‰ threadLocal å…³è”çš„å±€éƒ¨å˜é‡</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>remove()ï¼šç§»é™¤å½“å‰çº¿ç¨‹ä¸å½“å‰ threadLocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡</span>
    <span class="token class-name">ThreadLocalMap</span> m <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token comment">// map å­˜åœ¨åˆ™è°ƒç”¨ map.removeï¼Œthisæ—¶å½“å‰ThreadLocalï¼Œä»¥thisä¸ºkeyåˆ é™¤å¯¹åº”çš„å®ä½“</span>
        m<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="localmap" tabindex="-1"><a class="header-anchor" href="#localmap"><span>LocalMap</span></a></h3><h4 id="æˆå‘˜å±æ€§" tabindex="-1"><a class="header-anchor" href="#æˆå‘˜å±æ€§"><span>æˆå‘˜å±æ€§</span></a></h4><p>ThreadLocalMap æ˜¯ ThreadLocal çš„å†…éƒ¨ç±»ï¼Œæ²¡æœ‰å®ç° Map æ¥å£ï¼Œç”¨ç‹¬ç«‹çš„æ–¹å¼å®ç°äº† Map çš„åŠŸèƒ½ï¼Œå…¶å†…éƒ¨ Entry ä¹Ÿæ˜¯ç‹¬ç«‹å®ç°</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// åˆå§‹åŒ–å½“å‰ map å†…éƒ¨æ•£åˆ—è¡¨æ•°ç»„çš„åˆå§‹é•¿åº¦ 16</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">INITIAL_CAPACITY</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

<span class="token comment">// å­˜æ”¾æ•°æ®çš„tableï¼Œæ•°ç»„é•¿åº¦å¿…é¡»æ˜¯2çš„æ•´æ¬¡å¹‚ã€‚</span>
<span class="token keyword">private</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>

<span class="token comment">// æ•°ç»„é‡Œé¢ entrys çš„ä¸ªæ•°ï¼Œå¯ä»¥ç”¨äºåˆ¤æ–­ table å½“å‰ä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// è¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼ï¼Œè¡¨ä½¿ç”¨é‡å¤§äºå®ƒçš„æ—¶å€™è¿›è¡Œæ‰©å®¹ã€‚</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> threshold<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å­˜å‚¨ç»“æ„ Entryï¼š</p><ul><li>Entry ç»§æ‰¿ WeakReferenceï¼Œkey æ˜¯å¼±å¼•ç”¨ï¼Œç›®çš„æ˜¯å°† ThreadLocal å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè§£ç»‘</li><li>Entry é™åˆ¶åªèƒ½ç”¨ ThreadLocal ä½œä¸º keyï¼Œkey ä¸º null (entry.get() == null) æ„å‘³ç€ key ä¸å†è¢«å¼•ç”¨ï¼Œentry ä¹Ÿå¯ä»¥ä» table ä¸­æ¸…é™¤</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span>\<span class="token operator">&lt;</span><span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span>\<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> value<span class="token punctuation">;</span>
    <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// this.referent = referent = key;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
        value <span class="token operator">=</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ„é€ æ–¹æ³•ï¼šå»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œçº¿ç¨‹ç¬¬ä¸€æ¬¡å­˜å‚¨ threadLocal - value æ—¶æ‰ä¼šåˆ›å»º threadLocalMap å¯¹è±¡</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> firstKey<span class="token punctuation">,</span> <span class="token class-name">Object</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆå§‹åŒ–tableï¼Œåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º16çš„Entryæ•°ç»„</span>
    table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token constant">INITIAL_CAPACITY</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// ã€å¯»å€ç®—æ³•ã€‘è®¡ç®—ç´¢å¼•</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> firstKey<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token constant">INITIAL_CAPACITY</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»º entry å¯¹è±¡ï¼Œå­˜æ”¾åˆ°æŒ‡å®šä½ç½®çš„ slot ä¸­</span>
    table<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>firstKey<span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ•°æ®æ€»é‡æ˜¯ 1</span>
    size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">// å°†é˜ˆå€¼è®¾ç½®ä¸º ï¼ˆå½“å‰æ•°ç»„é•¿åº¦ * 2ï¼‰/ 3ã€‚</span>
    <span class="token function">setThreshold</span><span class="token punctuation">(</span><span class="token constant">INITIAL_CAPACITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æˆå‘˜æ–¹æ³•-1" tabindex="-1"><a class="header-anchor" href="#æˆå‘˜æ–¹æ³•-1"><span>æˆå‘˜æ–¹æ³•</span></a></h4><ul><li><p>set()ï¼šæ·»åŠ æ•°æ®ï¼ŒThreadLocalMap ä½¿ç”¨<strong>çº¿æ€§æ¢æµ‹æ³•æ¥è§£å†³å“ˆå¸Œå†²çª</strong></p></li><li><p>è¯¥æ–¹æ³•ä¼šä¸€ç›´æ¢æµ‹ä¸‹ä¸€ä¸ªåœ°å€ï¼Œç›´åˆ°æœ‰ç©ºçš„åœ°å€åæ’å…¥ï¼Œè‹¥æ’å…¥å Map æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œæ•°ç»„ä¼šæ‰©å®¹ä¸ºåŸæ¥çš„ 2 å€ å‡è®¾å½“å‰ table é•¿åº¦ä¸º16ï¼Œè®¡ç®—å‡ºæ¥ key çš„ hash å€¼ä¸º 14ï¼Œå¦‚æœ table[14] ä¸Šå·²ç»æœ‰å€¼ï¼Œå¹¶ä¸”å…¶ key ä¸å½“å‰ key ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±å‘ç”Ÿäº† hash å†²çªï¼Œè¿™ä¸ªæ—¶å€™å°† 14 åŠ  1 å¾—åˆ° 15ï¼Œå– table[15] è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¿˜æ˜¯å†²çªä¼šå›åˆ° 0ï¼Œå– table[0]ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°å¯ä»¥æ’å…¥ï¼Œå¯ä»¥æŠŠ Entry[] table çœ‹æˆä¸€ä¸ª<strong>ç¯å½¢æ•°ç»„</strong></p></li><li><p>çº¿æ€§æ¢æµ‹æ³•ä¼šå‡ºç°<strong>å †ç§¯é—®é¢˜</strong>ï¼Œå¯ä»¥é‡‡å–å¹³æ–¹æ¢æµ‹æ³•è§£å†³</p></li><li><p>åœ¨æ¢æµ‹è¿‡ç¨‹ä¸­ ThreadLocal ä¼šå¤ç”¨ key ä¸º null çš„è„ Entry å¯¹è±¡ï¼Œå¹¶è¿›è¡Œåƒåœ¾æ¸…ç†ï¼Œé˜²æ­¢å‡ºç°å†…å­˜æ³„æ¼</p></li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–æ•£åˆ—è¡¨</span>
    <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap<span class="token punctuation">.</span>Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// å“ˆå¸Œå¯»å€</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•å‘åæŸ¥æ‰¾å…ƒç´ ï¼Œç¢°åˆ° entry ä¸ºç©ºæ—¶åœæ­¢æ¢æµ‹</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap<span class="token punctuation">.</span>Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰å…ƒç´  key</span>
        <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ThreadLocal å¯¹åº”çš„ key å­˜åœ¨ï¼Œã€ç›´æ¥è¦†ç›–ä¹‹å‰çš„å€¼ã€‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ã€è¿™ä¸¤ä¸ªæ¡ä»¶è°å…ˆæˆç«‹ä¸ä¸€å®šï¼Œæ‰€ä»¥ replaceStaleEntry ä¸­è¿˜éœ€è¦åˆ¤æ–­ k == key çš„æƒ…å†µã€‘</span>
        
        <span class="token comment">// key ä¸º nullï¼Œä½†æ˜¯å€¼ä¸ä¸º nullï¼Œè¯´æ˜ä¹‹å‰çš„ ThreadLocal å¯¹è±¡å·²ç»è¢«å›æ”¶äº†ï¼Œå½“å‰æ˜¯ã€è¿‡æœŸæ•°æ®ã€‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ã€ç¢°åˆ°ä¸€ä¸ªè¿‡æœŸçš„ slotï¼Œå½“å‰æ•°æ®å¤ç”¨è¯¥æ§½ä½ï¼Œæ›¿æ¢è¿‡æœŸæ•°æ®ã€‘</span>
            <span class="token comment">// è¿™ä¸ªæ–¹æ³•è¿˜è¿›è¡Œäº†åƒåœ¾æ¸…ç†åŠ¨ä½œï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span>
            <span class="token function">replaceStaleEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// é€»è¾‘åˆ°è¿™è¯´æ˜ç¢°åˆ° slot == null çš„ä½ç½®ï¼Œåˆ™åœ¨ç©ºå…ƒç´ çš„ä½ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„ Entry</span>
    tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ•°é‡ + 1</span>
    <span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token operator">++</span>size<span class="token punctuation">;</span>
    
    <span class="token comment">// ã€åšä¸€æ¬¡å¯å‘å¼æ¸…ç†ã€‘ï¼Œå¦‚æœæ²¡æœ‰æ¸…é™¤ä»»ä½• entry å¹¶ä¸”ã€å½“å‰ä½¿ç”¨é‡è¾¾åˆ°äº†è´Ÿè½½å› å­æ‰€å®šä¹‰ï¼Œé‚£ä¹ˆè¿›è¡Œ rehash</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sz<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sz <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span>
        <span class="token comment">// æ‰©å®¹</span>
        <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// è·å–ã€ç¯å½¢æ•°ç»„ã€‘çš„ä¸‹ä¸€ä¸ªç´¢å¼•</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç´¢å¼•è¶Šç•Œåä» 0 å¼€å§‹ç»§ç»­è·å–</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token operator">?</span> i <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// åœ¨æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šçš„æ•°æ®</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">replaceStaleEntry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> staleSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–æ•£åˆ—è¡¨</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token class-name">Entry</span> e<span class="token punctuation">;</span>
	<span class="token comment">// æ¢æµ‹å¼æ¸…ç†çš„å¼€å§‹ä¸‹æ ‡ï¼Œé»˜è®¤ä»å½“å‰ staleSlot å¼€å§‹</span>
    <span class="token keyword">int</span> slotToExpunge <span class="token operator">=</span> staleSlot<span class="token punctuation">;</span>
    <span class="token comment">// ä»¥å½“å‰ staleSlot å¼€å§‹ã€å‘å‰è¿­ä»£æŸ¥æ‰¾ã€‘ï¼Œæ‰¾åˆ°ç´¢å¼•é å‰è¿‡æœŸæ•°æ®ï¼Œæ‰¾åˆ°ä»¥åæ›¿æ¢ slotToExpunge å€¼</span>
    <span class="token comment">// ã€ä¿è¯åœ¨ä¸€ä¸ªåŒºé—´æ®µå†…ï¼Œä»æœ€å‰é¢çš„è¿‡æœŸæ•°æ®å¼€å§‹æ¸…ç†ã€‘</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">prevIndex</span><span class="token punctuation">(</span>staleSlot<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token function">prevIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            slotToExpunge <span class="token operator">=</span> i<span class="token punctuation">;</span>

	<span class="token comment">// ä»¥ staleSlot ã€å‘åå»æŸ¥æ‰¾ã€‘ï¼Œç›´åˆ°ç¢°åˆ° null ä¸ºæ­¢ï¼Œè¿˜æ˜¯çº¿æ€§æ¢æµ‹</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>staleSlot<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–å½“å‰èŠ‚ç‚¹çš„ key</span>
        <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯ã€æ›¿æ¢é€»è¾‘ã€‘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token comment">// å› ä¸ºæœ¬æ¥è¦åœ¨ staleSlot ç´¢å¼•å¤„æ’å…¥è¯¥æ•°æ®ï¼Œç°åœ¨æ‰¾åˆ°äº†iç´¢å¼•å¤„çš„keyä¸æ•°æ®ä¸€è‡´</span>
            <span class="token comment">// ä½†æ˜¯ i ä½ç½®è·ç¦»æ­£ç¡®çš„ä½ç½®æ›´è¿œï¼Œå› ä¸ºæ˜¯å‘åæŸ¥æ‰¾ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦åœ¨ staleSlot ä½ç½®æ’å…¥å½“å‰ entry</span>
            <span class="token comment">// ç„¶åå°† table[staleSlot] è¿™ä¸ªè¿‡æœŸæ•°æ®æ”¾åˆ°å½“å‰å¾ªç¯åˆ°çš„ table[i] è¿™ä¸ªä½ç½®ï¼Œ</span>
            tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span><span class="token punctuation">;</span>
            tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
			
            <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å‘å‰æŸ¥æ‰¾è¿‡æœŸæ•°æ®å¹¶æœªæ‰¾åˆ°è¿‡æœŸçš„ entryï¼Œä½† staleSlot ä½ç½®å·²ç»ä¸æ˜¯è¿‡æœŸæ•°æ®äº†ï¼Œi ä½ç½®æ‰æ˜¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slotToExpunge <span class="token operator">==</span> staleSlot<span class="token punctuation">)</span>
                slotToExpunge <span class="token operator">=</span> i<span class="token punctuation">;</span>
            
            <span class="token comment">// ã€æ¸…ç†è¿‡æœŸæ•°æ®ï¼ŒexpungeStaleEntry æ¢æµ‹å¼æ¸…ç†ï¼ŒcleanSomeSlots å¯å‘å¼æ¸…ç†ã€‘</span>
            <span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span><span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>slotToExpunge<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰éå†çš„ entry æ˜¯ä¸€ä¸ªè¿‡æœŸæ•°æ®ï¼Œå¹¶ä¸”è¯¥ä½ç½®å‰é¢ä¹Ÿæ²¡æœ‰è¿‡æœŸæ•°æ®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> slotToExpunge <span class="token operator">==</span> staleSlot<span class="token punctuation">)</span>
            <span class="token comment">// æ¢æµ‹å¼æ¸…ç†è¿‡æœŸæ•°æ®çš„å¼€å§‹ä¸‹æ ‡ä¿®æ”¹ä¸ºå½“å‰å¾ªç¯çš„ indexï¼Œå› ä¸º staleSlot ä¼šæ”¾å…¥è¦æ·»åŠ çš„æ•°æ®</span>
            slotToExpunge <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// å‘åæŸ¥æ‰¾è¿‡ç¨‹ä¸­å¹¶æœªå‘ç° k == key çš„ entryï¼Œè¯´æ˜å½“å‰æ˜¯ä¸€ä¸ªã€å–ä»£è¿‡æœŸæ•°æ®é€»è¾‘ã€‘</span>
    <span class="token comment">// åˆ é™¤åŸæœ‰çš„æ•°æ®å¼•ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²</span>
    tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// staleSlot ä½ç½®æ·»åŠ æ•°æ®ï¼Œã€ä¸Šé¢çš„æ‰€æœ‰é€»è¾‘éƒ½ä¸ä¼šæ›´æ”¹ staleSlot çš„å€¼ã€‘</span>
    tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜é™¤äº† staleSlot ä»¥å¤–ï¼Œè¿˜å‘ç°å…¶å®ƒçš„è¿‡æœŸ slotï¼Œæ‰€ä»¥è¦ã€å¼€å¯æ¸…ç†æ•°æ®çš„é€»è¾‘ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>slotToExpunge <span class="token operator">!=</span> staleSlot<span class="token punctuation">)</span>
        <span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span><span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>slotToExpunge<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-replaceStaleEntryæµç¨‹.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">prevIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å½¢æˆä¸€ä¸ªç¯ç»•å¼çš„è®¿é—®ï¼Œå¤´ç´¢å¼•è¶Šç•Œåç½®ä¸ºå°¾ç´¢å¼•</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> i <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>getEntry()ï¼šThreadLocal çš„ get æ–¹æ³•ä»¥å½“å‰çš„ ThreadLocal ä¸º keyï¼Œè°ƒç”¨ getEntry è·å–å¯¹åº”çš„å­˜å‚¨å®ä½“ e</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Entry</span> <span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å“ˆå¸Œå¯»å€</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>table<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¿é—®æ•£åˆ—è¡¨ä¸­æŒ‡å®šæŒ‡å®šä½ç½®çš„ slot </span>
    <span class="token class-name">Entry</span> e <span class="token operator">=</span> table<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜ slot æœ‰å€¼å¹¶ä¸” key å°±æ˜¯è¦å¯»æ‰¾çš„ keyï¼Œç›´æ¥è¿”å›</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span>
        <span class="token keyword">return</span> e<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token comment">// è¿›è¡Œçº¿æ€§æ¢æµ‹</span>
        <span class="token keyword">return</span> <span class="token function">getEntryAfterMiss</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// çº¿æ€§æ¢æµ‹å¯»å€</span>
<span class="token keyword">private</span> <span class="token class-name">Entry</span> <span class="token function">getEntryAfterMiss</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">Entry</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–æ•£åˆ—è¡¨</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token comment">// å¼€å§‹éå†ï¼Œç¢°åˆ° slot == null çš„æƒ…å†µï¼Œæœç´¢ç»“æŸ</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// è·å–å½“å‰ slot ä¸­ entry å¯¹è±¡çš„ key</span>
        <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ‰¾åˆ°äº†ï¼Œç›´æ¥è¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span>
            <span class="token keyword">return</span> e<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
             <span class="token comment">// è¿‡æœŸæ•°æ®ï¼Œã€æ¢æµ‹å¼è¿‡æœŸæ•°æ®å›æ”¶ã€‘</span>
            <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token comment">// æ›´æ–° index ç»§ç»­å‘åèµ°</span>
            i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–ä¸‹ä¸€ä¸ªæ§½ä½ä¸­çš„ entry</span>
        e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¯´æ˜å½“å‰åŒºæ®µæ²¡æœ‰æ‰¾åˆ°ç›¸åº”æ•°æ®</span>
    <span class="token comment">// ã€å› ä¸ºå­˜æ”¾æ•°æ®æ˜¯çº¿æ€§çš„å‘åå¯»æ‰¾æ§½ä½ï¼Œéƒ½æ˜¯ç´§æŒ¨ç€çš„ï¼Œä¸å¯èƒ½è¶Šè¿‡ä¸€ä¸ª ç©ºæ§½ä½ åœ¨åé¢æ”¾ã€‘ï¼Œå¯ä»¥å‡å°‘éå†çš„æ¬¡æ•°</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>rehash()ï¼šè§¦å‘ä¸€æ¬¡å…¨é‡æ¸…ç†ï¼Œå¦‚æœæ•°ç»„é•¿åº¦å¤§äºç­‰äºé•¿åº¦çš„ <code>2/3 * 3/4 = 1/2</code>ï¼Œåˆ™è¿›è¡Œ resize</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ¸…æ¥šå½“å‰æ•£åˆ—è¡¨å†…çš„ã€æ‰€æœ‰ã€‘è¿‡æœŸçš„æ•°æ®</span>
    <span class="token function">expungeStaleEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// threshold = len * 2 / 3ï¼Œå°±æ˜¯ 2/3 * (1 - 1/4)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;=</span> threshold <span class="token operator">-</span> threshold <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">expungeStaleEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// ã€éå†æ‰€æœ‰çš„æ§½ä½ï¼Œæ¸…ç†è¿‡æœŸæ•°æ®ã€‘</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Entry <strong>æ•°ç»„ä¸ºæ‰©å®¹ä¸ºåŸæ¥çš„ 2 å€</strong> ï¼Œé‡æ–°è®¡ç®— key çš„æ•£åˆ—å€¼ï¼Œå¦‚æœé‡åˆ° key ä¸º null çš„æƒ…å†µï¼Œä¼šå°†å…¶ value ä¹Ÿç½®ä¸º nullï¼Œå¸®åŠ© GC</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldTab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> oldLen <span class="token operator">=</span> oldTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// æ–°æ•°ç»„çš„é•¿åº¦æ˜¯è€æ•°ç»„çš„äºŒå€</span>
    <span class="token keyword">int</span> newLen <span class="token operator">=</span> oldLen <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newTab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>newLen<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// ç»Ÿè®¡æ–°tableä¸­çš„entryæ•°é‡</span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">// éå†è€è¡¨ï¼Œè¿›è¡Œã€æ•°æ®è¿ç§»ã€‘</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è®¿é—®è€è¡¨çš„æŒ‡å®šä½ç½®çš„ entry</span>
        <span class="token class-name">Entry</span> e <span class="token operator">=</span> oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜è€è¡¨ä¸­è¯¥ä½ç½®æœ‰æ•°æ®ï¼Œå¯èƒ½æ˜¯è¿‡æœŸæ•°æ®ä¹Ÿå¯èƒ½ä¸æ˜¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è¿‡æœŸæ•°æ®</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Help the GC</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// éè¿‡æœŸæ•°æ®ï¼Œåœ¨æ–°è¡¨ä¸­è¿›è¡Œå“ˆå¸Œå¯»å€</span>
                <span class="token keyword">int</span> h <span class="token operator">=</span> k<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>newLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ã€çº¿ç¨‹æ¢æµ‹ã€‘</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>newTab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    h <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> newLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å°†æ•°æ®å­˜æ”¾åˆ°æ–°è¡¨åˆé€‚çš„ slot ä¸­</span>
                newTab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// è®¾ç½®ä¸‹ä¸€æ¬¡è§¦å‘æ‰©å®¹çš„æŒ‡æ ‡ï¼šthreshold = len * 2 / 3;</span>
    <span class="token function">setThreshold</span><span class="token punctuation">(</span>newLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size <span class="token operator">=</span> count<span class="token punctuation">;</span>
    <span class="token comment">// å°†æ‰©å®¹åçš„æ–°è¡¨èµ‹å€¼ç»™ threadLocalMap å†…éƒ¨æ•£åˆ—è¡¨æ•°ç»„å¼•ç”¨</span>
    table <span class="token operator">=</span> newTab<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>remove()ï¼šåˆ é™¤ Entry</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">// å“ˆå¸Œå¯»å€</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‰¾åˆ°äº†å¯¹åº”çš„ key</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è®¾ç½® key ä¸º null</span>
            e<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ¢æµ‹å¼æ¸…ç†</span>
            <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ¸…ç†æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†æ–¹æ³•"><span>æ¸…ç†æ–¹æ³•</span></a></h4><ul><li>æ¢æµ‹å¼æ¸…ç†ï¼šæ²¿ç€å¼€å§‹ä½ç½®å‘åæ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œæ²¿é€”ä¸­ç¢°åˆ°æœªè¿‡æœŸæ•°æ®åˆ™å°†æ­¤æ•°æ® rehash åœ¨ table æ•°ç»„ä¸­çš„å®šä½ï¼Œé‡å®šä½åçš„å…ƒç´ ç†è®ºä¸Šæ›´æ¥è¿‘ <code>i = entry.key &amp; (table.length - 1)</code>ï¼Œè®©<strong>æ•°æ®çš„æ’åˆ—æ›´ç´§å‡‘</strong>ï¼Œä¼šä¼˜åŒ–æ•´ä¸ªæ•£åˆ—è¡¨æŸ¥è¯¢æ€§èƒ½</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// table[staleSlot] æ˜¯ä¸€ä¸ªè¿‡æœŸæ•°æ®ï¼Œä»¥è¿™ä¸ªä½ç½®å¼€å§‹ç»§ç»­å‘åæŸ¥æ‰¾è¿‡æœŸæ•°æ®</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span><span class="token keyword">int</span> staleSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–æ•£åˆ—è¡¨å’Œæ•°ç»„é•¿åº¦</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token comment">// help gcï¼Œå…ˆæŠŠå½“å‰è¿‡æœŸçš„ entry ç½®ç©ºï¼Œåœ¨å–æ¶ˆå¯¹ entry çš„å¼•ç”¨</span>
    tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// æ•°é‡-1</span>
    size<span class="token operator">--</span><span class="token punctuation">;</span>

    <span class="token class-name">Entry</span> e<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token comment">// ä» staleSlot å¼€å§‹å‘åéå†ï¼Œç›´åˆ°ç¢°åˆ° slot == null ç»“æŸï¼Œã€åŒºé—´å†…æ¸…ç†è¿‡æœŸæ•°æ®ã€‘</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>staleSlot<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token operator">?</span>\<span class="token operator">&gt;</span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å½“å‰ entry æ˜¯è¿‡æœŸæ•°æ®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// help gc</span>
            e<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            size<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// å½“å‰ entry ä¸æ˜¯è¿‡æœŸæ•°æ®çš„é€»è¾‘ï¼Œã€rehashã€‘</span>
            <span class="token comment">// é‡æ–°è®¡ç®—å½“å‰ entry å¯¹åº”çš„ index</span>
            <span class="token keyword">int</span> h <span class="token operator">=</span> k<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ entry å­˜å‚¨æ—¶å‘ç”Ÿè¿‡ hash å†²çªï¼Œå‘ååç§»è¿‡äº†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å½“å‰ä½ç½®ç½®ç©º</span>
                tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">// ä»¥æ­£ç¡®ä½ç½® h å¼€å§‹ï¼Œå‘åæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯ä»¥å­˜æ”¾ entry çš„ä½ç½®</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>tab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    h <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å°†å½“å‰å…ƒç´ æ”¾å…¥åˆ°ã€è·ç¦»æ­£ç¡®ä½ç½®æ›´è¿‘çš„ä½ç½®ï¼Œæœ‰å¯èƒ½å°±æ˜¯æ­£ç¡®ä½ç½®ã€‘</span>
                tab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿”å› slot = null çš„æ§½ä½ç´¢å¼•ï¼Œå›¾ä¾‹æ˜¯ 7ï¼Œè¿™ä¸ªç´¢å¼•ä»£è¡¨ã€ç´¢å¼•å‰é¢çš„åŒºé—´å·²ç»æ¸…ç†å®Œæˆåƒåœ¾äº†ã€‘</span>
    <span class="token keyword">return</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocalæ¢æµ‹å¼æ¸…ç†1.png" alt="" loading="lazy"><img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocalæ¢æµ‹å¼æ¸…ç†2.png" alt="" loading="lazy"></p><ul><li>å¯å‘å¼æ¸…ç†ï¼šå‘åå¾ªç¯æ‰«æè¿‡æœŸæ•°æ®ï¼Œå‘ç°è¿‡æœŸæ•°æ®è°ƒç”¨æ¢æµ‹å¼æ¸…ç†æ–¹æ³•ï¼Œå¦‚æœè¿ç»­å‡ æ¬¡çš„å¾ªç¯éƒ½æ²¡æœ‰å‘ç°è¿‡æœŸæ•°æ®ï¼Œå°±åœæ­¢æ‰«æ</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">//  i è¡¨ç¤ºå¯å‘å¼æ¸…ç†å·¥ä½œå¼€å§‹ä½ç½®ï¼Œä¸€èˆ¬æ˜¯ç©º slotï¼Œn ä¸€èˆ¬ä¼ é€’çš„æ˜¯ table.length </span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¡¨ç¤ºå¯å‘å¼æ¸…ç†å·¥ä½œæ˜¯å¦æ¸…é™¤äº†è¿‡æœŸæ•°æ®</span>
    <span class="token keyword">boolean</span> removed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–å½“å‰ map çš„æ•£åˆ—è¡¨å¼•ç”¨</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–ä¸‹ä¸€ä¸ªç´¢å¼•ï¼Œå› ä¸ºæ¢æµ‹å¼è¿”å›çš„ slot ä¸º null</span>
        i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Entry</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯è¿‡æœŸçš„æ•°æ®ï¼Œkey è¢« gc äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ã€å‘ç°è¿‡æœŸæ•°æ®é‡ç½® n ä¸ºæ•°ç»„çš„é•¿åº¦ã€‘</span>
            n <span class="token operator">=</span> len<span class="token punctuation">;</span>
            <span class="token comment">// è¡¨ç¤ºæ¸…ç†è¿‡è¿‡æœŸæ•°æ®</span>
            removed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">// ä»¥å½“å‰è¿‡æœŸçš„ slot ä¸ºå¼€å§‹èŠ‚ç‚¹ åšä¸€æ¬¡æ¢æµ‹å¼æ¸…ç†å·¥ä½œ</span>
            i <span class="token operator">=</span> <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å‡è®¾ table é•¿åº¦ä¸º 16</span>
        <span class="token comment">// 16 &gt;&gt;&gt; 1 ==&gt; 8ï¼Œ8 &gt;&gt;&gt; 1 ==&gt; 4ï¼Œ4 &gt;&gt;&gt; 1 ==&gt; 2ï¼Œ2 &gt;&gt;&gt; 1 ==&gt; 1ï¼Œ1 &gt;&gt;&gt; 1 ==&gt; 0</span>
        <span class="token comment">// è¿ç»­ç»è¿‡è¿™ä¹ˆå¤šæ¬¡å¾ªç¯ã€æ²¡æœ‰æ‰«æåˆ°è¿‡æœŸæ•°æ®ã€‘ï¼Œå°±åœæ­¢å¾ªç¯ï¼Œæ‰«æåˆ°ç©º slot ä¸ç®—ï¼Œå› ä¸ºä¸æ˜¯è¿‡æœŸæ•°æ®</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">&gt;&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// è¿”å›æ¸…é™¤æ ‡è®°</span>
    <span class="token keyword">return</span> removed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚è€ƒè§†é¢‘ï¼šhttps://space.bilibili.com/457326371/</p><h3 id="å†…å­˜æ³„æ¼" tabindex="-1"><a class="header-anchor" href="#å†…å­˜æ³„æ¼"><span>å†…å­˜æ³„æ¼</span></a></h3><p>Memory leakï¼šå†…å­˜æ³„æ¼æ˜¯æŒ‡ç¨‹åºä¸­åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› æœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œé€Ÿåº¦å‡æ…¢ç”šè‡³ç³»ç»Ÿå´©æºƒç­‰ä¸¥é‡åæœï¼Œå†…å­˜æ³„æ¼çš„å †ç§¯ç»ˆå°†å¯¼è‡´å†…å­˜æº¢å‡º</p><ul><li><p>å¦‚æœ key ä½¿ç”¨å¼ºå¼•ç”¨ï¼šä½¿ç”¨å®Œ ThreadLocal ï¼ŒthreadLocal Ref è¢«å›æ”¶ï¼Œä½†æ˜¯ threadLocalMap çš„ Entry å¼ºå¼•ç”¨äº† threadLocalï¼Œé€ æˆ threadLocal æ— æ³•è¢«å›æ”¶ï¼Œæ— æ³•å®Œå…¨é¿å…å†…å­˜æ³„æ¼ <img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocalå†…å­˜æ³„æ¼å¼ºå¼•ç”¨.png" alt="" loading="lazy"></p></li><li><p>å¦‚æœ key ä½¿ç”¨å¼±å¼•ç”¨ï¼šä½¿ç”¨å®Œ ThreadLocal ï¼ŒthreadLocal Ref è¢«å›æ”¶ï¼ŒThreadLocalMap åªæŒæœ‰ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œæ‰€ä»¥threadlocal ä¹Ÿå¯ä»¥è¢«å›æ”¶ï¼Œæ­¤æ—¶ Entry ä¸­çš„ key = nullã€‚ä½†æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ª Entry æˆ–è€… CurrentThread ä¾ç„¶è¿è¡Œï¼Œä¾ç„¶å­˜åœ¨å¼ºå¼•ç”¨é“¾ï¼Œvalue ä¸ä¼šè¢«å›æ”¶ï¼Œè€Œè¿™å— value æ°¸è¿œä¸ä¼šè¢«è®¿é—®åˆ°ï¼Œä¹Ÿä¼šå¯¼è‡´ value å†…å­˜æ³„æ¼ <img src="https://raw.githubusercontent.com/du-mozzie/PicGo/master/images/JUC-ThreadLocalå†…å­˜æ³„æ¼å¼±å¼•ç”¨.png" alt="" loading="lazy"></p></li><li><p>ä¸¤ä¸ªä¸»è¦åŸå› ï¼š</p></li><li><p>æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ª Entry</p></li><li><p>CurrentThread ä¾ç„¶è¿è¡Œ</p></li></ul><p>æ ¹æœ¬åŸå› ï¼šThreadLocalMap æ˜¯ Threadçš„ä¸€ä¸ªå±æ€§ï¼Œ<strong>ç”Ÿå‘½å‘¨æœŸè·Ÿ Thread ä¸€æ ·é•¿</strong>ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº” Entry å°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼</p><p>è§£å†³æ–¹æ³•ï¼šä½¿ç”¨å®Œ ThreadLocal ä¸­å­˜å‚¨çš„å†…å®¹åå°†å®ƒ remove æ‰å°±å¯ä»¥</p><p>ThreadLocal å†…éƒ¨è§£å†³æ–¹æ³•ï¼šåœ¨ ThreadLocalMap ä¸­çš„ set/getEntry æ–¹æ³•ä¸­ï¼Œé€šè¿‡çº¿æ€§æ¢æµ‹æ³•å¯¹ key è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœ key ä¸º nullï¼ˆThreadLocal ä¸º nullï¼‰ä¼šå¯¹ Entry è¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ‰€ä»¥<strong>ä½¿ç”¨å¼±å¼•ç”¨æ¯”å¼ºå¼•ç”¨å¤šä¸€å±‚ä¿éšœ</strong>ï¼Œå°±ç®—ä¸è°ƒç”¨ removeï¼Œä¹Ÿæœ‰æœºä¼šè¿›è¡Œ GC</p><h3 id="å˜é‡ä¼ é€’" tabindex="-1"><a class="header-anchor" href="#å˜é‡ä¼ é€’"><span>å˜é‡ä¼ é€’</span></a></h3><h4 id="åŸºæœ¬ä½¿ç”¨-1" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä½¿ç”¨-1"><span>åŸºæœ¬ä½¿ç”¨</span></a></h4><p>çˆ¶å­çº¿ç¨‹ï¼šåˆ›å»ºå­çº¿ç¨‹çš„çº¿ç¨‹æ˜¯çˆ¶çº¿ç¨‹ï¼Œæ¯”å¦‚å®ä¾‹ä¸­çš„ main çº¿ç¨‹å°±æ˜¯çˆ¶çº¿ç¨‹</p><p>ThreadLocal ä¸­å­˜å‚¨çš„æ˜¯çº¿ç¨‹çš„å±€éƒ¨å˜é‡ï¼Œå¦‚æœæƒ³<strong>å®ç°çº¿ç¨‹é—´å±€éƒ¨å˜é‡ä¼ é€’</strong>å¯ä»¥ä½¿ç”¨ InheritableThreadLocal ç±»</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token class-name">String</span>\<span class="token operator">&gt;</span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InheritableThreadLocal</span>\<span class="token operator">&lt;</span>\<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;çˆ¶çº¿ç¨‹è®¾ç½®çš„å€¼&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å­çº¿ç¨‹è¾“å‡ºï¼š&quot;</span> <span class="token operator">+</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// å­çº¿ç¨‹è¾“å‡ºï¼šçˆ¶çº¿ç¨‹è®¾ç½®çš„å€¼</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å®ç°åŸç†-1" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†-1"><span>å®ç°åŸç†</span></a></h4><p>InheritableThreadLocal æºç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InheritableThreadLocal</span>\<span class="token operator">&lt;</span><span class="token class-name">T</span>\<span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token class-name">T</span>\<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">childValue</span><span class="token punctuation">(</span><span class="token class-name">T</span> parentValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> parentValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> t<span class="token punctuation">.</span>inheritableThreadLocals<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">createMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">T</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span>inheritableThreadLocals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°çˆ¶å­çº¿ç¨‹é—´çš„å±€éƒ¨å˜é‡å…±äº«éœ€è¦è¿½æº¯åˆ° Thread å¯¹è±¡çš„æ„é€ æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">ThreadGroup</span> g<span class="token punctuation">,</span> <span class="token class-name">Runnable</span> target<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">long</span> stackSize<span class="token punctuation">,</span> <span class="token class-name">AccessControlContext</span> acc<span class="token punctuation">,</span>
                  <span class="token comment">// è¯¥å‚æ•°é»˜è®¤æ˜¯ true</span>
                  <span class="token keyword">boolean</span> inheritThreadLocals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// ...</span>
    <span class="token class-name">Thread</span> parent <span class="token operator">=</span> <span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// åˆ¤æ–­çˆ¶çº¿ç¨‹ï¼ˆåˆ›å»ºå­çº¿ç¨‹çš„çº¿ç¨‹ï¼‰çš„ inheritableThreadLocals å±æ€§ä¸ä¸º null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inheritThreadLocals <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>inheritableThreadLocals <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¤åˆ¶çˆ¶çº¿ç¨‹çš„ inheritableThreadLocals å±æ€§ï¼Œå®ç°çˆ¶å­çº¿ç¨‹å±€éƒ¨å˜é‡å…±äº«</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>inheritableThreadLocals <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">createInheritedMap</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>inheritableThreadLocals<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token comment">// ..</span>
<span class="token punctuation">}</span>
<span class="token comment">// ã€æœ¬è´¨ä¸Šè¿˜æ˜¯åˆ›å»º ThreadLocalMapï¼Œåªæ˜¯æŠŠçˆ¶ç±»ä¸­çš„å¯ç»§æ‰¿æ•°æ®è®¾ç½®è¿›å»äº†ã€‘</span>
<span class="token keyword">static</span> <span class="token class-name">ThreadLocalMap</span> <span class="token function">createInheritedMap</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalMap</span> parentMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span>parentMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalMap</span> parentMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–çˆ¶çº¿ç¨‹çš„å“ˆå¸Œè¡¨</span>
    <span class="token class-name">Entry</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parentTable <span class="token operator">=</span> parentMap<span class="token punctuation">.</span>table<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> parentTable<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token function">setThreshold</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// ã€é€ä¸ªå¤åˆ¶çˆ¶çº¿ç¨‹ ThreadLocalMap ä¸­çš„æ•°æ®ã€‘</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Entry</span> e <span class="token operator">=</span> parentTable<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token class-name">Object</span>\<span class="token operator">&gt;</span> key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span>\<span class="token operator">&lt;</span><span class="token class-name">Object</span>\<span class="token operator">&gt;</span><span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è°ƒç”¨çš„æ˜¯ InheritableThreadLocal#childValue(T parentValue)</span>
                <span class="token class-name">Object</span> value <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">childValue</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Entry</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> h <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// çº¿æ€§æ¢æµ‹</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>table<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    h <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                table<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> c<span class="token punctuation">;</span>
                size<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/feichitianxia/article/details/110495764</p></div><!--[--><!----><!--]--><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: du.mozzie@outlook.com">mozzie</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/code/java/juc/memory.html" aria-label="å†…å­˜"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->å†…å­˜</div></a><a class="route-link nav-link next" href="/code/java/juc/thread-pool.html" aria-label="çº¿ç¨‹æ± "><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">çº¿ç¨‹æ± <!----></div></a></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><!----><div class="vp-copyright">Copyright Â© 2026 mozzie </div></footer></div><!--]--><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DyhgqEf-.js" defer></script>
  </body>
</html>
